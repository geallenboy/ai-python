{
  "url": "https://n8n.io/workflows/4216-customer-authentication-for-chat-support-with-openai-and-redis-session-management/",
  "title": "Customer Authentication for Chat Support with OpenAI and Redis Session Management",
  "author": "Jimleuk",
  "publish_date": "Last update 6 days ago",
  "publish_date_absolute": "2025-05-20",
  "categories": [
    {
      "name": "Support"
    },
    {
      "name": "AI"
    }
  ],
  "workflow_json": "{\"meta\":{\"instanceId\":\"408f9fb9940c3cb18ffdef0e0150fe342d6e655c3a9fac21f0f644e8bedabcd9\",\"templateCredsSetupCompleted\":true},\"nodes\":[{\"id\":\"0c0090f9-c3a6-421d-8c67-92baeded6007\",\"name\":\"When chat message received\",\"type\":\"@n8n/n8n-nodes-langchain.chatTrigger\",\"position\":[-580,-160],\"webhookId\":\"0fa189dc-16dc-470f-b69d-3e2809d8c071\",\"parameters\":{\"options\":{}},\"typeVersion\":1.1},{\"id\":\"adf71970-7f0c-4394-bdab-b701eaa7173f\",\"name\":\"LLM\",\"type\":\"@n8n/n8n-nodes-langchain.lmChatOpenAi\",\"position\":[-240,40],\"parameters\":{\"model\":{\"__rl\":true,\"mode\":\"list\",\"value\":\"gpt-4.1-mini\",\"cachedResultName\":\"gpt-4.1-mini\"},\"options\":{}},\"credentials\":{\"openAiApi\":{\"id\":\"8gccIjcuf3gvaoEr\",\"name\":\"OpenAi account\"}},\"typeVersion\":1.2},{\"id\":\"56318a6e-3a05-4f6b-9eb5-15ad6144144e\",\"name\":\"Memory\",\"type\":\"@n8n/n8n-nodes-langchain.memoryBufferWindow\",\"position\":[-120,40],\"parameters\":{\"sessionKey\":\"=chat_{{ $('When chat message received').first().json.sessionId }}\",\"sessionIdType\":\"customKey\"},\"typeVersion\":1.3},{\"id\":\"6bde1175-7175-4ccd-ac0b-65ecc8c2d7b3\",\"name\":\"Get Session\",\"type\":\"n8n-nodes-base.redis\",\"position\":[-400,-160],\"parameters\":{\"key\":\"=chat_{{ $json.sessionId }}\",\"keyType\":\"string\",\"options\":{},\"operation\":\"get\",\"propertyName\":\"data\"},\"credentials\":{\"redis\":{\"id\":\"zU4DA70qSDrZM1El\",\"name\":\"Redis account (localhost)\"}},\"typeVersion\":1},{\"id\":\"81f53ae3-22b6-48cd-83b9-3c6c1041818c\",\"name\":\"When Executed by Another Workflow\",\"type\":\"n8n-nodes-base.executeWorkflowTrigger\",\"position\":[340,-120],\"parameters\":{\"workflowInputs\":{\"values\":[{\"name\":\"eventType\"},{\"name\":\"data\",\"type\":\"object\"}]}},\"typeVersion\":1.1},{\"id\":\"ade09ef9-b2bc-4cf0-84b5-7121623b4f7b\",\"name\":\"Switch\",\"type\":\"n8n-nodes-base.switch\",\"position\":[540,-120],\"parameters\":{\"rules\":{\"values\":[{\"outputKey\":\"Get Auth Url\",\"conditions\":{\"options\":{\"version\":2,\"leftValue\":\"\",\"caseSensitive\":true,\"typeValidation\":\"strict\"},\"combinator\":\"and\",\"conditions\":[{\"id\":\"55d3d729-baf4-47ad-8262-5d23fc2d3348\",\"operator\":{\"type\":\"string\",\"operation\":\"equals\"},\"leftValue\":\"={{ $json.eventType }}\",\"rightValue\":\"get_auth_url\"}]},\"renameOutput\":true}]},\"options\":{}},\"typeVersion\":3.2},{\"id\":\"7ee9de6a-bb37-4adc-87a2-ddb745d17ab7\",\"name\":\"Get Auth Url Response\",\"type\":\"n8n-nodes-base.set\",\"position\":[740,-120],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"cf2b4fb3-cda0-47f9-b9fa-fda3532a04f5\",\"name\":\"auth_url\",\"type\":\"string\",\"value\":\"=https://<your-n8n-url>/form/auth?sessionId={{ $json.data.sessionId }}\"}]}},\"typeVersion\":3.4},{\"id\":\"880f7506-0947-47f1-ba0d-d08d6d18133b\",\"name\":\"Get Auth URL\",\"type\":\"@n8n/n8n-nodes-langchain.toolWorkflow\",\"position\":[40,40],\"parameters\":{\"workflowId\":{\"__rl\":true,\"mode\":\"id\",\"value\":\"={{ $workflow.id }}\"},\"description\":\"Call this tool to generate a login URL which allows guest users to authenticate as customers.\",\"workflowInputs\":{\"value\":{\"data\":\"={{\\n{\\n  \\\"sessionId\\\": $('When chat message received').first().json.sessionId\\n}\\n}}\",\"eventType\":\"get_auth_url\"},\"schema\":[{\"id\":\"eventType\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"eventType\",\"defaultMatch\":false,\"canBeUsedToMatch\":true},{\"id\":\"data\",\"type\":\"object\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"data\",\"defaultMatch\":false,\"canBeUsedToMatch\":true}],\"mappingMode\":\"defineBelow\",\"matchingColumns\":[],\"attemptToConvertTypes\":false,\"convertFieldsToString\":false}},\"typeVersion\":2.2},{\"id\":\"800be1b0-5bec-4eaf-ac13-e6808b955408\",\"name\":\"Update Session\",\"type\":\"n8n-nodes-base.redis\",\"position\":[1620,-120],\"parameters\":{\"key\":\"=chat_{{ $('Login Form').first().json.formQueryParameters.sessionId }}\",\"ttl\":3600,\"value\":\"={{ $json.toJsonString() }}\",\"expire\":true,\"keyType\":\"string\",\"operation\":\"set\"},\"credentials\":{\"redis\":{\"id\":\"zU4DA70qSDrZM1El\",\"name\":\"Redis account (localhost)\"}},\"typeVersion\":1},{\"id\":\"8b3d4728-2ae2-40dd-98ee-9efb915d06fc\",\"name\":\"Confirm Login Success\",\"type\":\"n8n-nodes-base.form\",\"position\":[1800,-120],\"webhookId\":\"d939dc43-e333-4cb6-8bde-d6d8868ec9d3\",\"parameters\":{\"options\":{},\"operation\":\"completion\",\"completionTitle\":\"Login Successful!\",\"completionMessage\":\"=Welcome back {{ $json.name }},\\nYour chat session is now authenticated.\\n\\nYou may now close this window and chat as a customer.\"},\"typeVersion\":1},{\"id\":\"5cb5797a-7f6c-4855-bcaa-4475ef16ec8d\",\"name\":\"Customer Support Agent\",\"type\":\"@n8n/n8n-nodes-langchain.agent\",\"position\":[-200,-160],\"parameters\":{\"text\":\"={{ $('When chat message received').item.json.chatInput }}\",\"options\":{\"systemMessage\":\"=You are a customer support assistant interacting with both anonymous guests and existing customers.\\n* Guest users can ask basic questions about publicly available information.\\n* Existing Customers can access their accounts, basket and profile.\\n* Guests who ask about their accounts, basket or profile must authenticate as a customer before they can access this information. Provide a login url for the user and ask them to return once authenticated. Remind the user not to close the chat window as this will end the session!\\n\\n### About the login URL \\nThe login url will take the user to an external form which when authenticated, will link their chat session with their customer profile. The user should close the form once done and return to the chat window. Upon their next message, their customer profile will be included in the context.\\n* If you haven't already, thank the user for authenticating and welcome them back!\\n* If the user claims to have authenticated but is still identified as a guest, then it may be that the login attempt was not successful and the user should be advised politely to try again.\\n\\n---\\nThe current user is {{ $json.data ? 'a customer' : 'a guest' }}.\\n{{ $json.data ?? '' }}\",\"passthroughBinaryImages\":true},\"promptType\":\"define\"},\"typeVersion\":1.9},{\"id\":\"1b1f96f6-6f70-4b86-9831-0ac31a65dbdc\",\"name\":\"Sticky Note\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[-640,-380],\"parameters\":{\"color\":7,\"width\":840,\"height\":560,\"content\":\"## 1. Create a Conversational Agent with Session Access\\n[Learn more about AI Agents](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.agent)\\n\\nOur support agent handles both guests and customers, with the latter identified by available session data coming in from Redis. For guests who wish to authenticate as customers, the agent is instructed to generate a login URL to share with the user - this is accomplished using a tool.\"},\"typeVersion\":1},{\"id\":\"b41e156c-a70f-422a-a37a-432e5657a999\",\"name\":\"Sticky Note1\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[240,-380],\"parameters\":{\"color\":7,\"width\":720,\"height\":560,\"content\":\"## 2. Generate a Login URL via Tool\\n[Learn more about Subworkflow Triggers](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.executeworkflowtrigger)\\n\\nThe login URL is a simple redirect to an form which handles the authentication. For obvious reasons, we've deliberately avoided doing this through the chat as it could have exposed sensitive credentials. The login URL appends the SessionID as a query parameter because this is currently the only way to pre-fill fields in a n8n form.\"},\"typeVersion\":1},{\"id\":\"bd10ad35-7c72-480f-86fd-e15ee4011688\",\"name\":\"Sticky Note2\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1000,-380],\"parameters\":{\"color\":7,\"width\":1020,\"height\":560,\"content\":\"## 3. A Login Form to Link Session to Customer Profile\\n[Learn more about the Form Trigger](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.formtrigger)\\n\\nThis login form is pretty standard and takes 3 fields: username, password and sessionId. the idea being that once authenticated successfully, the user's customer profile can be used to associate with the sessionID. Note that I haven't implemented the actual authentication logic - you'll need to do this yourself!\"},\"typeVersion\":1},{\"id\":\"f13700b3-69cb-4809-b982-9204c2766948\",\"name\":\"Get Customer Profile\",\"type\":\"n8n-nodes-base.set\",\"position\":[1440,-120],\"parameters\":{\"mode\":\"raw\",\"options\":{},\"jsonOutput\":\"{\\n  \\\"id\\\": 1,\\n  \\\"name\\\": \\\"Jim Le\\\",\\n  \\\"email\\\": \\\"jim@example.com\\\",\\n  \\\"basket\\\": [\\n    \\\"SanDisk Extreme Portable SSD 1TB (up to 1050 MB/s read, 1,000MB/s write, NVMe SSD, USB-C, External Solid State Drive, IP65 rated for dust and water resistance, Updated Firmware) Black - £84.99\\\",\\n    \\\"eufy X10 Pro Omni Robot Vacuum Cleaner with Mop, All-in-One Station, 8,000Pa Powerful Suction, Dual Mops, AI Obstacle Avoidance, Auto Mop Washing, Auto-Hot-Air-Drying, Auto-Emptying, Auto-Refilling £799.00\\\"\\n  ] \\n}\"},\"typeVersion\":3.4},{\"id\":\"66c28c7e-7ff1-4aac-8fbf-35e8c8105a65\",\"name\":\"Replace Me!\",\"type\":\"n8n-nodes-base.noOp\",\"position\":[1260,-120],\"parameters\":{},\"typeVersion\":1},{\"id\":\"e58f3c0f-c441-4c89-9a19-2c3459733dee\",\"name\":\"Login Form\",\"type\":\"n8n-nodes-base.formTrigger\",\"position\":[1080,-120],\"webhookId\":\"cac0738d-f211-41de-bc6e-6f36103d9c1a\",\"parameters\":{\"options\":{\"path\":\"auth\",\"ignoreBots\":true,\"buttonLabel\":\"Submit\"},\"formTitle\":\"Authenticate Chat Session\",\"formFields\":{\"values\":[{\"fieldLabel\":\"Username\",\"requiredField\":true},{\"fieldLabel\":\"Password\",\"requiredField\":true},{\"fieldName\":\"sessionId\",\"fieldType\":\"hiddenField\"}]},\"responseMode\":\"lastNode\",\"formDescription\":\"Please login to validate your current chat session.\"},\"typeVersion\":2.2},{\"id\":\"2f965c47-76e3-4100-8c48-2be4dccece49\",\"name\":\"Sticky Note3\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1220,60],\"parameters\":{\"color\":5,\"width\":200,\"height\":140,\"content\":\"### Replace with Authentication Logic!\\nThis could be a query to a PostgreSQL database or otherwise.\"},\"typeVersion\":1},{\"id\":\"1d5077eb-4a6b-4bcb-9a85-e525a6c013ab\",\"name\":\"Sticky Note4\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[-1160,-820],\"parameters\":{\"width\":460,\"height\":1160,\"content\":\"## Try It Out!\\n### This n8n template demonstrates one approach to customer authentication via chat agents.\\n\\nUnlike approaches where you have to authenticate users prior to interacting with the agent, this approach allows guest users to authenticate at any time during the session or not at all.\\n\\n### How it works\\n* A conversational agent is used for this demonstration. The key component is the Redis node just after the chat trigger which acts as the session context.\\n* For guests, the session item is blank. for customers, the session item is populated with their customer profile.\\n* The agent is instructed to generate a unique login URL only for guests when appropriate or upon request.\\n* This login URL redirects the guest user to a simple n8n form also hosted in this template. The login URL has the current sessionID as a query parameter as the way to pass this data to the form.\\n* Once login is successful, the matching session item by sessionId is populated with the customer profile. The user can now return to the chat window.\\n* Back to the agent, now when the user sends their next message, the Redis node will pick up the session item and the customer profile associated with it. The system prompt is updated with this data which let's the agent know the user is now a customer.\\n\\n### How to use\\n* You'll need to update the \\\"auth URL\\\" tool to match the URL of your n8n instance. Better yet, copy the production URL of your form from the trigger.\\n* Activate the workflow to turn on production mode which is required for this workflow.\\n* Implement the authentication logic in step 3. This could be sending the user and pass to a postgreSQL data for validation.\\n\\n### Requirements\\n* OpenAI for LLM (feel free to swap to any provider)\\n* Redis for Cache/Sessions (again, feel free to swap this out for postgresql or other database)\\n\\n### Customising this workflow\\n* Consider not populating the session item with the user data as it can become stale. Instead, just add the userId and instruct the agent to query using tools.\\n\\n### Need Help?\\nJoin the [Discord](https://discord.com/invite/XPKeKXeB7d) or ask in the [Forum](https://community.n8n.io/)!\\n\\nHappy Hacking!\"},\"typeVersion\":1}],\"pinData\":{},\"connections\":{\"LLM\":{\"ai_languageModel\":[[{\"node\":\"Customer Support Agent\",\"type\":\"ai_languageModel\",\"index\":0}]]},\"Memory\":{\"ai_memory\":[[{\"node\":\"Customer Support Agent\",\"type\":\"ai_memory\",\"index\":0}]]},\"Switch\":{\"main\":[[{\"node\":\"Get Auth Url Response\",\"type\":\"main\",\"index\":0}]]},\"Login Form\":{\"main\":[[{\"node\":\"Replace Me!\",\"type\":\"main\",\"index\":0}]]},\"Get Session\":{\"main\":[[{\"node\":\"Customer Support Agent\",\"type\":\"main\",\"index\":0}]]},\"Replace Me!\":{\"main\":[[{\"node\":\"Get Customer Profile\",\"type\":\"main\",\"index\":0}]]},\"Get Auth URL\":{\"ai_tool\":[[{\"node\":\"Customer Support Agent\",\"type\":\"ai_tool\",\"index\":0}]]},\"Update Session\":{\"main\":[[{\"node\":\"Confirm Login Success\",\"type\":\"main\",\"index\":0}]]},\"Get Customer Profile\":{\"main\":[[{\"node\":\"Update Session\",\"type\":\"main\",\"index\":0}]]},\"When chat message received\":{\"main\":[[{\"node\":\"Get Session\",\"type\":\"main\",\"index\":0}]]},\"When Executed by Another Workflow\":{\"main\":[[{\"node\":\"Switch\",\"type\":\"main\",\"index\":0}]]}}}",
  "readme": "### This n8n template demonstrates one approach to customer authentication via chat agents.\n\nUnlike approaches where you have to authenticate users prior to interacting with the agent, this approach allows guest users to authenticate at any time during the session or not at all.\n\n**Note about Security** : this template is for illustration purposes only and requires much more work to be ready for production!\n\n### How it works\n\n  * A conversational agent is used for this demonstration. The key component is the Redis node just after the chat trigger which acts as the session context.\n  * For guests, the session item is blank. for customers, the session item is populated with their customer profile.\n  * The agent is instructed to generate a unique login URL only for guests when appropriate or upon request.\n  * This login URL redirects the guest user to a simple n8n form also hosted in this template. The login URL has the current sessionID as a query parameter as the way to pass this data to the form.\n  * Once login is successful, the matching session item by sessionId is populated with the customer profile. The user can now return to the chat window.\n  * Back to the agent, now when the user sends their next message, the Redis node will pick up the session item and the customer profile associated with it. The system prompt is updated with this data which let's the agent know the user is now a customer.\n\n\n\n### How to use\n\n  * You'll need to update the \"auth URL\" tool to match the URL of your n8n instance. Better yet, copy the production URL of your form from the trigger.\n  * Activate the workflow to turn on production mode which is required for this workflow.\n  * Implement the authentication logic in step 3. This could be sending the user and pass to a postgreSQL data for validation.\n\n\n\n### Requirements\n\n  * OpenAI for LLM (feel free to swap to any provider)\n  * Redis for Cache/Sessions (again, feel free to swap this out for postgresql or other database)\n\n\n\n### Customising this workflow\n\n  * Consider not populating the session item with the user data as it can become stale. Instead, just add the userId and instruct the agent to query using tools.\n  * Extend the Login URL idea by experimenting with signup URLs or single-use Urls.\n\n\n",
  "crawled_at": "2025-05-26T07:19:06.074239",
  "readme_zh": "### 该n8n模板展示了一种通过聊天代理实现客户认证的解决方案\n\n与必须先认证用户才能与代理交互的传统方式不同，此方案允许访客用户在会话过程中随时进行认证，或选择不认证。\n\n**安全须知**：本模板仅作演示用途，需进一步完善才能投入生产环境！\n\n### 工作原理\n\n* 演示采用对话式代理，核心组件是聊天触发器后的Redis节点，它充当会话上下文存储器\n* 访客的会话项为空，认证客户的会话项则存储其用户档案\n* 系统会指示代理在适当时机（或收到请求时）仅为访客生成专属登录链接\n* 该链接将跳转至模板内嵌的简易n8n表单，并通过URL参数传递当前sessionID以保持会话连续性\n* 登录成功后，系统会根据sessionID更新对应会话项中的用户档案数据，用户可返回聊天界面\n* 当用户发送下条消息时，Redis节点将读取带用户档案的会话项，系统提示词随之更新，使代理知晓用户已完成认证\n\n### 使用指南\n\n* 需修改\"auth URL\"工具以匹配您的n8n实例地址（建议直接从触发器复制生产环境表单URL）\n* 启用工作流的生产模式（本流程必需）\n* 在步骤3实现认证逻辑（例如将账号密码提交至PostgreSQL数据库验证）\n\n### 环境要求\n\n* OpenAI大语言模型（可替换为其他供应商）\n* Redis缓存/会话服务（同样支持PostgreSQL等数据库替代方案）\n\n### 定制建议\n\n* 考虑仅存储用户ID而非完整档案，避免数据陈旧化，并通过工具指令让代理实时查询\n* 拓展登录链接功能，尝试集成注册链接或一次性验证链接等变体方案",
  "title_zh": "OpenAI与Redis会话管理的聊天支持客户认证",
  "publish_date_zh": "最后更新于6天前",
  "workflow_json_zh": "{\n  \"meta\": {\n    \"instanceId\": \"408f9fb9940c3cb18ffdef0e0150fe342d6e655c3a9fac21f0f644e8bedabcd9\",\n    \"templateCredsSetupCompleted\": true\n  },\n  \"nodes\": [\n    {\n      \"id\": \"0c0090f9-c3a6-421d-8c67-92baeded6007\",\n      \"name\": \"When chat message received\",\n      \"type\": \"@n8n/n8n-nodes-langchain.chatTrigger\",\n      \"position\": [\n        -580,\n        -160\n      ],\n      \"webhookId\": \"0fa189dc-16dc-470f-b69d-3e2809d8c071\",\n      \"parameters\": {\n        \"options\": {}\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"adf71970-7f0c-4394-bdab-b701eaa7173f\",\n      \"name\": \"LLM\",\n      \"type\": \"@n8n/n8n-nodes-langchain.lmChatOpenAi\",\n      \"position\": [\n        -240,\n        40\n      ],\n      \"parameters\": {\n        \"model\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"gpt-4.1-mini\",\n          \"cachedResultName\": \"gpt-4.1-mini\"\n        },\n        \"options\": {}\n      },\n      \"credentials\": {\n        \"openAiApi\": {\n          \"id\": \"8gccIjcuf3gvaoEr\",\n          \"name\": \"OpenAi account\"\n        }\n      },\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"56318a6e-3a05-4f6b-9eb5-15ad6144144e\",\n      \"name\": \"Memory\",\n      \"type\": \"@n8n/n8n-nodes-langchain.memoryBufferWindow\",\n      \"position\": [\n        -120,\n        40\n      ],\n      \"parameters\": {\n        \"sessionKey\": \"=chat_{{ $('When chat message received').first().json.sessionId }}\",\n        \"sessionIdType\": \"customKey\"\n      },\n      \"typeVersion\": 1.3\n    },\n    {\n      \"id\": \"6bde1175-7175-4ccd-ac0b-65ecc8c2d7b3\",\n      \"name\": \"Get Session\",\n      \"type\": \"n8n-nodes-base.redis\",\n      \"position\": [\n        -400,\n        -160\n      ],\n      \"parameters\": {\n        \"key\": \"=chat_{{ $json.sessionId }}\",\n        \"keyType\": \"string\",\n        \"options\": {},\n        \"operation\": \"get\",\n        \"propertyName\": \"data\"\n      },\n      \"credentials\": {\n        \"redis\": {\n          \"id\": \"zU4DA70qSDrZM1El\",\n          \"name\": \"Redis account (localhost)\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"81f53ae3-22b6-48cd-83b9-3c6c1041818c\",\n      \"name\": \"When Executed by Another Workflow\",\n      \"type\": \"n8n-nodes-base.executeWorkflowTrigger\",\n      \"position\": [\n        340,\n        -120\n      ],\n      \"parameters\": {\n        \"workflowInputs\": {\n          \"values\": [\n            {\n              \"name\": \"eventType\"\n            },\n            {\n              \"name\": \"data\",\n              \"type\": \"object\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"ade09ef9-b2bc-4cf0-84b5-7121623b4f7b\",\n      \"name\": \"Switch\",\n      \"type\": \"n8n-nodes-base.switch\",\n      \"position\": [\n        540,\n        -120\n      ],\n      \"parameters\": {\n        \"rules\": {\n          \"values\": [\n            {\n              \"outputKey\": \"Get Auth Url\",\n              \"conditions\": {\n                \"options\": {\n                  \"version\": 2,\n                  \"leftValue\": \"\",\n                  \"caseSensitive\": true,\n                  \"typeValidation\": \"strict\"\n                },\n                \"combinator\": \"and\",\n                \"conditions\": [\n                  {\n                    \"id\": \"55d3d729-baf4-47ad-8262-5d23fc2d3348\",\n                    \"operator\": {\n                      \"type\": \"string\",\n                      \"operation\": \"equals\"\n                    },\n                    \"leftValue\": \"={{ $json.eventType }}\",\n                    \"rightValue\": \"get_auth_url\"\n                  }\n                ]\n              },\n              \"renameOutput\": true\n            }\n          ]\n        },\n        \"options\": {}\n      },\n      \"typeVersion\": 3.2\n    },\n    {\n      \"id\": \"7ee9de6a-bb37-4adc-87a2-ddb745d17ab7\",\n      \"name\": \"Get Auth Url Response\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        740,\n        -120\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"cf2b4fb3-cda0-47f9-b9fa-fda3532a04f5\",\n              \"name\": \"auth_url\",\n              \"type\": \"string\",\n              \"value\": \"=https://<your-n8n-url>/form/auth?sessionId={{ $json.data.sessionId }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"880f7506-0947-47f1-ba0d-d08d6d18133b\",\n      \"name\": \"Get Auth URL\",\n      \"type\": \"@n8n/n8n-nodes-langchain.toolWorkflow\",\n      \"position\": [\n        40,\n        40\n      ],\n      \"parameters\": {\n        \"workflowId\": {\n          \"__rl\": true,\n          \"mode\": \"id\",\n          \"value\": \"={{ $workflow.id }}\"\n        },\n        \"description\": \"Call this tool to generate a login URL which allows guest users to authenticate as customers.\",\n        \"workflowInputs\": {\n          \"value\": {\n            \"data\": \"={{\\n{\\n  \\\"sessionId\\\": $('When chat message received').first().json.sessionId\\n}\\n}}\",\n            \"eventType\": \"get_auth_url\"\n          },\n          \"schema\": [\n            {\n              \"id\": \"eventType\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"eventType\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"data\",\n              \"type\": \"object\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"data\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            }\n          ],\n          \"mappingMode\": \"defineBelow\",\n          \"matchingColumns\": [],\n          \"attemptToConvertTypes\": false,\n          \"convertFieldsToString\": false\n        }\n      },\n      \"typeVersion\": 2.2\n    },\n    {\n      \"id\": \"800be1b0-5bec-4eaf-ac13-e6808b955408\",\n      \"name\": \"Update Session\",\n      \"type\": \"n8n-nodes-base.redis\",\n      \"position\": [\n        1620,\n        -120\n      ],\n      \"parameters\": {\n        \"key\": \"=chat_{{ $('Login Form').first().json.formQueryParameters.sessionId }}\",\n        \"ttl\": 3600,\n        \"value\": \"={{ $json.toJsonString() }}\",\n        \"expire\": true,\n        \"keyType\": \"string\",\n        \"operation\": \"set\"\n      },\n      \"credentials\": {\n        \"redis\": {\n          \"id\": \"zU4DA70qSDrZM1El\",\n          \"name\": \"Redis account (localhost)\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"8b3d4728-2ae2-40dd-98ee-9efb915d06fc\",\n      \"name\": \"Confirm Login Success\",\n      \"type\": \"n8n-nodes-base.form\",\n      \"position\": [\n        1800,\n        -120\n      ],\n      \"webhookId\": \"d939dc43-e333-4cb6-8bde-d6d8868ec9d3\",\n      \"parameters\": {\n        \"options\": {},\n        \"operation\": \"completion\",\n        \"completionTitle\": \"Login Successful!\",\n        \"completionMessage\": \"=Welcome back {{ $json.name }},\\nYour chat session is now authenticated.\\n\\nYou may now close this window and chat as a customer.\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"5cb5797a-7f6c-4855-bcaa-4475ef16ec8d\",\n      \"name\": \"Customer Support Agent\",\n      \"type\": \"@n8n/n8n-nodes-langchain.agent\",\n      \"position\": [\n        -200,\n        -160\n      ],\n      \"parameters\": {\n        \"text\": \"={{ $('When chat message received').item.json.chatInput }}\",\n        \"options\": {\n          \"systemMessage\": \"=You are a customer support assistant interacting with both anonymous guests and existing customers.\\n* Guest users can ask basic questions about publicly available information.\\n* Existing Customers can access their accounts, basket and profile.\\n* Guests who ask about their accounts, basket or profile must authenticate as a customer before they can access this information. Provide a login url for the user and ask them to return once authenticated. Remind the user not to close the chat window as this will end the session!\\n\\n### About the login URL \\nThe login url will take the user to an external form which when authenticated, will link their chat session with their customer profile. The user should close the form once done and return to the chat window. Upon their next message, their customer profile will be included in the context.\\n* If you haven't already, thank the user for authenticating and welcome them back!\\n* If the user claims to have authenticated but is still identified as a guest, then it may be that the login attempt was not successful and the user should be advised politely to try again.\\n\\n---\\nThe current user is {{ $json.data ? 'a customer' : 'a guest' }}.\\n{{ $json.data ?? '' }}\",\n          \"passthroughBinaryImages\": true\n        },\n        \"promptType\": \"define\"\n      },\n      \"typeVersion\": 1.9\n    },\n    {\n      \"id\": \"1b1f96f6-6f70-4b86-9831-0ac31a65dbdc\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -640,\n        -380\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 840,\n        \"height\": 560,\n        \"content\": \"## 1. 创建具备会话访问能力的对话代理\\n[了解更多AI代理信息](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.agent)\\n\\n我们的客服代理可同时服务访客与认证客户，后者通过Redis提供的会话数据进行识别。当访客希望进行身份验证时，代理会按照指令生成登录链接供用户使用——该功能通过专用工具实现。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b41e156c-a70f-422a-a37a-432e5657a999\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        240,\n        -380\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 720,\n        \"height\": 560,\n        \"content\": \"## 2. 通过工具生成登录URL\\n[了解更多关于子流程触发器的信息](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.executeworkflowtrigger)\\n\\n该登录URL是一个简单的重定向链接，指向处理认证的表单页面。出于安全考虑，我们刻意避免通过聊天界面直接操作，以防敏感凭证泄露。该URL会将SessionID作为查询参数附加，因为这是当前在n8n表单中预填字段的唯一实现方式。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"bd10ad35-7c72-480f-86fd-e15ee4011688\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1000,\n        -380\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 1020,\n        \"height\": 560,\n        \"content\": \"## 3. 关联会话与客户资料的登录表单  \\n[了解更多表单触发器信息](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.formtrigger)  \\n\\n该登录表单采用标准设计，包含三个字段：用户名、密码和会话ID。其核心逻辑在于当用户认证成功后，系统将使用该用户的客户资料与会话ID进行关联。请注意，此处未实现实际的认证逻辑——您需要自行完成这一部分！\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"f13700b3-69cb-4809-b982-9204c2766948\",\n      \"name\": \"Get Customer Profile\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        1440,\n        -120\n      ],\n      \"parameters\": {\n        \"mode\": \"raw\",\n        \"options\": {},\n        \"jsonOutput\": \"{\\n  \\\"id\\\": 1,\\n  \\\"name\\\": \\\"Jim Le\\\",\\n  \\\"email\\\": \\\"jim@example.com\\\",\\n  \\\"basket\\\": [\\n    \\\"SanDisk Extreme Portable SSD 1TB (up to 1050 MB/s read, 1,000MB/s write, NVMe SSD, USB-C, External Solid State Drive, IP65 rated for dust and water resistance, Updated Firmware) Black - £84.99\\\",\\n    \\\"eufy X10 Pro Omni Robot Vacuum Cleaner with Mop, All-in-One Station, 8,000Pa Powerful Suction, Dual Mops, AI Obstacle Avoidance, Auto Mop Washing, Auto-Hot-Air-Drying, Auto-Emptying, Auto-Refilling £799.00\\\"\\n  ] \\n}\"\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"66c28c7e-7ff1-4aac-8fbf-35e8c8105a65\",\n      \"name\": \"Replace Me!\",\n      \"type\": \"n8n-nodes-base.noOp\",\n      \"position\": [\n        1260,\n        -120\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"e58f3c0f-c441-4c89-9a19-2c3459733dee\",\n      \"name\": \"Login Form\",\n      \"type\": \"n8n-nodes-base.formTrigger\",\n      \"position\": [\n        1080,\n        -120\n      ],\n      \"webhookId\": \"cac0738d-f211-41de-bc6e-6f36103d9c1a\",\n      \"parameters\": {\n        \"options\": {\n          \"path\": \"auth\",\n          \"ignoreBots\": true,\n          \"buttonLabel\": \"Submit\"\n        },\n        \"formTitle\": \"Authenticate Chat Session\",\n        \"formFields\": {\n          \"values\": [\n            {\n              \"fieldLabel\": \"Username\",\n              \"requiredField\": true\n            },\n            {\n              \"fieldLabel\": \"Password\",\n              \"requiredField\": true\n            },\n            {\n              \"fieldName\": \"sessionId\",\n              \"fieldType\": \"hiddenField\"\n            }\n          ]\n        },\n        \"responseMode\": \"lastNode\",\n        \"formDescription\": \"Please login to validate your current chat session.\"\n      },\n      \"typeVersion\": 2.2\n    },\n    {\n      \"id\": \"2f965c47-76e3-4100-8c48-2be4dccece49\",\n      \"name\": \"Sticky Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1220,\n        60\n      ],\n      \"parameters\": {\n        \"color\": 5,\n        \"width\": 200,\n        \"height\": 140,\n        \"content\": \"### 替换为认证逻辑！\\n此处可以是向PostgreSQL数据库发起查询或其他验证方式。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"1d5077eb-4a6b-4bcb-9a85-e525a6c013ab\",\n      \"name\": \"Sticky Note4\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -1160,\n        -820\n      ],\n      \"parameters\": {\n        \"width\": 460,\n        \"height\": 1160,\n        \"content\": \"## 试试看吧！\\n### 本n8n模板展示了通过聊天代理实现客户认证的一种方案\\n\\n与其他需要预先验证用户身份才能与代理交互的方案不同，该方案允许访客用户在会话过程中随时进行身份验证，或选择不验证。\\n\\n### 工作原理\\n* 演示采用对话式代理，核心组件是聊天触发器后的Redis节点，它充当会话上下文存储器\\n* 对于访客用户，会话条目为空；对于认证客户，会话条目会存储其客户资料\\n* 系统会指示代理仅在适当时机或收到请求时，为访客生成专属登录链接\\n* 该登录链接将跳转至模板内置的简易n8n表单，并通过URL中的sessionID查询参数传递会话数据\\n* 登录成功后，系统会根据sessionID更新对应会话条目中的客户资料。用户此时可返回聊天窗口\\n* 当用户发送下条消息时，Redis节点将读取附带客户资料的会话条目，系统提示词会同步更新，使代理知晓用户已成为认证客户\\n\\n### 使用指南\\n* 需修改\\\"auth URL\\\"工具以匹配您的n8n实例地址（建议直接复制表单触发器生成的生产环境URL）\\n* 激活工作流进入生产模式（本流程必需步骤）\\n* 在第三步实现认证逻辑（例如将账号密码提交至PostgreSQL数据库进行验证）\\n\\n### 环境要求\\n* OpenAI大语言模型（可自由替换为其他供应商）\\n* Redis缓存/会话服务（同样支持替换为PostgreSQL等数据库）\\n\\n### 定制建议\\n* 考虑仅存储用户ID而非完整资料，避免数据陈旧化。可指示代理通过工具实时查询用户信息\\n\\n### 获取帮助\\n欢迎加入[Discord社区](https://discord.com/invite/XPKeKXeB7d)或访问[官方论坛](https://community.n8n.io/)提问！\\n\\n祝您探索愉快！\"\n      },\n      \"typeVersion\": 1\n    }\n  ],\n  \"pinData\": {},\n  \"connections\": {\n    \"LLM\": {\n      \"ai_languageModel\": [\n        [\n          {\n            \"node\": \"Customer Support Agent\",\n            \"type\": \"ai_languageModel\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Memory\": {\n      \"ai_memory\": [\n        [\n          {\n            \"node\": \"Customer Support Agent\",\n            \"type\": \"ai_memory\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Switch\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get Auth Url Response\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Login Form\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Replace Me!\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get Session\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Customer Support Agent\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Replace Me!\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get Customer Profile\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get Auth URL\": {\n      \"ai_tool\": [\n        [\n          {\n            \"node\": \"Customer Support Agent\",\n            \"type\": \"ai_tool\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Update Session\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Confirm Login Success\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get Customer Profile\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Update Session\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"When chat message received\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get Session\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"When Executed by Another Workflow\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Switch\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}"
}