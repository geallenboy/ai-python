{
  "url": "https://n8n.io/workflows/3988-access-control-for-ai-agents-rbac-using-airtable-and-telegram/",
  "title": "Access Control for AI Agents (RBAC) using Airtable and Telegram",
  "author": "Mario",
  "publish_date": "Last update 12 days ago",
  "publish_date_absolute": "2025-05-14",
  "categories": [
    {
      "name": "Engineering"
    },
    {
      "name": "AI"
    },
    {
      "name": "IT Ops"
    }
  ],
  "workflow_json": "{\"id\":\"fa2TGWrY9rPurC30\",\"meta\":{\"instanceId\":\"fb8bc2e315f7f03c97140b30aa454a27bc7883a19000fa1da6e6b571bf56ad6d\",\"templateCredsSetupCompleted\":true},\"name\":\"Agent Access Control Template\",\"tags\":[{\"id\":\"RKga6I6NviNI12bx\",\"name\":\"template\",\"createdAt\":\"2024-09-19T19:09:21.997Z\",\"updatedAt\":\"2024-09-19T19:09:21.997Z\"}],\"nodes\":[{\"id\":\"77771654-bfb9-4c34-b644-d4d6eeb15d37\",\"name\":\"Simple Memory\",\"type\":\"@n8n/n8n-nodes-langchain.memoryBufferWindow\",\"position\":[560,260],\"parameters\":{\"sessionKey\":\"={{ $('Telegram Trigger').item.json.message.from.id }}\",\"sessionIdType\":\"customKey\"},\"typeVersion\":1.3},{\"id\":\"f1ef483e-4f84-40c7-957d-191a54ffb80e\",\"name\":\"OpenAI Chat Model\",\"type\":\"@n8n/n8n-nodes-langchain.lmChatOpenAi\",\"position\":[360,260],\"parameters\":{\"model\":{\"__rl\":true,\"mode\":\"list\",\"value\":\"gpt-4o\",\"cachedResultName\":\"gpt-4o\"},\"options\":{}},\"credentials\":{\"openAiApi\":{\"id\":\"X7Jf0zECd3IkQdSw\",\"name\":\"OpenAi (octionicsolutions)\"}},\"typeVersion\":1.2},{\"id\":\"c6ba00c9-8ca2-4cf0-9e2c-24ead9eb7c1b\",\"name\":\"Check permissions\",\"type\":\"@n8n/n8n-nodes-langchain.code\",\"position\":[960,260],\"parameters\":{\"code\":{\"supplyData\":{\"code\":\"const { DynamicTool } = require(\\\"@langchain/core/tools\\\");\\nconst connectedTools = await this.getInputConnectionData('ai_tool', 0);\\nconst allowedTools = $input.item.json.allowed_tools;\\n\\nconst noTool = (tool) => {\\n  return new DynamicTool({\\n    name: tool.getName(),\\n    description: tool.description,\\n    func: async () => {\\n        return \\\"Tell the user 'You are not authorized to use this tool'.\\\";\\n    },\\n  });\\n}\\n\\nreturn connectedTools.map(connectedTool => {\\n  const permissionGranted = allowedTools.includes(connectedTool.getName());\\n  return permissionGranted ? connectedTool : noTool(connectedTool);\\n});\"}},\"inputs\":{\"input\":[{\"type\":\"ai_tool\",\"required\":true}]},\"outputs\":{\"output\":[{\"type\":\"ai_tool\"}]}},\"typeVersion\":1},{\"id\":\"db15e298-b8d0-4096-b606-18bc8d43bb39\",\"name\":\"Telegram Trigger\",\"type\":\"n8n-nodes-base.telegramTrigger\",\"position\":[-240,-120],\"webhookId\":\"4410accd-63e4-4c38-ad0b-26874f5eb673\",\"parameters\":{\"updates\":[\"message\"],\"additionalFields\":{}},\"credentials\":{\"telegramApi\":{\"id\":\"3paV9xW2WWlusvsq\",\"name\":\"octionictest_bot\"}},\"typeVersion\":1.2},{\"id\":\"3df9b9f5-c0a2-4905-95aa-285b492f2ec0\",\"name\":\"Set input\",\"type\":\"n8n-nodes-base.set\",\"position\":[420,0],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"9ea62c8f-984b-4c05-8e40-549d8035c4d3\",\"name\":\"name\",\"type\":\"string\",\"value\":\"={{ $json.name }}\"},{\"id\":\"bf74b2c4-f0d1-458a-9044-5cb1b62722e6\",\"name\":\"granted_roles\",\"type\":\"array\",\"value\":\"={{ $json.granted_roles || [] }}\"},{\"id\":\"e0f4d3d7-a916-43cb-a13d-e4453b0d1a3b\",\"name\":\"allowed_tools\",\"type\":\"array\",\"value\":\"={{ $json.allowed_tools || [] }}\"}]}},\"typeVersion\":3.4},{\"id\":\"a5af8184-4a17-447e-96d3-809c6bd131f3\",\"name\":\"Get user permissions\",\"type\":\"n8n-nodes-base.airtable\",\"position\":[-20,-120],\"parameters\":{\"base\":{\"__rl\":true,\"mode\":\"list\",\"value\":\"app0K2OqeryZWxIt9\",\"cachedResultUrl\":\"https://airtable.com/app0K2OqeryZWxIt9\",\"cachedResultName\":\"Agent Access Control\"},\"table\":{\"__rl\":true,\"mode\":\"list\",\"value\":\"tblRcEGwmycLfDuHt\",\"cachedResultUrl\":\"https://airtable.com/app0K2OqeryZWxIt9/tblRcEGwmycLfDuHt\",\"cachedResultName\":\"Users\"},\"options\":{\"fields\":[\"granted_roles\",\"allowed_tools\",\"name\"]},\"operation\":\"search\",\"filterByFormula\":\"={username} = '{{ $json.message.from.username }}'\"},\"credentials\":{\"airtableTokenApi\":{\"id\":\"24eNAG2FrCu3ZCtz\",\"name\":\"AAC read only\"}},\"typeVersion\":2.1,\"alwaysOutputData\":true},{\"id\":\"4abf80e7-9b1f-4ef0-b742-da29e1208b78\",\"name\":\"When Executed by Another Workflow\",\"type\":\"n8n-nodes-base.executeWorkflowTrigger\",\"position\":[0,800],\"parameters\":{\"workflowInputs\":{\"values\":[{\"name\":\"chatInput\"},{\"name\":\"sessionId\"},{\"name\":\"allowed_tools\"}]}},\"typeVersion\":1.1},{\"id\":\"10129d31-3446-47a0-aacd-3bd584b0bd79\",\"name\":\"Settings\",\"type\":\"n8n-nodes-base.set\",\"position\":[220,800],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"93b5d2ac-8c8a-4c61-999f-2727b7ba9514\",\"name\":\"chatInput\",\"type\":\"string\",\"value\":\"={{ $json.chatInput }}\"},{\"id\":\"3f65df4c-fae1-4da3-acfd-acf352a3f8d2\",\"name\":\"sessionId\",\"type\":\"string\",\"value\":\"={{ $json.sessionId }}\"},{\"id\":\"81020154-c869-4bc8-944a-a9aee900a656\",\"name\":\"allowed_tools\",\"type\":\"array\",\"value\":\"={{ $json.allowed_tools }}\"}]}},\"typeVersion\":3.4},{\"id\":\"c45f4258-8ef6-4bf6-878f-5e86ac577712\",\"name\":\"OpenAI Chat Model1\",\"type\":\"@n8n/n8n-nodes-langchain.lmChatOpenAi\",\"position\":[340,1060],\"parameters\":{\"model\":{\"__rl\":true,\"mode\":\"list\",\"value\":\"gpt-4o-mini\"},\"options\":{}},\"credentials\":{\"openAiApi\":{\"id\":\"X7Jf0zECd3IkQdSw\",\"name\":\"OpenAi (octionicsolutions)\"}},\"typeVersion\":1.2},{\"id\":\"e5cf82bc-c9a8-474e-bbeb-201e3431fa36\",\"name\":\"Simple Memory1\",\"type\":\"@n8n/n8n-nodes-langchain.memoryBufferWindow\",\"position\":[540,1060],\"parameters\":{\"sessionKey\":\"={{ $('Settings').item.json.sessionId }}_weather_check\",\"sessionIdType\":\"customKey\"},\"typeVersion\":1.3},{\"id\":\"e9fd93c9-c008-470b-885a-4287950b9c3d\",\"name\":\"Check permissions1\",\"type\":\"@n8n/n8n-nodes-langchain.code\",\"position\":[740,1060],\"parameters\":{\"code\":{\"supplyData\":{\"code\":\"const { DynamicTool } = require(\\\"@langchain/core/tools\\\");\\nconst connectedTools = await this.getInputConnectionData('ai_tool', 0);\\nconst allowedTools = $input.item.json.allowed_tools;\\n\\nconst noTool = (tool) => {\\n  return new DynamicTool({\\n    name: tool.getName(),\\n    description: tool.description,\\n    func: async () => {\\n        return \\\"Tell the user 'You are not authorized to use this tool'.\\\";\\n    },\\n  });\\n}\\n\\nreturn connectedTools.map(connectedTool => {\\n  const permissionGranted = allowedTools.includes(connectedTool.getName());\\n  return permissionGranted ? connectedTool : noTool(connectedTool);\\n});\"}},\"inputs\":{\"input\":[{\"type\":\"ai_tool\",\"required\":true}]},\"outputs\":{\"output\":[{\"type\":\"ai_tool\"}]}},\"typeVersion\":1},{\"id\":\"f791deb0-9ebe-4451-8a1f-3119547dd576\",\"name\":\"list_granted_roles\",\"type\":\"@n8n/n8n-nodes-langchain.toolCode\",\"position\":[1000,460],\"parameters\":{\"name\":\"list_granted_roles\",\"jsCode\":\"// Example: convert the incoming query to uppercase and return it\\nreturn \\\"You are assigned the following roles: \\\" + $input.item.json.granted_roles.join(\\\", \\\");\",\"description\":\"Call this tool to tell the user which roles they have been granted.\"},\"typeVersion\":1.1},{\"id\":\"ab0c6dae-6259-4be1-b0df-e3276cafb938\",\"name\":\"list_allowed_tools\",\"type\":\"@n8n/n8n-nodes-langchain.toolCode\",\"position\":[1160,460],\"parameters\":{\"name\":\"list_allowed_tools\",\"jsCode\":\"return \\\"You have access to the following tools: \\\" + $input.item.json.allowed_tools.join(\\\", \\\");\",\"description\":\"Call this tool to tell the user which tools they have access to.\"},\"typeVersion\":1.1},{\"id\":\"76529936-80ea-4f94-9a06-bae3b6ea0ce3\",\"name\":\"calculator\",\"type\":\"@n8n/n8n-nodes-langchain.toolCalculator\",\"position\":[860,460],\"parameters\":{},\"typeVersion\":1},{\"id\":\"fd7f4875-6838-4b53-9167-4a22d4f5f27f\",\"name\":\"Wikipedia\",\"type\":\"@n8n/n8n-nodes-langchain.toolWikipedia\",\"position\":[760,260],\"parameters\":{},\"typeVersion\":1},{\"id\":\"0dc5c3e6-b9d2-4a96-9539-dae86dc171a6\",\"name\":\"get_coordinates\",\"type\":\"@n8n/n8n-nodes-langchain.toolHttpRequest\",\"position\":[800,1260],\"parameters\":{\"url\":\"https://geocoding-api.open-meteo.com/v1/search?name={city}&count=1\",\"fields\":\"name,latitude,longitude\",\"dataField\":\"results\",\"fieldsToInclude\":\"selected\",\"toolDescription\":\"Get the GEO position by city name\",\"optimizeResponse\":true,\"placeholderDefinitions\":{\"values\":[{\"name\":\"city\",\"type\":\"string\",\"description\":\"Name of the city\"}]}},\"typeVersion\":1.1},{\"id\":\"e70a2cb2-832b-4741-85d2-c446be168ad4\",\"name\":\"get_weather\",\"type\":\"@n8n/n8n-nodes-langchain.toolHttpRequest\",\"position\":[980,1260],\"parameters\":{\"url\":\"https://api.open-meteo.com/v1/forecast?latitude={latitude}&longitude={longitude}&current_weather=true\",\"toolDescription\":\"Get current weather by GEO data (longitude, latitude)\",\"placeholderDefinitions\":{\"values\":[{\"name\":\"longitude\",\"type\":\"string\",\"description\":\"Longitude of location. Dot as decimal separator.\"},{\"name\":\"latitude\",\"type\":\"string\",\"description\":\"Latitude of location. Dot as decimal separator.\"}]}},\"typeVersion\":1.1},{\"id\":\"66c5568d-d2fe-4938-b577-b005a5c32e37\",\"name\":\"weather_agent\",\"type\":\"@n8n/n8n-nodes-langchain.toolWorkflow\",\"position\":[1360,460],\"parameters\":{\"name\":\"weather_agent\",\"workflowId\":{\"__rl\":true,\"mode\":\"list\",\"value\":\"C1fIIooUO64D56t6\",\"cachedResultName\":\"Agent Access Control with Airtable and Telegram\"},\"workflowInputs\":{\"value\":{\"chatInput\":\"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('chatInput', ``, 'string') }}\",\"sessionId\":\"={{ $('Telegram Trigger').item.json.message.from.id }}\",\"allowed_tools\":\"={{ $input.item.json.allowed_tools }}\"},\"schema\":[{\"id\":\"sessionId\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"sessionId\",\"defaultMatch\":false,\"canBeUsedToMatch\":true},{\"id\":\"chatInput\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"chatInput\",\"defaultMatch\":false,\"canBeUsedToMatch\":true},{\"id\":\"allowed_tools\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"allowed_tools\",\"defaultMatch\":false,\"canBeUsedToMatch\":true}],\"mappingMode\":\"defineBelow\",\"matchingColumns\":[],\"attemptToConvertTypes\":false,\"convertFieldsToString\":false}},\"typeVersion\":2.1},{\"id\":\"ffcf4df4-f969-4bc1-9393-0e7a4317626a\",\"name\":\"Weather Agent\",\"type\":\"@n8n/n8n-nodes-langchain.agent\",\"position\":[440,800],\"parameters\":{\"options\":{\"systemMessage\":\"=You are a weather data assistant.\\nYou MUST only use the provided tools to process any user input. Never use general knowledge to answer questions. If you can't use a tool, tell the user why.\"}},\"typeVersion\":1.8},{\"id\":\"eae759d7-fa4a-4993-bbcf-cc430f2dfa60\",\"name\":\"Unknown user\",\"type\":\"n8n-nodes-base.if\",\"position\":[200,-120],\"parameters\":{\"options\":{},\"conditions\":{\"options\":{\"version\":2,\"leftValue\":\"\",\"caseSensitive\":true,\"typeValidation\":\"strict\"},\"combinator\":\"and\",\"conditions\":[{\"id\":\"1d042f5b-ef39-4b9e-8d9c-900b39dbe3fb\",\"operator\":{\"type\":\"object\",\"operation\":\"empty\",\"singleValue\":true},\"leftValue\":\"={{ $json }}\",\"rightValue\":\"\"}]}},\"typeVersion\":2.2},{\"id\":\"df377324-d57d-45ab-85c7-88446a07abcd\",\"name\":\"Sticky Note\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[-80,-260],\"parameters\":{\"width\":220,\"height\":300,\"content\":\"## Choose Base\\nCopy [this Airtable Template](https://airtable.com/appi5nijuvzQbZLJJ/shr8OkLysG1VtlCiz) into your workspace and select that Base here\"},\"typeVersion\":1},{\"id\":\"b1ddd130-07fa-47e3-ba24-7b4e85f94b6a\",\"name\":\"Sticky Note1\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1280,300],\"parameters\":{\"height\":300,\"content\":\"## Choose workflow\\nSelect the current workflow as the workflow that should be called\"},\"typeVersion\":1},{\"id\":\"7d24fc8e-36e7-4087-88cc-7f1c725ce814\",\"name\":\"Sticky Note2\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[900,160],\"parameters\":{\"color\":7,\"width\":380,\"height\":220,\"content\":\"Uses list of allowed tools gathered from Airtable to check for permissions and replaces denied tools with a fixed instruction to return a message to the user.\"},\"typeVersion\":1},{\"id\":\"987b3372-1703-4284-a285-d2edfd032422\",\"name\":\"Sticky Note3\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[700,160],\"parameters\":{\"color\":7,\"width\":200,\"height\":220,\"content\":\"Tools can also be connected without a permission check\"},\"typeVersion\":1},{\"id\":\"885b0117-bae1-4aac-a91f-e140259b32e2\",\"name\":\"Sticky Note4\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[580,-80],\"parameters\":{\"color\":7,\"width\":380,\"height\":240,\"content\":\"Main agent with the instruction to always use the connected tools instead of general knowledge\"},\"typeVersion\":1},{\"id\":\"25f17f39-a777-4386-b14d-1ed7db3c54f4\",\"name\":\"Sticky Note5\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[360,-80],\"parameters\":{\"color\":7,\"width\":220,\"height\":240,\"content\":\"Collects input and formats it using required keys\"},\"typeVersion\":1},{\"id\":\"a0abbeea-d9c1-4005-b996-d4e8e4fd97d3\",\"name\":\"Sticky Note7\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[160,720],\"parameters\":{\"color\":7,\"width\":220,\"height\":240,\"content\":\"Collects and formats input from parent workflow / agent\"},\"typeVersion\":1},{\"id\":\"8e25e640-7b6d-4ca7-b3fd-06eac3cebbea\",\"name\":\"Sticky Note8\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[680,960],\"parameters\":{\"color\":7,\"width\":380,\"height\":220,\"content\":\"Uses the same technique as the main agent to check for permissions using the same parameters which were passed to this sub-agent.\"},\"typeVersion\":1},{\"id\":\"1168726e-2a39-40f6-aea6-77c12dc2b37b\",\"name\":\"Sticky Note9\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[380,720],\"parameters\":{\"color\":7,\"width\":380,\"height\":240,\"content\":\"Sub-agent with specific role to handle weather information. Also having the instruction to strictly only use the connected tools.\"},\"typeVersion\":1},{\"id\":\"e65e1ea3-c773-4e65-8c49-b9f7fe75df28\",\"name\":\"Reply: unknown user\",\"type\":\"n8n-nodes-base.telegram\",\"position\":[420,-240],\"webhookId\":\"510028ef-060f-4ce7-898e-f1a2a376780c\",\"parameters\":{\"text\":\"=Unknown user '{{ $('Telegram Trigger').item.json.message.from.username }}'. Please contact your supervisor.\",\"chatId\":\"={{ $('Telegram Trigger').item.json.message.chat.id }}\",\"additionalFields\":{\"appendAttribution\":false}},\"credentials\":{\"telegramApi\":{\"id\":\"3paV9xW2WWlusvsq\",\"name\":\"octionictest_bot\"}},\"typeVersion\":1.2},{\"id\":\"aa5937b9-22d2-4719-9d51-00f7d28beb43\",\"name\":\"Reply with results\",\"type\":\"n8n-nodes-base.telegram\",\"position\":[1020,0],\"webhookId\":\"97bc8ca7-d40a-41d6-9cc2-4c9943313fb4\",\"parameters\":{\"text\":\"={{ $json.output }}\",\"chatId\":\"={{ $('Telegram Trigger').item.json.message.chat.id }}\",\"additionalFields\":{\"appendAttribution\":false}},\"credentials\":{\"telegramApi\":{\"id\":\"3paV9xW2WWlusvsq\",\"name\":\"octionictest_bot\"}},\"typeVersion\":1.2},{\"id\":\"623328d8-e9ad-431e-b3ca-df0cdbcb7430\",\"name\":\"Main Agent\",\"type\":\"@n8n/n8n-nodes-langchain.agent\",\"position\":[640,0],\"parameters\":{\"text\":\"={{ $('Telegram Trigger').item.json.message.text }}\",\"options\":{\"systemMessage\":\"=You are a personal assistant. The name of the current user is \\\"{{ $json.name }}\\\"\\nYou MUST only use the provided tools to process any user input. Never use general knowledge to answer questions. If you can't use a tool, tell the user why.\",\"returnIntermediateSteps\":true},\"promptType\":\"define\"},\"typeVersion\":1.8},{\"id\":\"cacefd8b-082c-43a4-9e25-fb497d0d8dd9\",\"name\":\"Sticky Note6\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[500,160],\"parameters\":{\"color\":6,\"width\":200,\"height\":220,\"content\":\"Be aware, that previous responses may still exist after permission changes\"},\"typeVersion\":1},{\"id\":\"802ba649-b56e-4e90-a780-a3a1935a7907\",\"name\":\"Sticky Note10\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[480,960],\"parameters\":{\"color\":7,\"width\":200,\"height\":220,\"content\":\"Uses different session ID (suffix), since every agent needs its own memory\"},\"typeVersion\":1},{\"id\":\"b82c9149-e583-4c98-a6d8-c92080fd44ba\",\"name\":\"Sticky Note11\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[-300,-200],\"parameters\":{\"color\":7,\"width\":220,\"height\":240,\"content\":\"Listens to messages directly sent to the bot\"},\"typeVersion\":1},{\"id\":\"b74fcbc1-aa66-440a-9a75-340858bba6c5\",\"name\":\"Sticky Note12\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[140,-200],\"parameters\":{\"color\":7,\"width\":220,\"height\":240,\"content\":\"Checks if the user was found in Airtable\"},\"typeVersion\":1}],\"active\":false,\"pinData\":{},\"settings\":{\"errorWorkflow\":\"gGHnVxFBZDQlm6QE\",\"executionOrder\":\"v1\"},\"versionId\":\"08372ec4-0f43-411a-b600-61e8d80da545\",\"connections\":{\"Settings\":{\"main\":[[{\"node\":\"Weather Agent\",\"type\":\"main\",\"index\":0}]]},\"Set input\":{\"main\":[[{\"node\":\"Main Agent\",\"type\":\"main\",\"index\":0}]]},\"Wikipedia\":{\"ai_tool\":[[{\"node\":\"Main Agent\",\"type\":\"ai_tool\",\"index\":0}]]},\"Main Agent\":{\"main\":[[{\"node\":\"Reply with results\",\"type\":\"main\",\"index\":0}]]},\"calculator\":{\"ai_tool\":[[{\"node\":\"Check permissions\",\"type\":\"ai_tool\",\"index\":0}]]},\"get_weather\":{\"ai_tool\":[[{\"node\":\"Check permissions1\",\"type\":\"ai_tool\",\"index\":0}]]},\"Unknown user\":{\"main\":[[{\"node\":\"Reply: unknown user\",\"type\":\"main\",\"index\":0}],[{\"node\":\"Set input\",\"type\":\"main\",\"index\":0}]]},\"Simple Memory\":{\"ai_memory\":[[{\"node\":\"Main Agent\",\"type\":\"ai_memory\",\"index\":0}]]},\"weather_agent\":{\"ai_tool\":[[{\"node\":\"Check permissions\",\"type\":\"ai_tool\",\"index\":0}]]},\"Simple Memory1\":{\"ai_memory\":[[{\"node\":\"Weather Agent\",\"type\":\"ai_memory\",\"index\":0}]]},\"get_coordinates\":{\"ai_tool\":[[{\"node\":\"Check permissions1\",\"type\":\"ai_tool\",\"index\":0}]]},\"Telegram Trigger\":{\"main\":[[{\"node\":\"Get user permissions\",\"type\":\"main\",\"index\":0}]]},\"Check permissions\":{\"ai_tool\":[[{\"node\":\"Main Agent\",\"type\":\"ai_tool\",\"index\":0}]]},\"OpenAI Chat Model\":{\"ai_languageModel\":[[{\"node\":\"Main Agent\",\"type\":\"ai_languageModel\",\"index\":0}]]},\"Check permissions1\":{\"ai_tool\":[[{\"node\":\"Weather Agent\",\"type\":\"ai_tool\",\"index\":0}]]},\"OpenAI Chat Model1\":{\"ai_languageModel\":[[{\"node\":\"Weather Agent\",\"type\":\"ai_languageModel\",\"index\":0}]]},\"list_allowed_tools\":{\"ai_tool\":[[{\"node\":\"Check permissions\",\"type\":\"ai_tool\",\"index\":0}]]},\"list_granted_roles\":{\"ai_tool\":[[{\"node\":\"Check permissions\",\"type\":\"ai_tool\",\"index\":0}]]},\"Get user permissions\":{\"main\":[[{\"node\":\"Unknown user\",\"type\":\"main\",\"index\":0}]]},\"When Executed by Another Workflow\":{\"main\":[[{\"node\":\"Settings\",\"type\":\"main\",\"index\":0}]]}}}",
  "readme": "## Purpose\n\nThis workflow allows granular control over the access to tools connected to AI Agents (including Multi-Agent setups) using **R** ole **B** ased **A** ccess **C** ontrol.\n\n## Demo & Explanation\n\n[![demo video](https://img.youtube.com/vi/eNgik9NR0wg/0.jpg)](https://youtu.be/eNgik9NR0wg)\n\n## How it works\n\n  * User permissions are managed in Airtable where every restricted AI tool is listed by name and connected via roles to users\n  * Requests to the Main Agent can be sent through a Telegram message (can be replaced by Whatsapp, IMAP or similar)\n  * On every request the Telegram username is used to query a list of all allowed tools which are linked in Airtable\n  * A LangChain Code node is used to compare that list against the connected tools\n  * Every tool which is not permitted to be used is being replaced by a tool, which has a status response, telling the Agent to return a message to the user, that he is not authorized to use the tool\n  * Otherwise allowed tools are passed through to the Agent, as if they were connected directly to the Agent\n  * The parameters can also be passed to a sub-agent called as a sub-workflow where permissions can be checked the same way\n  * Every response is sent back to the same Telegram conversation\n\n\n\n## Setup\n\n  * Clone the workflow and select the belonging credentials. You'll need an OpenAI and Airtable Account as well as a Telegram Bot (refer to the docs for the [Telegram credentials](https://docs.n8n.io/integrations/builtin/credentials/telegram/)).\n  * Copy [this Airtable Template](https://airtable.com/appi5nijuvzQbZLJJ/shr8OkLysG1VtlCiz) into your workspace\n  * Follow the instructions given in the yellow sticky notes\n  * Activate the workflow\n\n\n\n## How to use\n\nTry this example:\n\n  * Create a new line in Airtable under “Users” containing your Telegram username and your full name\n  * Set the roles “basic” and “info”\n  * _Consider temporarily disconnecting or resetting the chat memories so they do not remember previous confirmations_\n  * Start a new chat, asking about your permitted roles - you should get a list of those\n  * Ask about the current weather in your city - you should be informed, that you do not have permission to access that information\n  * Back in Airtable add the role “weather” to your user\n  * Now ask the Agent the same question again - It should give you a proper answer this time\n\n\n\nFrom here on you can add tools and create roles to your likings.\n\n## Disclaimer\n\nPlease note, that this workflow can only run on self-hosted n8n instances, since it requires the LangChain Code Node.\n",
  "crawled_at": "2025-05-26T06:12:15.849448",
  "readme_zh": "## 目的\n\n本工作流通过**基于角色的访问控制（RBAC）**机制，实现对AI智能体（包括多智能体架构）所连接工具的精细化权限管理。\n\n## 演示视频\n\n[![演示视频](https://img.youtube.com/vi/eNgik9NR0wg/0.jpg)](https://youtu.be/eNgik9NR0wg)\n\n## 实现原理\n\n  * 在Airtable中管理用户权限，每个受限AI工具均按名称列出，并通过角色与用户关联\n  * 用户可通过Telegram消息（可替换为Whatsapp/IMAP等渠道）向主智能体发送请求\n  * 每次请求时，系统会通过Telegram用户名查询Airtable中该用户被授权的工具列表\n  * 通过LangChain代码节点比对实际连接的工具与授权列表\n  * 未被授权的工具将被替换为状态响应工具，告知用户无权限使用该功能\n  * 已授权的工具将直接透传给智能体，如同原生连接一般\n  * 参数也可传递至子工作流调用的次级智能体，其权限校验流程与主智能体一致\n  * 所有响应均返回至原Telegram会话窗口\n\n## 部署指南\n\n  * 克隆工作流并配置对应凭证：需准备OpenAI账号、Airtable账号及Telegram机器人（参见[Telegram凭证文档](https://docs.n8n.io/integrations/builtin/credentials/telegram/)）\n  * 将[此Airtable模板](https://airtable.com/appi5nijuvzQbZLJJ/shr8OkLysG1VtlCiz)复制至您的工作区\n  * 按照黄色便签注释的指引操作\n  * 激活工作流\n\n## 使用示例\n\n测试流程如下：\n\n  * 在Airtable\"用户\"表中新增记录，填写您的Telegram用户名和全名\n  * 分配\"basic\"和\"info\"角色\n  * （建议临时断开或重置聊天记忆存储，避免历史确认信息干扰）\n  * 发起新会话查询您的权限角色——应获得对应角色列表\n  * 询问您所在城市的天气——将收到无权限访问的提示\n  * 返回Airtable为用户添加\"weather\"角色\n  * 重复相同天气询问——此时应获得正确应答\n\n完成基础测试后，您可自由添加工具并创建自定义角色。\n\n## 注意事项\n\n请注意，由于依赖LangChain代码节点，本工作流仅支持在自托管n8n实例上运行。",
  "title_zh": "基于Airtable与Telegram的AI代理访问控制（RBAC）",
  "publish_date_zh": "最近更新于一天前",
  "workflow_json_zh": "{\n  \"id\": \"fa2TGWrY9rPurC30\",\n  \"meta\": {\n    \"instanceId\": \"fb8bc2e315f7f03c97140b30aa454a27bc7883a19000fa1da6e6b571bf56ad6d\",\n    \"templateCredsSetupCompleted\": true\n  },\n  \"name\": \"Agent Access Control Template\",\n  \"tags\": [\n    {\n      \"id\": \"RKga6I6NviNI12bx\",\n      \"name\": \"template\",\n      \"createdAt\": \"2024-09-19T19:09:21.997Z\",\n      \"updatedAt\": \"2024-09-19T19:09:21.997Z\"\n    }\n  ],\n  \"nodes\": [\n    {\n      \"id\": \"77771654-bfb9-4c34-b644-d4d6eeb15d37\",\n      \"name\": \"Simple Memory\",\n      \"type\": \"@n8n/n8n-nodes-langchain.memoryBufferWindow\",\n      \"position\": [\n        560,\n        260\n      ],\n      \"parameters\": {\n        \"sessionKey\": \"={{ $('Telegram Trigger').item.json.message.from.id }}\",\n        \"sessionIdType\": \"customKey\"\n      },\n      \"typeVersion\": 1.3\n    },\n    {\n      \"id\": \"f1ef483e-4f84-40c7-957d-191a54ffb80e\",\n      \"name\": \"OpenAI Chat Model\",\n      \"type\": \"@n8n/n8n-nodes-langchain.lmChatOpenAi\",\n      \"position\": [\n        360,\n        260\n      ],\n      \"parameters\": {\n        \"model\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"gpt-4o\",\n          \"cachedResultName\": \"gpt-4o\"\n        },\n        \"options\": {}\n      },\n      \"credentials\": {\n        \"openAiApi\": {\n          \"id\": \"X7Jf0zECd3IkQdSw\",\n          \"name\": \"OpenAi (octionicsolutions)\"\n        }\n      },\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"c6ba00c9-8ca2-4cf0-9e2c-24ead9eb7c1b\",\n      \"name\": \"Check permissions\",\n      \"type\": \"@n8n/n8n-nodes-langchain.code\",\n      \"position\": [\n        960,\n        260\n      ],\n      \"parameters\": {\n        \"code\": {\n          \"supplyData\": {\n            \"code\": \"const { DynamicTool } = require(\\\"@langchain/core/tools\\\");\\nconst connectedTools = await this.getInputConnectionData('ai_tool', 0);\\nconst allowedTools = $input.item.json.allowed_tools;\\n\\nconst noTool = (tool) => {\\n  return new DynamicTool({\\n    name: tool.getName(),\\n    description: tool.description,\\n    func: async () => {\\n        return \\\"Tell the user 'You are not authorized to use this tool'.\\\";\\n    },\\n  });\\n}\\n\\nreturn connectedTools.map(connectedTool => {\\n  const permissionGranted = allowedTools.includes(connectedTool.getName());\\n  return permissionGranted ? connectedTool : noTool(connectedTool);\\n});\"\n          }\n        },\n        \"inputs\": {\n          \"input\": [\n            {\n              \"type\": \"ai_tool\",\n              \"required\": true\n            }\n          ]\n        },\n        \"outputs\": {\n          \"output\": [\n            {\n              \"type\": \"ai_tool\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"db15e298-b8d0-4096-b606-18bc8d43bb39\",\n      \"name\": \"Telegram Trigger\",\n      \"type\": \"n8n-nodes-base.telegramTrigger\",\n      \"position\": [\n        -240,\n        -120\n      ],\n      \"webhookId\": \"4410accd-63e4-4c38-ad0b-26874f5eb673\",\n      \"parameters\": {\n        \"updates\": [\n          \"message\"\n        ],\n        \"additionalFields\": {}\n      },\n      \"credentials\": {\n        \"telegramApi\": {\n          \"id\": \"3paV9xW2WWlusvsq\",\n          \"name\": \"octionictest_bot\"\n        }\n      },\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"3df9b9f5-c0a2-4905-95aa-285b492f2ec0\",\n      \"name\": \"Set input\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        420,\n        0\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"9ea62c8f-984b-4c05-8e40-549d8035c4d3\",\n              \"name\": \"name\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.name }}\"\n            },\n            {\n              \"id\": \"bf74b2c4-f0d1-458a-9044-5cb1b62722e6\",\n              \"name\": \"granted_roles\",\n              \"type\": \"array\",\n              \"value\": \"={{ $json.granted_roles || [] }}\"\n            },\n            {\n              \"id\": \"e0f4d3d7-a916-43cb-a13d-e4453b0d1a3b\",\n              \"name\": \"allowed_tools\",\n              \"type\": \"array\",\n              \"value\": \"={{ $json.allowed_tools || [] }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"a5af8184-4a17-447e-96d3-809c6bd131f3\",\n      \"name\": \"Get user permissions\",\n      \"type\": \"n8n-nodes-base.airtable\",\n      \"position\": [\n        -20,\n        -120\n      ],\n      \"parameters\": {\n        \"base\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"app0K2OqeryZWxIt9\",\n          \"cachedResultUrl\": \"https://airtable.com/app0K2OqeryZWxIt9\",\n          \"cachedResultName\": \"Agent Access Control\"\n        },\n        \"table\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"tblRcEGwmycLfDuHt\",\n          \"cachedResultUrl\": \"https://airtable.com/app0K2OqeryZWxIt9/tblRcEGwmycLfDuHt\",\n          \"cachedResultName\": \"Users\"\n        },\n        \"options\": {\n          \"fields\": [\n            \"granted_roles\",\n            \"allowed_tools\",\n            \"name\"\n          ]\n        },\n        \"operation\": \"search\",\n        \"filterByFormula\": \"={username} = '{{ $json.message.from.username }}'\"\n      },\n      \"credentials\": {\n        \"airtableTokenApi\": {\n          \"id\": \"24eNAG2FrCu3ZCtz\",\n          \"name\": \"AAC read only\"\n        }\n      },\n      \"typeVersion\": 2.1,\n      \"alwaysOutputData\": true\n    },\n    {\n      \"id\": \"4abf80e7-9b1f-4ef0-b742-da29e1208b78\",\n      \"name\": \"When Executed by Another Workflow\",\n      \"type\": \"n8n-nodes-base.executeWorkflowTrigger\",\n      \"position\": [\n        0,\n        800\n      ],\n      \"parameters\": {\n        \"workflowInputs\": {\n          \"values\": [\n            {\n              \"name\": \"chatInput\"\n            },\n            {\n              \"name\": \"sessionId\"\n            },\n            {\n              \"name\": \"allowed_tools\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"10129d31-3446-47a0-aacd-3bd584b0bd79\",\n      \"name\": \"Settings\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        220,\n        800\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"93b5d2ac-8c8a-4c61-999f-2727b7ba9514\",\n              \"name\": \"chatInput\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.chatInput }}\"\n            },\n            {\n              \"id\": \"3f65df4c-fae1-4da3-acfd-acf352a3f8d2\",\n              \"name\": \"sessionId\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.sessionId }}\"\n            },\n            {\n              \"id\": \"81020154-c869-4bc8-944a-a9aee900a656\",\n              \"name\": \"allowed_tools\",\n              \"type\": \"array\",\n              \"value\": \"={{ $json.allowed_tools }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"c45f4258-8ef6-4bf6-878f-5e86ac577712\",\n      \"name\": \"OpenAI Chat Model1\",\n      \"type\": \"@n8n/n8n-nodes-langchain.lmChatOpenAi\",\n      \"position\": [\n        340,\n        1060\n      ],\n      \"parameters\": {\n        \"model\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"gpt-4o-mini\"\n        },\n        \"options\": {}\n      },\n      \"credentials\": {\n        \"openAiApi\": {\n          \"id\": \"X7Jf0zECd3IkQdSw\",\n          \"name\": \"OpenAi (octionicsolutions)\"\n        }\n      },\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"e5cf82bc-c9a8-474e-bbeb-201e3431fa36\",\n      \"name\": \"Simple Memory1\",\n      \"type\": \"@n8n/n8n-nodes-langchain.memoryBufferWindow\",\n      \"position\": [\n        540,\n        1060\n      ],\n      \"parameters\": {\n        \"sessionKey\": \"={{ $('Settings').item.json.sessionId }}_weather_check\",\n        \"sessionIdType\": \"customKey\"\n      },\n      \"typeVersion\": 1.3\n    },\n    {\n      \"id\": \"e9fd93c9-c008-470b-885a-4287950b9c3d\",\n      \"name\": \"Check permissions1\",\n      \"type\": \"@n8n/n8n-nodes-langchain.code\",\n      \"position\": [\n        740,\n        1060\n      ],\n      \"parameters\": {\n        \"code\": {\n          \"supplyData\": {\n            \"code\": \"const { DynamicTool } = require(\\\"@langchain/core/tools\\\");\\nconst connectedTools = await this.getInputConnectionData('ai_tool', 0);\\nconst allowedTools = $input.item.json.allowed_tools;\\n\\nconst noTool = (tool) => {\\n  return new DynamicTool({\\n    name: tool.getName(),\\n    description: tool.description,\\n    func: async () => {\\n        return \\\"Tell the user 'You are not authorized to use this tool'.\\\";\\n    },\\n  });\\n}\\n\\nreturn connectedTools.map(connectedTool => {\\n  const permissionGranted = allowedTools.includes(connectedTool.getName());\\n  return permissionGranted ? connectedTool : noTool(connectedTool);\\n});\"\n          }\n        },\n        \"inputs\": {\n          \"input\": [\n            {\n              \"type\": \"ai_tool\",\n              \"required\": true\n            }\n          ]\n        },\n        \"outputs\": {\n          \"output\": [\n            {\n              \"type\": \"ai_tool\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"f791deb0-9ebe-4451-8a1f-3119547dd576\",\n      \"name\": \"list_granted_roles\",\n      \"type\": \"@n8n/n8n-nodes-langchain.toolCode\",\n      \"position\": [\n        1000,\n        460\n      ],\n      \"parameters\": {\n        \"name\": \"list_granted_roles\",\n        \"jsCode\": \"// Example: convert the incoming query to uppercase and return it\\nreturn \\\"You are assigned the following roles: \\\" + $input.item.json.granted_roles.join(\\\", \\\");\",\n        \"description\": \"Call this tool to tell the user which roles they have been granted.\"\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"ab0c6dae-6259-4be1-b0df-e3276cafb938\",\n      \"name\": \"list_allowed_tools\",\n      \"type\": \"@n8n/n8n-nodes-langchain.toolCode\",\n      \"position\": [\n        1160,\n        460\n      ],\n      \"parameters\": {\n        \"name\": \"list_allowed_tools\",\n        \"jsCode\": \"return \\\"You have access to the following tools: \\\" + $input.item.json.allowed_tools.join(\\\", \\\");\",\n        \"description\": \"Call this tool to tell the user which tools they have access to.\"\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"76529936-80ea-4f94-9a06-bae3b6ea0ce3\",\n      \"name\": \"calculator\",\n      \"type\": \"@n8n/n8n-nodes-langchain.toolCalculator\",\n      \"position\": [\n        860,\n        460\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"fd7f4875-6838-4b53-9167-4a22d4f5f27f\",\n      \"name\": \"Wikipedia\",\n      \"type\": \"@n8n/n8n-nodes-langchain.toolWikipedia\",\n      \"position\": [\n        760,\n        260\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"0dc5c3e6-b9d2-4a96-9539-dae86dc171a6\",\n      \"name\": \"get_coordinates\",\n      \"type\": \"@n8n/n8n-nodes-langchain.toolHttpRequest\",\n      \"position\": [\n        800,\n        1260\n      ],\n      \"parameters\": {\n        \"url\": \"https://geocoding-api.open-meteo.com/v1/search?name={city}&count=1\",\n        \"fields\": \"name,latitude,longitude\",\n        \"dataField\": \"results\",\n        \"fieldsToInclude\": \"selected\",\n        \"toolDescription\": \"Get the GEO position by city name\",\n        \"optimizeResponse\": true,\n        \"placeholderDefinitions\": {\n          \"values\": [\n            {\n              \"name\": \"city\",\n              \"type\": \"string\",\n              \"description\": \"Name of the city\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"e70a2cb2-832b-4741-85d2-c446be168ad4\",\n      \"name\": \"get_weather\",\n      \"type\": \"@n8n/n8n-nodes-langchain.toolHttpRequest\",\n      \"position\": [\n        980,\n        1260\n      ],\n      \"parameters\": {\n        \"url\": \"https://api.open-meteo.com/v1/forecast?latitude={latitude}&longitude={longitude}&current_weather=true\",\n        \"toolDescription\": \"Get current weather by GEO data (longitude, latitude)\",\n        \"placeholderDefinitions\": {\n          \"values\": [\n            {\n              \"name\": \"longitude\",\n              \"type\": \"string\",\n              \"description\": \"Longitude of location. Dot as decimal separator.\"\n            },\n            {\n              \"name\": \"latitude\",\n              \"type\": \"string\",\n              \"description\": \"Latitude of location. Dot as decimal separator.\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"66c5568d-d2fe-4938-b577-b005a5c32e37\",\n      \"name\": \"weather_agent\",\n      \"type\": \"@n8n/n8n-nodes-langchain.toolWorkflow\",\n      \"position\": [\n        1360,\n        460\n      ],\n      \"parameters\": {\n        \"name\": \"weather_agent\",\n        \"workflowId\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"C1fIIooUO64D56t6\",\n          \"cachedResultName\": \"Agent Access Control with Airtable and Telegram\"\n        },\n        \"workflowInputs\": {\n          \"value\": {\n            \"chatInput\": \"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('chatInput', ``, 'string') }}\",\n            \"sessionId\": \"={{ $('Telegram Trigger').item.json.message.from.id }}\",\n            \"allowed_tools\": \"={{ $input.item.json.allowed_tools }}\"\n          },\n          \"schema\": [\n            {\n              \"id\": \"sessionId\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"sessionId\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"chatInput\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"chatInput\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"allowed_tools\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"allowed_tools\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            }\n          ],\n          \"mappingMode\": \"defineBelow\",\n          \"matchingColumns\": [],\n          \"attemptToConvertTypes\": false,\n          \"convertFieldsToString\": false\n        }\n      },\n      \"typeVersion\": 2.1\n    },\n    {\n      \"id\": \"ffcf4df4-f969-4bc1-9393-0e7a4317626a\",\n      \"name\": \"Weather Agent\",\n      \"type\": \"@n8n/n8n-nodes-langchain.agent\",\n      \"position\": [\n        440,\n        800\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"systemMessage\": \"=You are a weather data assistant.\\nYou MUST only use the provided tools to process any user input. Never use general knowledge to answer questions. If you can't use a tool, tell the user why.\"\n        }\n      },\n      \"typeVersion\": 1.8\n    },\n    {\n      \"id\": \"eae759d7-fa4a-4993-bbcf-cc430f2dfa60\",\n      \"name\": \"Unknown user\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        200,\n        -120\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"conditions\": {\n          \"options\": {\n            \"version\": 2,\n            \"leftValue\": \"\",\n            \"caseSensitive\": true,\n            \"typeValidation\": \"strict\"\n          },\n          \"combinator\": \"and\",\n          \"conditions\": [\n            {\n              \"id\": \"1d042f5b-ef39-4b9e-8d9c-900b39dbe3fb\",\n              \"operator\": {\n                \"type\": \"object\",\n                \"operation\": \"empty\",\n                \"singleValue\": true\n              },\n              \"leftValue\": \"={{ $json }}\",\n              \"rightValue\": \"\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 2.2\n    },\n    {\n      \"id\": \"df377324-d57d-45ab-85c7-88446a07abcd\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -80,\n        -260\n      ],\n      \"parameters\": {\n        \"width\": 220,\n        \"height\": 300,\n        \"content\": \"## 选择基础模板  \\n将[此Airtable模板](https://airtable.com/appi5nijuvzQbZLJJ/shr8OkLysG1VtlCiz)复制到您的工作区，并在此处选择该基础模板\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b1ddd130-07fa-47e3-ba24-7b4e85f94b6a\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1280,\n        300\n      ],\n      \"parameters\": {\n        \"height\": 300,\n        \"content\": \"## 选择工作流\\n将当前工作流选为应调用的工作流\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"7d24fc8e-36e7-4087-88cc-7f1c725ce814\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        900,\n        160\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 380,\n        \"height\": 220,\n        \"content\": \"利用从Airtable收集的允许工具列表进行权限检查，并将被拒绝的工具替换为固定指令，以向用户返回提示信息。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"987b3372-1703-4284-a285-d2edfd032422\",\n      \"name\": \"Sticky Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        700,\n        160\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 200,\n        \"height\": 220,\n        \"content\": \"工具也可以不经权限检查直接连接\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"885b0117-bae1-4aac-a91f-e140259b32e2\",\n      \"name\": \"Sticky Note4\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        580,\n        -80\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 380,\n        \"height\": 240,\n        \"content\": \"主要代理，指令要求始终使用连接的辅助工具而非通用知识\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"25f17f39-a777-4386-b14d-1ed7db3c54f4\",\n      \"name\": \"Sticky Note5\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        360,\n        -80\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 220,\n        \"height\": 240,\n        \"content\": \"收集输入并使用所需键格式化\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"a0abbeea-d9c1-4005-b996-d4e8e4fd97d3\",\n      \"name\": \"Sticky Note7\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        160,\n        720\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 220,\n        \"height\": 240,\n        \"content\": \"收集并格式化来自父工作流/代理的输入\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"8e25e640-7b6d-4ca7-b3fd-06eac3cebbea\",\n      \"name\": \"Sticky Note8\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        680,\n        960\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 380,\n        \"height\": 220,\n        \"content\": \"采用与主代理相同的技术，使用传递给该子代理的相同参数来检查权限。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"1168726e-2a39-40f6-aea6-77c12dc2b37b\",\n      \"name\": \"Sticky Note9\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        380,\n        720\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 380,\n        \"height\": 240,\n        \"content\": \"具有特定角色以处理天气信息的子代理，并严格遵循仅使用已连接工具的指令。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"e65e1ea3-c773-4e65-8c49-b9f7fe75df28\",\n      \"name\": \"Reply: unknown user\",\n      \"type\": \"n8n-nodes-base.telegram\",\n      \"position\": [\n        420,\n        -240\n      ],\n      \"webhookId\": \"510028ef-060f-4ce7-898e-f1a2a376780c\",\n      \"parameters\": {\n        \"text\": \"=Unknown user '{{ $('Telegram Trigger').item.json.message.from.username }}'. Please contact your supervisor.\",\n        \"chatId\": \"={{ $('Telegram Trigger').item.json.message.chat.id }}\",\n        \"additionalFields\": {\n          \"appendAttribution\": false\n        }\n      },\n      \"credentials\": {\n        \"telegramApi\": {\n          \"id\": \"3paV9xW2WWlusvsq\",\n          \"name\": \"octionictest_bot\"\n        }\n      },\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"aa5937b9-22d2-4719-9d51-00f7d28beb43\",\n      \"name\": \"Reply with results\",\n      \"type\": \"n8n-nodes-base.telegram\",\n      \"position\": [\n        1020,\n        0\n      ],\n      \"webhookId\": \"97bc8ca7-d40a-41d6-9cc2-4c9943313fb4\",\n      \"parameters\": {\n        \"text\": \"={{ $json.output }}\",\n        \"chatId\": \"={{ $('Telegram Trigger').item.json.message.chat.id }}\",\n        \"additionalFields\": {\n          \"appendAttribution\": false\n        }\n      },\n      \"credentials\": {\n        \"telegramApi\": {\n          \"id\": \"3paV9xW2WWlusvsq\",\n          \"name\": \"octionictest_bot\"\n        }\n      },\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"623328d8-e9ad-431e-b3ca-df0cdbcb7430\",\n      \"name\": \"Main Agent\",\n      \"type\": \"@n8n/n8n-nodes-langchain.agent\",\n      \"position\": [\n        640,\n        0\n      ],\n      \"parameters\": {\n        \"text\": \"={{ $('Telegram Trigger').item.json.message.text }}\",\n        \"options\": {\n          \"systemMessage\": \"=You are a personal assistant. The name of the current user is \\\"{{ $json.name }}\\\"\\nYou MUST only use the provided tools to process any user input. Never use general knowledge to answer questions. If you can't use a tool, tell the user why.\",\n          \"returnIntermediateSteps\": true\n        },\n        \"promptType\": \"define\"\n      },\n      \"typeVersion\": 1.8\n    },\n    {\n      \"id\": \"cacefd8b-082c-43a4-9e25-fb497d0d8dd9\",\n      \"name\": \"Sticky Note6\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        500,\n        160\n      ],\n      \"parameters\": {\n        \"color\": 6,\n        \"width\": 200,\n        \"height\": 220,\n        \"content\": \"请注意，权限变更后之前的回复可能仍然存在。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"802ba649-b56e-4e90-a780-a3a1935a7907\",\n      \"name\": \"Sticky Note10\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        480,\n        960\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 200,\n        \"height\": 220,\n        \"content\": \"使用不同的会话ID（后缀），因为每个代理都需要自己的记忆空间。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b82c9149-e583-4c98-a6d8-c92080fd44ba\",\n      \"name\": \"Sticky Note11\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -300,\n        -200\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 220,\n        \"height\": 240,\n        \"content\": \"直接听取发送给机器人的消息\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b74fcbc1-aa66-440a-9a75-340858bba6c5\",\n      \"name\": \"Sticky Note12\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        140,\n        -200\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 220,\n        \"height\": 240,\n        \"content\": \"检查用户是否在Airtable中被找到\"\n      },\n      \"typeVersion\": 1\n    }\n  ],\n  \"active\": false,\n  \"pinData\": {},\n  \"settings\": {\n    \"errorWorkflow\": \"gGHnVxFBZDQlm6QE\",\n    \"executionOrder\": \"v1\"\n  },\n  \"versionId\": \"08372ec4-0f43-411a-b600-61e8d80da545\",\n  \"connections\": {\n    \"Settings\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Weather Agent\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Set input\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Main Agent\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Wikipedia\": {\n      \"ai_tool\": [\n        [\n          {\n            \"node\": \"Main Agent\",\n            \"type\": \"ai_tool\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Main Agent\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Reply with results\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"calculator\": {\n      \"ai_tool\": [\n        [\n          {\n            \"node\": \"Check permissions\",\n            \"type\": \"ai_tool\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"get_weather\": {\n      \"ai_tool\": [\n        [\n          {\n            \"node\": \"Check permissions1\",\n            \"type\": \"ai_tool\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Unknown user\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Reply: unknown user\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Set input\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Simple Memory\": {\n      \"ai_memory\": [\n        [\n          {\n            \"node\": \"Main Agent\",\n            \"type\": \"ai_memory\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"weather_agent\": {\n      \"ai_tool\": [\n        [\n          {\n            \"node\": \"Check permissions\",\n            \"type\": \"ai_tool\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Simple Memory1\": {\n      \"ai_memory\": [\n        [\n          {\n            \"node\": \"Weather Agent\",\n            \"type\": \"ai_memory\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"get_coordinates\": {\n      \"ai_tool\": [\n        [\n          {\n            \"node\": \"Check permissions1\",\n            \"type\": \"ai_tool\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Telegram Trigger\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get user permissions\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Check permissions\": {\n      \"ai_tool\": [\n        [\n          {\n            \"node\": \"Main Agent\",\n            \"type\": \"ai_tool\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"OpenAI Chat Model\": {\n      \"ai_languageModel\": [\n        [\n          {\n            \"node\": \"Main Agent\",\n            \"type\": \"ai_languageModel\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Check permissions1\": {\n      \"ai_tool\": [\n        [\n          {\n            \"node\": \"Weather Agent\",\n            \"type\": \"ai_tool\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"OpenAI Chat Model1\": {\n      \"ai_languageModel\": [\n        [\n          {\n            \"node\": \"Weather Agent\",\n            \"type\": \"ai_languageModel\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"list_allowed_tools\": {\n      \"ai_tool\": [\n        [\n          {\n            \"node\": \"Check permissions\",\n            \"type\": \"ai_tool\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"list_granted_roles\": {\n      \"ai_tool\": [\n        [\n          {\n            \"node\": \"Check permissions\",\n            \"type\": \"ai_tool\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get user permissions\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Unknown user\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"When Executed by Another Workflow\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Settings\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}"
}