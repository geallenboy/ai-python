{
  "url": "https://n8n.io/workflows/3762-gmail-to-vector-embeddings-with-pgvector-and-ollama/",
  "title": "Gmail to Vector Embeddings with PGVector and Ollama",
  "author": "Alfonso Corretti",
  "publish_date": "Last update 20 days ago",
  "publish_date_absolute": "2025-05-06",
  "categories": [
    {
      "name": "Support"
    },
    {
      "name": "IT Ops"
    }
  ],
  "workflow_json": "{\"id\":\"ZiIoKEClTk83g1Jt\",\"meta\":{\"instanceId\":\"8a3ba313628b26e4e4cf0504ff23322f235d6b433d92e59bcf8762764730ed80\",\"templateCredsSetupCompleted\":true},\"name\":\"Gmail to Vector Embeddings with PGVector and Ollama\",\"tags\":[],\"nodes\":[{\"id\":\"162b1a8b-2471-4880-9fcb-7f2dcfe175a8\",\"name\":\"Embeddings Ollama\",\"type\":\"@n8n/n8n-nodes-langchain.embeddingsOllama\",\"position\":[1920,-100],\"parameters\":{\"model\":\"nomic-embed-text:latest\"},\"credentials\":{},\"typeVersion\":1},{\"id\":\"49eb04b0-3b54-499c-ba46-3251102a4017\",\"name\":\"Default Data Loader\",\"type\":\"@n8n/n8n-nodes-langchain.documentDefaultDataLoader\",\"position\":[2040,-97.5],\"parameters\":{\"options\":{\"metadata\":{\"metadataValues\":[{\"name\":\"emails_metadata.id\",\"value\":\"={{ $('Extract email fields').item.json.email_id }}\"},{\"name\":\"emails_metadata.thread_id\",\"value\":\"={{ $('Extract email fields').item.json.thread_id }}\"}]}},\"jsonData\":\"={{ $('Extract email fields').item.json.email_text }}\",\"jsonMode\":\"expressionData\"},\"typeVersion\":1},{\"id\":\"b4853472-6ac7-4da5-97b3-b22950ddff06\",\"name\":\"Recursive Character Text Splitter\",\"type\":\"@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter\",\"position\":[2128,100],\"parameters\":{\"options\":{},\"chunkSize\":2000,\"chunkOverlap\":50},\"typeVersion\":1},{\"id\":\"b189f134-f78e-438f-9189-2f2b276b487d\",\"name\":\"Gmail Trigger\",\"type\":\"n8n-nodes-base.gmailTrigger\",\"position\":[1260,280],\"parameters\":{\"simple\":false,\"filters\":{\"labelIds\":[\"INBOX\"]},\"options\":{\"downloadAttachments\":true},\"pollTimes\":{\"item\":[{\"mode\":\"everyMinute\"}]}},\"credentials\":{},\"typeVersion\":1.2},{\"id\":\"81cba4c5-7762-483d-a076-3fa8799f70ce\",\"name\":\"Loop Over Items\",\"type\":\"n8n-nodes-base.splitInBatches\",\"position\":[840,40],\"parameters\":{\"options\":{}},\"typeVersion\":3},{\"id\":\"f82243ad-6efd-4be2-bf4e-5001870ae854\",\"name\":\"Split Out\",\"type\":\"n8n-nodes-base.splitOut\",\"position\":[640,40],\"parameters\":{\"options\":{\"destinationFieldName\":\"after\"},\"fieldToSplitOut\":\"weeks\"},\"typeVersion\":1},{\"id\":\"2163d5ec-416f-4299-8a9d-10c26eaef32f\",\"name\":\"Was manually triggered?\",\"type\":\"n8n-nodes-base.if\",\"position\":[2416,-145],\"parameters\":{\"options\":{},\"conditions\":{\"options\":{\"version\":2,\"leftValue\":\"\",\"caseSensitive\":true,\"typeValidation\":\"strict\"},\"combinator\":\"and\",\"conditions\":[{\"id\":\"3cbc77e7-1796-4e1b-bbff-6391dd131336\",\"operator\":{\"type\":\"boolean\",\"operation\":\"false\",\"singleValue\":true},\"leftValue\":\"={{ $('Manual Trigger').isExecuted }}\",\"rightValue\":\"\"}]}},\"typeVersion\":2.2},{\"id\":\"76557325-c94e-47a9-9384-e6cbea94f67e\",\"name\":\"Manual Trigger\",\"type\":\"n8n-nodes-base.manualTrigger\",\"position\":[0,40],\"parameters\":{},\"typeVersion\":1},{\"id\":\"b9400906-a458-4305-8805-bb6bea17396b\",\"name\":\"No Operation, do nothing\",\"type\":\"n8n-nodes-base.noOp\",\"position\":[2636,-145],\"parameters\":{},\"typeVersion\":1},{\"id\":\"5f0aa7c2-85b3-4585-8c8c-727af27de61c\",\"name\":\"Sticky Note\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[-60,-540],\"parameters\":{\"color\":6,\"width\":1440,\"height\":780,\"content\":\"## Bulk e-mail import\\n\\nPress the `Test workflow` button to run this once, and bulk import of all your e-mail\\n\\n### IMPORTANT\\nSpecify your Gmail account creation date by editing the code node\"},\"typeVersion\":1},{\"id\":\"2b85d362-d40d-49c0-b3a7-27fdbee8e90b\",\"name\":\"Sticky Note1\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[360,-100],\"parameters\":{\"width\":220,\"height\":300,\"content\":\"## Edit this ⬇️\\nAnd specify your Gmail account creation date\"},\"typeVersion\":1},{\"id\":\"05a9dd25-ae36-4e3c-a249-787ee1047bff\",\"name\":\"Sticky Note2\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[740,260],\"parameters\":{\"color\":4,\"width\":640,\"height\":180,\"content\":\"## Activate the workflow\\nAnd this trigger will check for new mail, every minute\"},\"typeVersion\":1},{\"id\":\"3f19abc5-a165-49e8-b97e-233c47949e68\",\"name\":\"Set before and after dates\",\"type\":\"n8n-nodes-base.set\",\"position\":[1040,-320],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"48e8d703-e52a-46cc-bd72-9b0d3352091b\",\"name\":\"after\",\"type\":\"string\",\"value\":\"={{ $json.after }}\"},{\"id\":\"a515cf56-9bc6-4724-a0ef-01a6159606f7\",\"name\":\"before\",\"type\":\"string\",\"value\":\"={{ DateTime.fromISO($json.after).plus(1, 'week').toISODate() }}\"}]}},\"typeVersion\":3.4},{\"id\":\"af742b17-2086-4698-af3a-32cb7260f380\",\"name\":\"Extract email fields\",\"type\":\"n8n-nodes-base.set\",\"position\":[1480,-320],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"f818bad8-b000-499c-b137-de22dff4a343\",\"name\":\"email_text\",\"type\":\"string\",\"value\":\"={{ $json.text }}\"},{\"id\":\"68c16520-4a26-4ea9-95f7-ee89b9f53c4f\",\"name\":\"email_from\",\"type\":\"string\",\"value\":\"={{ $json.from?.text ?? '' }}\"},{\"id\":\"981f1f5b-ba2f-4153-966c-45bb6b535794\",\"name\":\"email_to\",\"type\":\"string\",\"value\":\"={{ $json.to?.text ?? '' }}\"},{\"id\":\"b528dd23-a743-4a55-98df-e1ae823b29b3\",\"name\":\"date\",\"type\":\"string\",\"value\":\"={{ DateTime.fromISO($json.date).toISO() }}\"},{\"id\":\"39081032-e503-470b-8d83-b5064238d037\",\"name\":\"email_id\",\"type\":\"string\",\"value\":\"={{ $json.id }}\"},{\"id\":\"146e8e72-3c2c-4320-b93a-b109d2e46139\",\"name\":\"thread_id\",\"type\":\"string\",\"value\":\"={{ $json.threadId }}\"},{\"id\":\"a49333a5-c565-4d46-8398-d423072b1e4d\",\"name\":\"email_subject\",\"type\":\"string\",\"value\":\"={{ $json.subject }}\"},{\"id\":\"806cf930-450e-4221-8061-a71ec8bf9bbe\",\"name\":\"attachments\",\"type\":\"array\",\"value\":\"={{ Object.keys($binary).map(item => $binary[item].fileName).filter(item => !!item) }}\"},{\"id\":\"30a38aaf-04c2-4286-99c9-8bb60ae8b317\",\"name\":\"email_cc\",\"type\":\"string\",\"value\":\"={{ $json.cc?.text ?? ''}}\"}]}},\"typeVersion\":3.4},{\"id\":\"a51f5d5f-69c7-4153-be7f-492a8694629a\",\"name\":\"Sticky Note3\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1640,-540],\"parameters\":{\"width\":720,\"height\":780,\"content\":\"## Magic here 🪄\\n#### (not really, just statistics)\\nE-mail is stored in a `emails_metadata` structured table, and also fed to the [`nomic-embed-text`](https://ollama.com/library/nomic-embed-text) model to be stored in a `emails_embeddings` table as [vector embeddings](https://www.pinecone.io/learn/vector-embeddings/) so similarity searches are possible.\\n\\nThe `email_id` field can be used to make the relation between the structured records and the vector embeddings, as it's stored in their metadata as `emails_metadata.id`.\\nThis is also the case for `thread_id`.\"},\"typeVersion\":1},{\"id\":\"809e9269-1275-4c87-8c7f-1840c76f5b22\",\"name\":\"Store structured\",\"type\":\"n8n-nodes-base.postgres\",\"onError\":\"continueErrorOutput\",\"position\":[1700,-320],\"parameters\":{\"table\":{\"__rl\":true,\"mode\":\"name\",\"value\":\"emails_metadata\"},\"schema\":{\"__rl\":true,\"mode\":\"list\",\"value\":\"public\"},\"columns\":{\"value\":{},\"schema\":[{\"id\":\"email_id\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":true,\"displayName\":\"email_id\",\"defaultMatch\":false,\"canBeUsedToMatch\":true},{\"id\":\"thread_id\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"thread_id\",\"defaultMatch\":false,\"canBeUsedToMatch\":false},{\"id\":\"email_from\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"email_from\",\"defaultMatch\":false,\"canBeUsedToMatch\":false},{\"id\":\"email_to\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"email_to\",\"defaultMatch\":false,\"canBeUsedToMatch\":false},{\"id\":\"email_cc\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"email_cc\",\"defaultMatch\":false,\"canBeUsedToMatch\":false},{\"id\":\"date\",\"type\":\"dateTime\",\"display\":true,\"removed\":false,\"required\":true,\"displayName\":\"date\",\"defaultMatch\":false,\"canBeUsedToMatch\":false},{\"id\":\"email_subject\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"email_subject\",\"defaultMatch\":false,\"canBeUsedToMatch\":false},{\"id\":\"attachments\",\"type\":\"array\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"attachments\",\"defaultMatch\":false,\"canBeUsedToMatch\":false},{\"id\":\"email_text\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"email_text\",\"defaultMatch\":false,\"canBeUsedToMatch\":false}],\"mappingMode\":\"autoMapInputData\",\"matchingColumns\":[\"email_id\"],\"attemptToConvertTypes\":false,\"convertFieldsToString\":false},\"options\":{\"outputColumns\":[\"*\"]},\"operation\":\"upsert\"},\"credentials\":{},\"typeVersion\":2.6},{\"id\":\"1c3dca79-381c-411b-8727-baa297e1ceda\",\"name\":\"Store vectorized\",\"type\":\"@n8n/n8n-nodes-langchain.vectorStorePGVector\",\"onError\":\"continueRegularOutput\",\"position\":[1936,-320],\"parameters\":{\"mode\":\"insert\",\"options\":{},\"tableName\":\"emails_embeddings\"},\"credentials\":{},\"typeVersion\":1.1},{\"id\":\"3b7e13b2-73e9-42e7-900c-59611fe5af32\",\"name\":\"Create the table\",\"type\":\"n8n-nodes-base.postgres\",\"position\":[200,40],\"parameters\":{\"query\":\"CREATE TABLE IF NOT EXISTS public.emails_metadata (\\n    email_id character varying(64) NOT NULL,\\n    thread_id character varying(64),\\n    email_from text,\\n    email_to text,\\n    email_cc text,\\n    date timestamp with time zone NOT NULL,\\n    email_subject text,\\n    email_text text,\\n    attachments text[]\\n);\\n\",\"options\":{},\"operation\":\"executeQuery\"},\"credentials\":{},\"typeVersion\":2.6},{\"id\":\"19c55312-d1da-4d1e-8637-c5b08a9c1a2d\",\"name\":\"Explode interval into weeks\",\"type\":\"n8n-nodes-base.code\",\"position\":[420,40],\"parameters\":{\"mode\":\"runOnceForEachItem\",\"jsCode\":\"// Edit this\\nlet whenDidICreateMyGmailAccount = DateTime.fromISO('2013-11-01')\\n\\n// (don't edit further down)\\nwhenDidICreateMyGmailAccount = whenDidICreateMyGmailAccount.set({day: 1})\\nlet now = $now.set({day: 1})\\nconst weeks = []\\nwhile (Math.floor(Interval.fromDateTimes(whenDidICreateMyGmailAccount, now).length('weeks')) > -1) {\\n  weeks.push(now.toISODate())\\n  now = now.minus({weeks: 1})\\n}\\n\\nreturn {json: { weeks }};\"},\"typeVersion\":2},{\"id\":\"aed43a77-6d58-41ba-b0b0-fdd3e9fe777a\",\"name\":\"Get a batch of messages\",\"type\":\"n8n-nodes-base.gmail\",\"position\":[1260,-320],\"webhookId\":\"bace3678-df5b-4a9c-a1ef-1c219e3fd07b\",\"parameters\":{\"simple\":false,\"filters\":{\"receivedAfter\":\"={{ $json.after }}\",\"receivedBefore\":\"={{ $json.before }}\"},\"options\":{\"downloadAttachments\":true},\"operation\":\"getAll\",\"returnAll\":true},\"credentials\":{},\"typeVersion\":2.1}],\"active\":false,\"pinData\":{\"Manual Trigger\":[{\"json\":{}}]},\"settings\":{\"executionOrder\":\"v1\"},\"versionId\":\"3c337d42-a3bb-4b71-ac36-deaf0cdf6019\",\"connections\":{\"Split Out\":{\"main\":[[{\"node\":\"Loop Over Items\",\"type\":\"main\",\"index\":0}]]},\"Gmail Trigger\":{\"main\":[[{\"node\":\"Extract email fields\",\"type\":\"main\",\"index\":0}]]},\"Manual Trigger\":{\"main\":[[{\"node\":\"Create the table\",\"type\":\"main\",\"index\":0}]]},\"Loop Over Items\":{\"main\":[[],[{\"node\":\"Set before and after dates\",\"type\":\"main\",\"index\":0}]]},\"Create the table\":{\"main\":[[{\"node\":\"Explode interval into weeks\",\"type\":\"main\",\"index\":0}]]},\"Store structured\":{\"main\":[[{\"node\":\"Store vectorized\",\"type\":\"main\",\"index\":0}],[{\"node\":\"Loop Over Items\",\"type\":\"main\",\"index\":0}]]},\"Store vectorized\":{\"main\":[[{\"node\":\"Was manually triggered?\",\"type\":\"main\",\"index\":0}],[]]},\"Embeddings Ollama\":{\"ai_embedding\":[[{\"node\":\"Store vectorized\",\"type\":\"ai_embedding\",\"index\":0}]]},\"Default Data Loader\":{\"ai_document\":[[{\"node\":\"Store vectorized\",\"type\":\"ai_document\",\"index\":0}]]},\"Extract email fields\":{\"main\":[[{\"node\":\"Store structured\",\"type\":\"main\",\"index\":0}]]},\"Get a batch of messages\":{\"main\":[[{\"node\":\"Extract email fields\",\"type\":\"main\",\"index\":0}]]},\"Was manually triggered?\":{\"main\":[[{\"node\":\"No Operation, do nothing\",\"type\":\"main\",\"index\":0}],[{\"node\":\"Loop Over Items\",\"type\":\"main\",\"index\":0}]]},\"Set before and after dates\":{\"main\":[[{\"node\":\"Get a batch of messages\",\"type\":\"main\",\"index\":0}]]},\"Explode interval into weeks\":{\"main\":[[{\"node\":\"Split Out\",\"type\":\"main\",\"index\":0}]]},\"Recursive Character Text Splitter\":{\"ai_textSplitter\":[[{\"node\":\"Default Data Loader\",\"type\":\"ai_textSplitter\",\"index\":0}]]}}}",
  "readme": "Gmail to Vector Embeddings with PGVector and Ollama\n\n# Who is this for?\n\n**Everyone!** Did you dream of asking an AI \"_what hotel did I stay in for holidays last summer?_ \" or \"_what were my marks last semester like?_ \".\n\nDream no more, as [vector similarity searches](https://www.pinecone.io/learn/vector-embeddings/) and **this workflow** are the foundations to make it possible (as long as the information appears in your e-mails 😅).\n\n## 100% local\n\nThis workflow is designed to use locally-hosted open source. **Ollama** as LLM provider, `nomic-embed-text` as the embeddings model, and **pgvector** as the vector database engine, on top of **Postgres**.\n\n## But.. how?!\n\nFirstly, specify the date you created your Gmail account on, then manually run the workflow in order to bulk read all your e-mail in monthly batches. Your database is now populated!\n\nNow it's the task for other workflows to query the vector database.\n\n**Activate the workflow** so that new e-mail is continuously added by the `Gmail Trigger` upon receiving it.\n\n### Structured AND Vectorized\n\nThis workflow stores your e-mail activity in two ways:\n\n  * In a structured table\n  * In a vector embeddings table\n\n\n\nAnd the information in both of them can be correlated by Gmail's messages `id`, which is stored in the vectors table as metadata property `emails_metadata.id`.\n\nThat way consumers can benefit from both worlds! ✨ Vector similarity searches enable semantic searches, while structured queries can retrieve more factual data like the message `id`, its _date_ or who it came _from_.\n\n### Other useful templates\n\nMy template [Chat with Your Email History using Telegram, Mistral and Pgvector for RAG](https://n8n.io/workflows/3763-chat-with-your-email-history-using-telegram-mistral-and-pgvector-for-rag/) is a ready-made solution to consume this workflow.\n\nYou may also pair this workflow with my other template to [Email Assistant: Convert Natural Language to SQL Queries with Phi4-mini and PostgreSQL](https://n8n.io/workflows/3761-email-assistant-convert-natural-language-to-sql-queries-with-phi4-mini-and-postgresql/) and you'll enable RAG workflows that use both structured and vectorized databases.\n\n## Customizations\n\nI suppose the e-mail provider could be changed, but then you'd have to identify an alternative `id` field. `Message-ID` would be a more standard option.\n\nThere are a few opinionated choices as to what metadata to store, but those shouldn't need adjustments.\n",
  "crawled_at": "2025-05-26T05:27:47.354011",
  "readme_zh": "Gmail邮件转向量嵌入：基于PGVector与Ollama的实现方案\n\n# 适用人群？\n\n**所有人！** 你是否曾幻想过向AI提问\"_去年夏天度假我住的是哪家酒店？_\" 或 \"_上学期我的成绩怎么样？_\"。\n\n现在无需再幻想，借助[向量相似性搜索](https://www.pinecone.io/learn/vector-embeddings/)和**本工作流**，这一切将成为可能（只要相关信息存在于你的邮件中😅）。\n\n## 100%本地化\n\n本工作流采用全开源本地化方案：**Ollama**作为大语言模型提供方，`nomic-embed-text`作为嵌入模型，**Postgres**数据库搭载**pgvector**向量引擎。\n\n## 实现原理\n\n首先输入你的Gmail账户创建日期，随后手动运行工作流以按月批量读取所有历史邮件。至此数据库已完成初始化！\n\n后续查询任务将由其他工作流通过向量数据库完成。\n\n**激活工作流**后，`Gmail触发器`将在收到新邮件时持续更新数据库。\n\n### 结构化+向量化双存储\n\n本工作流采用两种方式存储邮件数据：\n  * 结构化数据表\n  * 向量嵌入表\n\n两套系统通过Gmail消息`id`实现关联（该ID以元数据属性`emails_metadata.id`形式存储在向量表中）。\n\n这种设计让使用者能同时享受两种技术的优势！✨ 向量相似性搜索支持语义查询，而结构化查询可获取消息`id`、收发日期、联系人等客观数据。\n\n### 配套模板推荐\n\n即将发布的《基于Telegram和Pgvector的邮件聊天机器人（支持语义+结构化RAG）》模板可直接对接本工作流。\n\n也可搭配另一个开发中的《将邮件查询转换为SQL语句并执行》模板，构建同时调用结构化与向量化数据库的RAG工作流。\n\n## 自定义选项\n\n理论上可更换邮件服务商，但需重新确定替代`id`字段（更通用的`Message-ID`可作为备选）。\n\n现有元数据存储方案包含若干主观设计，但通常无需调整。",
  "title_zh": "Gmail 到向量嵌入：使用 PGVector 和 Ollama 实现",
  "publish_date_zh": "最后更新于6天前",
  "workflow_json_zh": "{\n  \"id\": \"ZiIoKEClTk83g1Jt\",\n  \"meta\": {\n    \"instanceId\": \"8a3ba313628b26e4e4cf0504ff23322f235d6b433d92e59bcf8762764730ed80\",\n    \"templateCredsSetupCompleted\": true\n  },\n  \"name\": \"Gmail to Vector Embeddings with PGVector and Ollama\",\n  \"tags\": [],\n  \"nodes\": [\n    {\n      \"id\": \"162b1a8b-2471-4880-9fcb-7f2dcfe175a8\",\n      \"name\": \"Embeddings Ollama\",\n      \"type\": \"@n8n/n8n-nodes-langchain.embeddingsOllama\",\n      \"position\": [\n        1920,\n        -100\n      ],\n      \"parameters\": {\n        \"model\": \"nomic-embed-text:latest\"\n      },\n      \"credentials\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"49eb04b0-3b54-499c-ba46-3251102a4017\",\n      \"name\": \"Default Data Loader\",\n      \"type\": \"@n8n/n8n-nodes-langchain.documentDefaultDataLoader\",\n      \"position\": [\n        2040,\n        -97.5\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"metadata\": {\n            \"metadataValues\": [\n              {\n                \"name\": \"emails_metadata.id\",\n                \"value\": \"={{ $('Extract email fields').item.json.email_id }}\"\n              },\n              {\n                \"name\": \"emails_metadata.thread_id\",\n                \"value\": \"={{ $('Extract email fields').item.json.thread_id }}\"\n              }\n            ]\n          }\n        },\n        \"jsonData\": \"={{ $('Extract email fields').item.json.email_text }}\",\n        \"jsonMode\": \"expressionData\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b4853472-6ac7-4da5-97b3-b22950ddff06\",\n      \"name\": \"Recursive Character Text Splitter\",\n      \"type\": \"@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter\",\n      \"position\": [\n        2128,\n        100\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"chunkSize\": 2000,\n        \"chunkOverlap\": 50\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b189f134-f78e-438f-9189-2f2b276b487d\",\n      \"name\": \"Gmail Trigger\",\n      \"type\": \"n8n-nodes-base.gmailTrigger\",\n      \"position\": [\n        1260,\n        280\n      ],\n      \"parameters\": {\n        \"simple\": false,\n        \"filters\": {\n          \"labelIds\": [\n            \"INBOX\"\n          ]\n        },\n        \"options\": {\n          \"downloadAttachments\": true\n        },\n        \"pollTimes\": {\n          \"item\": [\n            {\n              \"mode\": \"everyMinute\"\n            }\n          ]\n        }\n      },\n      \"credentials\": {},\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"81cba4c5-7762-483d-a076-3fa8799f70ce\",\n      \"name\": \"Loop Over Items\",\n      \"type\": \"n8n-nodes-base.splitInBatches\",\n      \"position\": [\n        840,\n        40\n      ],\n      \"parameters\": {\n        \"options\": {}\n      },\n      \"typeVersion\": 3\n    },\n    {\n      \"id\": \"f82243ad-6efd-4be2-bf4e-5001870ae854\",\n      \"name\": \"Split Out\",\n      \"type\": \"n8n-nodes-base.splitOut\",\n      \"position\": [\n        640,\n        40\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"destinationFieldName\": \"after\"\n        },\n        \"fieldToSplitOut\": \"weeks\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"2163d5ec-416f-4299-8a9d-10c26eaef32f\",\n      \"name\": \"Was manually triggered?\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        2416,\n        -145\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"conditions\": {\n          \"options\": {\n            \"version\": 2,\n            \"leftValue\": \"\",\n            \"caseSensitive\": true,\n            \"typeValidation\": \"strict\"\n          },\n          \"combinator\": \"and\",\n          \"conditions\": [\n            {\n              \"id\": \"3cbc77e7-1796-4e1b-bbff-6391dd131336\",\n              \"operator\": {\n                \"type\": \"boolean\",\n                \"operation\": \"false\",\n                \"singleValue\": true\n              },\n              \"leftValue\": \"={{ $('Manual Trigger').isExecuted }}\",\n              \"rightValue\": \"\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 2.2\n    },\n    {\n      \"id\": \"76557325-c94e-47a9-9384-e6cbea94f67e\",\n      \"name\": \"Manual Trigger\",\n      \"type\": \"n8n-nodes-base.manualTrigger\",\n      \"position\": [\n        0,\n        40\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b9400906-a458-4305-8805-bb6bea17396b\",\n      \"name\": \"No Operation, do nothing\",\n      \"type\": \"n8n-nodes-base.noOp\",\n      \"position\": [\n        2636,\n        -145\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"5f0aa7c2-85b3-4585-8c8c-727af27de61c\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -60,\n        -540\n      ],\n      \"parameters\": {\n        \"color\": 6,\n        \"width\": 1440,\n        \"height\": 780,\n        \"content\": \"## 批量邮件导入\\n\\n点击`测试工作流`按钮运行一次，批量导入所有邮件\\n\\n### 重要提示\\n通过编辑代码节点指定您的Gmail账户创建日期\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"2b85d362-d40d-49c0-b3a7-27fdbee8e90b\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        360,\n        -100\n      ],\n      \"parameters\": {\n        \"width\": 220,\n        \"height\": 300,\n        \"content\": \"## 编辑以下内容 ⬇️\\n并注明您的Gmail账户创建日期\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"05a9dd25-ae36-4e3c-a249-787ee1047bff\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        740,\n        260\n      ],\n      \"parameters\": {\n        \"color\": 4,\n        \"width\": 640,\n        \"height\": 180,\n        \"content\": \"## 激活工作流程\\n该触发器将每分钟检查新邮件\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"3f19abc5-a165-49e8-b97e-233c47949e68\",\n      \"name\": \"Set before and after dates\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        1040,\n        -320\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"48e8d703-e52a-46cc-bd72-9b0d3352091b\",\n              \"name\": \"after\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.after }}\"\n            },\n            {\n              \"id\": \"a515cf56-9bc6-4724-a0ef-01a6159606f7\",\n              \"name\": \"before\",\n              \"type\": \"string\",\n              \"value\": \"={{ DateTime.fromISO($json.after).plus(1, 'week').toISODate() }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"af742b17-2086-4698-af3a-32cb7260f380\",\n      \"name\": \"Extract email fields\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        1480,\n        -320\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"f818bad8-b000-499c-b137-de22dff4a343\",\n              \"name\": \"email_text\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.text }}\"\n            },\n            {\n              \"id\": \"68c16520-4a26-4ea9-95f7-ee89b9f53c4f\",\n              \"name\": \"email_from\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.from?.text ?? '' }}\"\n            },\n            {\n              \"id\": \"981f1f5b-ba2f-4153-966c-45bb6b535794\",\n              \"name\": \"email_to\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.to?.text ?? '' }}\"\n            },\n            {\n              \"id\": \"b528dd23-a743-4a55-98df-e1ae823b29b3\",\n              \"name\": \"date\",\n              \"type\": \"string\",\n              \"value\": \"={{ DateTime.fromISO($json.date).toISO() }}\"\n            },\n            {\n              \"id\": \"39081032-e503-470b-8d83-b5064238d037\",\n              \"name\": \"email_id\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.id }}\"\n            },\n            {\n              \"id\": \"146e8e72-3c2c-4320-b93a-b109d2e46139\",\n              \"name\": \"thread_id\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.threadId }}\"\n            },\n            {\n              \"id\": \"a49333a5-c565-4d46-8398-d423072b1e4d\",\n              \"name\": \"email_subject\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.subject }}\"\n            },\n            {\n              \"id\": \"806cf930-450e-4221-8061-a71ec8bf9bbe\",\n              \"name\": \"attachments\",\n              \"type\": \"array\",\n              \"value\": \"={{ Object.keys($binary).map(item => $binary[item].fileName).filter(item => !!item) }}\"\n            },\n            {\n              \"id\": \"30a38aaf-04c2-4286-99c9-8bb60ae8b317\",\n              \"name\": \"email_cc\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.cc?.text ?? ''}}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"a51f5d5f-69c7-4153-be7f-492a8694629a\",\n      \"name\": \"Sticky Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1640,\n        -540\n      ],\n      \"parameters\": {\n        \"width\": 720,\n        \"height\": 780,\n        \"content\": \"## 这里没有魔法 🪄\\n#### （只是统计学把戏）\\n邮件内容存储在结构化的`emails_metadata`表中，同时会输入到[`nomic-embed-text`](https://ollama.com/library/nomic-embed-text)模型，以[向量嵌入](https://www.pinecone.io/learn/vector-embeddings/)形式存储在`emails_embeddings`表中，从而实现相似性搜索。\\n\\n通过`email_id`字段可以建立结构化记录与向量嵌入之间的关联，因为该字段会以`emails_metadata.id`的形式存储在元数据中。`thread_id`字段同理。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"809e9269-1275-4c87-8c7f-1840c76f5b22\",\n      \"name\": \"Store structured\",\n      \"type\": \"n8n-nodes-base.postgres\",\n      \"onError\": \"continueErrorOutput\",\n      \"position\": [\n        1700,\n        -320\n      ],\n      \"parameters\": {\n        \"table\": {\n          \"__rl\": true,\n          \"mode\": \"name\",\n          \"value\": \"emails_metadata\"\n        },\n        \"schema\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"public\"\n        },\n        \"columns\": {\n          \"value\": {},\n          \"schema\": [\n            {\n              \"id\": \"email_id\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": true,\n              \"displayName\": \"email_id\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": true\n            },\n            {\n              \"id\": \"thread_id\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"thread_id\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            },\n            {\n              \"id\": \"email_from\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"email_from\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            },\n            {\n              \"id\": \"email_to\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"email_to\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            },\n            {\n              \"id\": \"email_cc\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"email_cc\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            },\n            {\n              \"id\": \"date\",\n              \"type\": \"dateTime\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": true,\n              \"displayName\": \"date\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            },\n            {\n              \"id\": \"email_subject\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"email_subject\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            },\n            {\n              \"id\": \"attachments\",\n              \"type\": \"array\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"attachments\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            },\n            {\n              \"id\": \"email_text\",\n              \"type\": \"string\",\n              \"display\": true,\n              \"removed\": false,\n              \"required\": false,\n              \"displayName\": \"email_text\",\n              \"defaultMatch\": false,\n              \"canBeUsedToMatch\": false\n            }\n          ],\n          \"mappingMode\": \"autoMapInputData\",\n          \"matchingColumns\": [\n            \"email_id\"\n          ],\n          \"attemptToConvertTypes\": false,\n          \"convertFieldsToString\": false\n        },\n        \"options\": {\n          \"outputColumns\": [\n            \"*\"\n          ]\n        },\n        \"operation\": \"upsert\"\n      },\n      \"credentials\": {},\n      \"typeVersion\": 2.6\n    },\n    {\n      \"id\": \"1c3dca79-381c-411b-8727-baa297e1ceda\",\n      \"name\": \"Store vectorized\",\n      \"type\": \"@n8n/n8n-nodes-langchain.vectorStorePGVector\",\n      \"onError\": \"continueRegularOutput\",\n      \"position\": [\n        1936,\n        -320\n      ],\n      \"parameters\": {\n        \"mode\": \"insert\",\n        \"options\": {},\n        \"tableName\": \"emails_embeddings\"\n      },\n      \"credentials\": {},\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"3b7e13b2-73e9-42e7-900c-59611fe5af32\",\n      \"name\": \"Create the table\",\n      \"type\": \"n8n-nodes-base.postgres\",\n      \"position\": [\n        200,\n        40\n      ],\n      \"parameters\": {\n        \"query\": \"CREATE TABLE IF NOT EXISTS public.emails_metadata (\\n    email_id character varying(64) NOT NULL,\\n    thread_id character varying(64),\\n    email_from text,\\n    email_to text,\\n    email_cc text,\\n    date timestamp with time zone NOT NULL,\\n    email_subject text,\\n    email_text text,\\n    attachments text[]\\n);\\n\",\n        \"options\": {},\n        \"operation\": \"executeQuery\"\n      },\n      \"credentials\": {},\n      \"typeVersion\": 2.6\n    },\n    {\n      \"id\": \"19c55312-d1da-4d1e-8637-c5b08a9c1a2d\",\n      \"name\": \"Explode interval into weeks\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        420,\n        40\n      ],\n      \"parameters\": {\n        \"mode\": \"runOnceForEachItem\",\n        \"jsCode\": \"// Edit this\\nlet whenDidICreateMyGmailAccount = DateTime.fromISO('2013-11-01')\\n\\n// (don't edit further down)\\nwhenDidICreateMyGmailAccount = whenDidICreateMyGmailAccount.set({day: 1})\\nlet now = $now.set({day: 1})\\nconst weeks = []\\nwhile (Math.floor(Interval.fromDateTimes(whenDidICreateMyGmailAccount, now).length('weeks')) > -1) {\\n  weeks.push(now.toISODate())\\n  now = now.minus({weeks: 1})\\n}\\n\\nreturn {json: { weeks }};\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"aed43a77-6d58-41ba-b0b0-fdd3e9fe777a\",\n      \"name\": \"Get a batch of messages\",\n      \"type\": \"n8n-nodes-base.gmail\",\n      \"position\": [\n        1260,\n        -320\n      ],\n      \"webhookId\": \"bace3678-df5b-4a9c-a1ef-1c219e3fd07b\",\n      \"parameters\": {\n        \"simple\": false,\n        \"filters\": {\n          \"receivedAfter\": \"={{ $json.after }}\",\n          \"receivedBefore\": \"={{ $json.before }}\"\n        },\n        \"options\": {\n          \"downloadAttachments\": true\n        },\n        \"operation\": \"getAll\",\n        \"returnAll\": true\n      },\n      \"credentials\": {},\n      \"typeVersion\": 2.1\n    }\n  ],\n  \"active\": false,\n  \"pinData\": {\n    \"Manual Trigger\": [\n      {\n        \"json\": {}\n      }\n    ]\n  },\n  \"settings\": {\n    \"executionOrder\": \"v1\"\n  },\n  \"versionId\": \"3c337d42-a3bb-4b71-ac36-deaf0cdf6019\",\n  \"connections\": {\n    \"Split Out\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Loop Over Items\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Gmail Trigger\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Extract email fields\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Manual Trigger\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Create the table\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Loop Over Items\": {\n      \"main\": [\n        [],\n        [\n          {\n            \"node\": \"Set before and after dates\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Create the table\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Explode interval into weeks\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Store structured\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Store vectorized\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Loop Over Items\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Store vectorized\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Was manually triggered?\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        []\n      ]\n    },\n    \"Embeddings Ollama\": {\n      \"ai_embedding\": [\n        [\n          {\n            \"node\": \"Store vectorized\",\n            \"type\": \"ai_embedding\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Default Data Loader\": {\n      \"ai_document\": [\n        [\n          {\n            \"node\": \"Store vectorized\",\n            \"type\": \"ai_document\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Extract email fields\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Store structured\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get a batch of messages\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Extract email fields\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Was manually triggered?\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"No Operation, do nothing\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Loop Over Items\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Set before and after dates\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get a batch of messages\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Explode interval into weeks\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Split Out\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Recursive Character Text Splitter\": {\n      \"ai_textSplitter\": [\n        [\n          {\n            \"node\": \"Default Data Loader\",\n            \"type\": \"ai_textSplitter\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}"
}