{
  "url": "https://n8n.io/workflows/2333-recipe-recommendations-with-qdrant-and-mistral/",
  "title": "Recipe Recommendations with Qdrant and Mistral",
  "author": "Jimleuk",
  "publish_date": "Last update 10 months ago",
  "publish_date_absolute": "2024-07-25",
  "categories": [
    {
      "name": "Other"
    },
    {
      "name": "AI"
    }
  ],
  "workflow_json": "{\"meta\":{\"instanceId\":\"26ba763460b97c249b82942b23b6384876dfeb9327513332e743c5f6219c2b8e\"},\"nodes\":[{\"id\":\"1eb82902-a1d6-4eff-82a2-26908a82cea2\",\"name\":\"When clicking \\\"Test workflow\\\"\",\"type\":\"n8n-nodes-base.manualTrigger\",\"position\":[720,320],\"parameters\":{},\"typeVersion\":1},{\"id\":\"e0031fc3-27f1-45d9-910b-4c07dd322115\",\"name\":\"Get This Week's Menu\",\"type\":\"n8n-nodes-base.httpRequest\",\"position\":[992,370],\"parameters\":{\"url\":\"=https://www.hellofresh.co.uk/menus/{{ $now.year }}-W{{ $now.weekNumber }}\",\"options\":{}},\"typeVersion\":4.2},{\"id\":\"2c556cc7-7d4e-4d80-902f-9686e756ed8c\",\"name\":\"Extract Available Courses\",\"type\":\"n8n-nodes-base.code\",\"position\":[992,650],\"parameters\":{\"jsCode\":\"const pageData = JSON.parse($input.first().json.data)\\nreturn pageData.props.pageProps.ssrPayload.courses.slice(0, 10);\"},\"typeVersion\":2},{\"id\":\"90c39db6-6116-4c37-8d48-a6d5e8f8c777\",\"name\":\"Extract Server Data\",\"type\":\"n8n-nodes-base.html\",\"position\":[992,510],\"parameters\":{\"options\":{\"trimValues\":false,\"cleanUpText\":true},\"operation\":\"extractHtmlContent\",\"extractionValues\":{\"values\":[{\"key\":\"data\",\"cssSelector\":\"script#__NEXT_DATA__\"}]}},\"typeVersion\":1.2},{\"id\":\"fbd4ed97-0154-4991-bf16-d9c4cb3f4776\",\"name\":\"Get Course Metadata\",\"type\":\"n8n-nodes-base.set\",\"position\":[1172,370],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"3c90fd1e-e9ac-49c1-a459-7cff8c87fe8d\",\"name\":\"name\",\"type\":\"string\",\"value\":\"={{ $json.recipe.name }}\"},{\"id\":\"c4f3a5df-346c-4e8d-90ba-a49ed6afdedf\",\"name\":\"cuisines\",\"type\":\"array\",\"value\":\"={{ $json.recipe.cuisines.map(item => item.name) }}\"},{\"id\":\"97917928-0956-497b-bb68-507df1783240\",\"name\":\"category\",\"type\":\"string\",\"value\":\"={{ $json.recipe.category.name }}\"},{\"id\":\"1e84cf1e-7ad7-4888-9606-d3f7a310ce5f\",\"name\":\"tags\",\"type\":\"array\",\"value\":\"={{ $json.recipe.tags.flatMap(tag => tag.preferences) }}\"},{\"id\":\"cf6e2174-e8cb-4935-8303-2f8ed067f510\",\"name\":\"nutrition\",\"type\":\"object\",\"value\":\"={{ $json.recipe.nutrition.reduce((acc,item) => ({ ...acc, [item.name]: item.amount + item.unit }), {}) }}\"},{\"id\":\"25ba3fe6-c2fa-4315-a2cb-112ec7e3620f\",\"name\":\"url\",\"type\":\"string\",\"value\":\"={{ $json.recipe.websiteUrl }}\"},{\"id\":\"8f444fb3-c2ee-4254-b505-440cca3c7b8b\",\"name\":\"id\",\"type\":\"string\",\"value\":\"={{ $json.recipe.id }}\"}]}},\"typeVersion\":3.3},{\"id\":\"5ab1a5fa-adc3-41e0-be6d-f680af301aca\",\"name\":\"Get Recipe\",\"type\":\"n8n-nodes-base.httpRequest\",\"position\":[1172,510],\"parameters\":{\"url\":\"={{ $json.recipe.websiteUrl }}\",\"options\":{}},\"typeVersion\":4.2},{\"id\":\"5014dc62-8320-4968-b9bd-396a517a2b5c\",\"name\":\"Embeddings Mistral Cloud\",\"type\":\"@n8n/n8n-nodes-langchain.embeddingsMistralCloud\",\"position\":[1960,420],\"parameters\":{\"options\":{}},\"credentials\":{\"mistralCloudApi\":{\"id\":\"EIl2QxhXAS9Hkg37\",\"name\":\"Mistral Cloud account\"}},\"typeVersion\":1},{\"id\":\"2a8fad89-f74b-4808-8cb6-97c6b46a53ee\",\"name\":\"Default Data Loader\",\"type\":\"@n8n/n8n-nodes-langchain.documentDefaultDataLoader\",\"position\":[2080,420],\"parameters\":{\"options\":{\"metadata\":{\"metadataValues\":[{\"name\":\"week\",\"value\":\"={{ $json.week }}\"},{\"name\":\"cuisine\",\"value\":\"={{ $json.cuisines }}\"},{\"name\":\"category\",\"value\":\"={{ $json.category }}\"},{\"name\":\"tag\",\"value\":\"={{ $json.tags }}\"},{\"name\":\"recipe_id\",\"value\":\"={{ $json.id }}\"}]}},\"jsonData\":\"={{ $json.data }}\",\"jsonMode\":\"expressionData\"},\"typeVersion\":1},{\"id\":\"44ceef5c-1d08-40d2-8ab4-227b551f72f5\",\"name\":\"Merge Course & Recipe\",\"type\":\"n8n-nodes-base.merge\",\"position\":[1480,500],\"parameters\":{\"mode\":\"combine\",\"options\":{},\"combinationMode\":\"mergeByPosition\"},\"typeVersion\":2.1},{\"id\":\"b56bd85e-f182-49d1-aeb1-062e905c316a\",\"name\":\"Prepare Documents\",\"type\":\"n8n-nodes-base.set\",\"position\":[1660,500],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"462567fe-02ec-4747-ae33-407d2bc6d776\",\"name\":\"data\",\"type\":\"string\",\"value\":\"=# {{ $json.name }}\\n{{ $json.description.replaceAll('\\\\n\\\\n','\\\\n') }}\\n\\n# Website\\n{{ $json.url }}\\n\\n## Ingredients\\n{{ $json.ingredients.replaceAll('\\\\n\\\\n','\\\\n') }}\\n\\n## Utensils\\n{{ $json.utensils }}\\n\\n## Nutrition\\n{{ Object.keys($json.nutrition).map(key => `* ${key}: ${$json.nutrition[key]}`).join('\\\\n') }}\\n\\n## Instructions\\n{{ $json.instructions.replaceAll('\\\\n\\\\n','\\\\n') }}\"},{\"id\":\"5738e420-abfe-4a85-b7ad-541cfc181563\",\"name\":\"cuisine\",\"type\":\"array\",\"value\":\"={{ $json.cuisines }}\"},{\"id\":\"349f46d4-e230-4da8-a118-50227ceb7233\",\"name\":\"category\",\"type\":\"string\",\"value\":\"={{ $json.category }}\"},{\"id\":\"9588b347-4469-4aa5-93a2-e7bf41b4c468\",\"name\":\"tag\",\"type\":\"array\",\"value\":\"={{ $json.tags }}\"},{\"id\":\"7ddab229-fa52-4d27-84e1-83ed47280d29\",\"name\":\"week\",\"type\":\"string\",\"value\":\"={{ $now.year }}-W{{ $now.weekNumber }}\"},{\"id\":\"13163e45-5699-4d25-af3d-4c7910dd2926\",\"name\":\"id\",\"type\":\"string\",\"value\":\"={{ $json.id }}\"},{\"id\":\"a0c5d599-ff2b-420d-9173-2baf9218abc5\",\"name\":\"name\",\"type\":\"string\",\"value\":\"={{ $json.name }}\"}]}},\"typeVersion\":3.3},{\"id\":\"6b800632-f320-4fc3-bd2a-6a062834343d\",\"name\":\"Recursive Character Text Splitter\",\"type\":\"@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter\",\"position\":[2080,560],\"parameters\":{\"options\":{}},\"typeVersion\":1},{\"id\":\"df7f17a2-8b27-4203-a2ff-091aaf6609b8\",\"name\":\"Chat Trigger\",\"type\":\"@n8n/n8n-nodes-langchain.chatTrigger\",\"position\":[2440,360],\"webhookId\":\"745056ec-2d36-4ac3-9c70-6ff0b1055d0a\",\"parameters\":{},\"typeVersion\":1},{\"id\":\"ee38effe-5929-421e-a3c5-b1055a755242\",\"name\":\"Extract Recipe Details\",\"type\":\"n8n-nodes-base.html\",\"position\":[1172,650],\"parameters\":{\"options\":{},\"operation\":\"extractHtmlContent\",\"extractionValues\":{\"values\":[{\"key\":\"description\",\"cssSelector\":\"[data-test-id=\\\"recipe-description\\\"]\"},{\"key\":\"ingredients\",\"cssSelector\":\"[data-test-id=\\\"ingredients-list\\\"]\"},{\"key\":\"utensils\",\"cssSelector\":\"[data-test-id=\\\"utensils\\\"]\"},{\"key\":\"instructions\",\"cssSelector\":\"[data-test-id=\\\"instructions\\\"]\",\"skipSelectors\":\"img,a\"}]}},\"typeVersion\":1.2},{\"id\":\"dede108f-2fde-49cb-8a0e-fa5786c59d4b\",\"name\":\"Qdrant Recommend API\",\"type\":\"@n8n/n8n-nodes-langchain.toolWorkflow\",\"position\":[2840,540],\"parameters\":{\"name\":\"get_recipe_recommendation\",\"fields\":{\"values\":[{\"name\":\"week\",\"stringValue\":\"={{ $now.year }}-W{{ $now.weekNumber }}\"}]},\"schemaType\":\"manual\",\"workflowId\":\"={{ $workflow.id }}\",\"description\":\"Call this tool to get a recipe recommendation. Pass in the following params as a json object:\\n* positives - a description of what the user wants to cook. This could be ingredients, flavours, utensils available, number of diners, type of meal etc.\\n* negatives - a description of what the user wants to avoid in the recipe. This could be flavours to avoid, allergen considerations, conflicts with theme of meal etc.\",\"inputSchema\":\"{\\n\\\"type\\\": \\\"object\\\",\\n\\\"properties\\\": {\\n\\t\\\"positive\\\": {\\n\\t\\t\\\"type\\\": \\\"string\\\",\\n\\t\\t\\\"description\\\": \\\"a description of what the user wants to cook. This could be ingredients, flavours, utensils available, number of diners, type of meal etc.\\\"\\n\\t},\\n   \\\"negative\\\": {\\n    \\\"type\\\": \\\"string\\\",\\n    \\\"description\\\": \\\"a description of what the user wants to avoid in the recipe. This could be flavours to avoid, allergen considerations, conflicts with theme of meal etc.\\\"\\n  }\\n}\\n}\",\"specifyInputSchema\":true},\"typeVersion\":1.1},{\"id\":\"5e703134-4dd9-464b-9ec9-dc6103907a1e\",\"name\":\"Execute Workflow Trigger\",\"type\":\"n8n-nodes-base.executeWorkflowTrigger\",\"position\":[2420,940],\"parameters\":{},\"typeVersion\":1},{\"id\":\"9fb5f4fd-3b38-4a35-8986-d3955754c8d1\",\"name\":\"Mistral Cloud Chat Model\",\"type\":\"@n8n/n8n-nodes-langchain.lmChatMistralCloud\",\"position\":[2660,540],\"parameters\":{\"model\":\"mistral-large-2402\",\"options\":{}},\"credentials\":{\"mistralCloudApi\":{\"id\":\"EIl2QxhXAS9Hkg37\",\"name\":\"Mistral Cloud account\"}},\"typeVersion\":1},{\"id\":\"d38275e6-aede-4f1c-9b05-018f3cf4faab\",\"name\":\"Get Tool Response\",\"type\":\"n8n-nodes-base.set\",\"position\":[3160,940],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"10b55200-4610-4e9b-8be7-d487c6b56a78\",\"name\":\"response\",\"type\":\"string\",\"value\":\"={{ JSON.stringify($json.result) }}\"}]}},\"typeVersion\":3.3},{\"id\":\"dc3ceb2f-3c64-4b42-aeca-ddcdb84abf12\",\"name\":\"Wait for Rate Limits\",\"type\":\"n8n-nodes-base.wait\",\"position\":[2420,1080],\"webhookId\":\"e86d8ae4-3b0d-4c40-9d12-a11d6501a043\",\"parameters\":{\"amount\":1.1},\"typeVersion\":1.1},{\"id\":\"ec36d6f8-c3da-4732-8d56-a092a3358864\",\"name\":\"Get Mistral Embeddings\",\"type\":\"n8n-nodes-base.httpRequest\",\"position\":[2620,940],\"parameters\":{\"url\":\"https://api.mistral.ai/v1/embeddings\",\"method\":\"POST\",\"options\":{},\"sendBody\":true,\"authentication\":\"predefinedCredentialType\",\"bodyParameters\":{\"parameters\":[{\"name\":\"model\",\"value\":\"mistral-embed\"},{\"name\":\"encoding_format\",\"value\":\"float\"},{\"name\":\"input\",\"value\":\"={{ [$json.query.positive, $json.query.negative].compact() }}\"}]},\"nodeCredentialType\":\"mistralCloudApi\"},\"credentials\":{\"mistralCloudApi\":{\"id\":\"EIl2QxhXAS9Hkg37\",\"name\":\"Mistral Cloud account\"}},\"typeVersion\":4.2},{\"id\":\"aebcb860-d25c-4833-9e9d-0297101259c7\",\"name\":\"Use Qdrant Recommend API\",\"type\":\"n8n-nodes-base.httpRequest\",\"position\":[2800,940],\"parameters\":{\"url\":\"=http://qdrant:6333/collections/hello_fresh/points/recommend/groups\",\"method\":\"POST\",\"options\":{},\"sendBody\":true,\"authentication\":\"predefinedCredentialType\",\"bodyParameters\":{\"parameters\":[{\"name\":\"strategy\",\"value\":\"average_vector\"},{\"name\":\"limit\",\"value\":\"={{ 3 }}\"},{\"name\":\"positive\",\"value\":\"={{ [$json.data[0].embedding] }}\"},{\"name\":\"negative\",\"value\":\"={{ [$json.data[1].embedding] }}\"},{\"name\":\"filter\",\"value\":\"={{ { \\\"must\\\": {\\\"key\\\": \\\"metadata.week\\\", \\\"match\\\": { \\\"value\\\": $('Execute Workflow Trigger').item.json.week } } } }}\"},{\"name\":\"with_payload\",\"value\":\"={{ true }}\"},{\"name\":\"group_by\",\"value\":\"metadata.recipe_id\"},{\"name\":\"group_size\",\"value\":\"={{ 3 }}\"}]},\"nodeCredentialType\":\"qdrantApi\"},\"credentials\":{\"qdrantApi\":{\"id\":\"NyinAS3Pgfik66w5\",\"name\":\"QdrantApi account\"}},\"typeVersion\":4.2},{\"id\":\"2474c97d-0d85-4acc-a95e-2eb6494786dc\",\"name\":\"Get Recipes From DB\",\"type\":\"n8n-nodes-base.code\",\"position\":[2980,940],\"parameters\":{\"language\":\"python\",\"pythonCode\":\"import sqlite3\\ncon = sqlite3.connect(\\\"hello_fresh_1.db\\\")\\n\\nrecipe_ids = list(set([group.id for group in _input.all()[0].json.result.groups if group.hits[0].score > 0.5]))\\nplaceholders = ','.join(['?' for i in range(0,len(recipe_ids))])\\n\\ncur = con.cursor()\\nres = cur.execute(f'SELECT * FROM recipes WHERE id IN ({placeholders})', recipe_ids)\\nrows = res.fetchall()\\n\\ncon.close()\\n\\nreturn [{ \\\"result\\\": [row[2] for row in rows] }]\"},\"typeVersion\":2},{\"id\":\"54229c2a-6e26-4350-8a94-57f415ef2340\",\"name\":\"Save Recipes to DB\",\"type\":\"n8n-nodes-base.code\",\"position\":[1960,940],\"parameters\":{\"language\":\"python\",\"pythonCode\":\"import sqlite3\\ncon = sqlite3.connect(\\\"hello_fresh_1.db\\\")\\n\\ncur = con.cursor()\\ncur.execute(\\\"CREATE TABLE IF NOT EXISTS recipes (id TEXT PRIMARY KEY, name TEXT, data TEXT, cuisine TEXT, category TEXT, tag TEXT, week TEXT);\\\")\\n\\nfor item in _input.all():\\n  cur.execute('INSERT OR REPLACE INTO recipes VALUES(?,?,?,?,?,?,?)', (\\n    item.json.id,\\n    item.json.name,\\n    item.json.data,\\n    ','.join(item.json.cuisine),\\n    item.json.category,\\n    ','.join(item.json.tag),\\n    item.json.week\\n  ))\\n\\ncon.commit()\\ncon.close()\\n\\nreturn [{ \\\"affected_rows\\\": len(_input.all()) }]\"},\"typeVersion\":2},{\"id\":\"725c1f56-5373-4891-92b9-3f32dd28892b\",\"name\":\"Sticky Note\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[901.1666225087287,180.99920515712074],\"parameters\":{\"color\":7,\"width\":484.12381677448207,\"height\":674.1153489831718,\"content\":\"## Step 1. Fetch Available Courses For the Current Week\\n\\nTo populate our vectorstore, we'll scrape the weekly menu off the HelloFresh Website. The pages are quite large so may take a while so please be patient.\"},\"typeVersion\":1},{\"id\":\"f4e882b8-3762-4e6b-9e95-b0d708d0c284\",\"name\":\"Sticky Note1\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1420,300],\"parameters\":{\"color\":7,\"width\":409.1756468632768,\"height\":398.81415970574335,\"content\":\"## Step 2. Create Recipe Documents For VectorStore\\n\\nTo populate our vectorstore, we'll scrape the weekly menu off the HelloFresh Website. The pages are quite large so may take a while so please be patient.\"},\"typeVersion\":1},{\"id\":\"fc3c2221-b67c-451c-9096-d6acd2a297fa\",\"name\":\"Sticky Note2\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1860,19.326425127730317],\"parameters\":{\"color\":7,\"width\":486.02284096214964,\"height\":690.7816167755491,\"content\":\"## Step 3. Vectorise Recipes For Recommendation Engine\\n[Read more about Qdrant node](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.vectorstoreqdrant)\\n\\nWe'll store our documents in our Qdrant vectorstore by converting to vectors using Mistral Embed. Our goal is to a build a recommendation engine for meals of the week which Qdrant is a perfect solution.\"},\"typeVersion\":1},{\"id\":\"43296173-b929-46cc-b6ea-58007837b8df\",\"name\":\"Sticky Note3\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1740,740],\"parameters\":{\"color\":7,\"width\":547.0098868353456,\"height\":347.6002738958705,\"content\":\"## Step 4. Save Original Document to Database\\n[Read more about Code Node](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.code)\\n\\nFinally, let's have the original document stored in a more traditional datastore. USually our vectorsearch will return partial docs and those are enough for many use-cases, however in this instance we'll pull the full docs for the Agent get the info required to make the recommendation. \"},\"typeVersion\":1},{\"id\":\"6e2e58d2-e0ad-4503-8ed6-891124c8035b\",\"name\":\"Sticky Note4\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[2380,160],\"parameters\":{\"color\":7,\"width\":673.6008766895472,\"height\":552.9202706743265,\"content\":\"## 5. Chat with Our HelloFresh Recommendation AI Agent\\n[Read more about AI Agents](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.agent)\\n\\nThis agent is designed to recommend HelloFresh recipes based on your current taste preferences. Need something hot and spicy, warm and comforting or fast and chilled? This agent will capture what you would like and not like and queries our Recipe Recommendation engine powered by Qdrant Vectorstore.\"},\"typeVersion\":1},{\"id\":\"ba692c21-38bc-48a1-8b40-bad298be8b9e\",\"name\":\"AI Agent\",\"type\":\"@n8n/n8n-nodes-langchain.agent\",\"position\":[2660,360],\"parameters\":{\"options\":{\"systemMessage\":\"=You are a recipe bot for the company, \\\"Hello fresh\\\". You will help the user choose which Hello Fresh recipe to choose from this week's menu. The current week is {{ $now.year }}-W{{ $now.weekNumber }}.\\nDo not recommend any recipes other from the current week's menu. If there are no recipes to recommend, please ask the user to visit the website instead https://hellofresh.com.\"}},\"typeVersion\":1.6},{\"id\":\"d7ca0f97-72dc-4f4c-8b46-3ff57b9068a4\",\"name\":\"Sticky Note5\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[2320,740],\"parameters\":{\"color\":7,\"width\":987.4785537889618,\"height\":531.9173034334732,\"content\":\"## 5. Using Qdrant's Recommend API & Grouping Functionality\\n[Read more about Qdrant's Recommend API](https://qdrant.tech/documentation/concepts/explore/?q=recommend)\\n\\nUnlike basic similarity search, Qdrant's Recommend API takes a positive query to match against (eg. Roast Dinner) and a negative query to avoid (eg. Roast Chicken). This feature significantly improves results for a recommendation engine. Additionally, by utilising Qdrant's Grouping feature, we're able to group similar matches from the same recipe - meaning we can ensure unique recipes everytime.\"},\"typeVersion\":1},{\"id\":\"96a294e2-1437-4ded-9973-0999b444c999\",\"name\":\"Sticky Note6\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[440,-40],\"parameters\":{\"width\":432.916474478624,\"height\":542.9295980774649,\"content\":\"## Try it out!\\n### This workflow does the following:\\n* Fetches and stores this week's HelloFresh's menu\\n* Builds the foundation of a recommendation engine by storing the recipes in a Qdrant Vectorstore and SQLite database.\\n* Builds an AI Agent that allows for a chat interface to query for a the week's recipe recommendations.\\n* AI agent uses the Qdrant Recommend API, providing what the user likes/dislikes as the query.\\n* Qdrant returns the results which enable the AI Agent to make the recommendation to the user.\\n\\n### Need Help?\\nJoin the [Discord](https://discord.com/invite/XPKeKXeB7d) or ask in the [Forum](https://community.n8n.io/)!\\n\\nHappy Hacking!\"},\"typeVersion\":1},{\"id\":\"72c98600-f21a-42d4-97be-836b8ef6dc77\",\"name\":\"Qdrant Vector Store\",\"type\":\"@n8n/n8n-nodes-langchain.vectorStoreQdrant\",\"position\":[1960,240],\"parameters\":{\"mode\":\"insert\",\"options\":{},\"qdrantCollection\":{\"__rl\":true,\"mode\":\"list\",\"value\":\"hello_fresh\",\"cachedResultName\":\"hello_fresh\"}},\"credentials\":{\"qdrantApi\":{\"id\":\"NyinAS3Pgfik66w5\",\"name\":\"QdrantApi account\"}},\"typeVersion\":1},{\"id\":\"b7c4b597-ac2b-41d7-8f0f-1cbba25085de\",\"name\":\"Sticky Note7\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1860,-195.8987124522777],\"parameters\":{\"width\":382.47301504497716,\"height\":195.8987124522777,\"content\":\"### 🚨Ensure Qdrant collection exists!\\nYou'll need to run the following command in Qdrant:\\n```\\nPUT collections/hello_fresh\\n{\\n  \\\"vectors\\\": {\\n    \\\"distance\\\": \\\"Cosine\\\",\\n    \\\"size\\\": 1024\\n  }\\n}\\n```\"},\"typeVersion\":1},{\"id\":\"39191834-ecc2-46f0-a31a-0a7e9c47ac5d\",\"name\":\"Sticky Note8\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[2740,920],\"parameters\":{\"width\":213.30551928619226,\"height\":332.38559808882246,\"content\":\"\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n### 🚨Configure Your Qdrant Connection\\n* Be sure to enter your endpoint address\"},\"typeVersion\":1}],\"pinData\":{},\"connections\":{\"Get Recipe\":{\"main\":[[{\"node\":\"Extract Recipe Details\",\"type\":\"main\",\"index\":0}]]},\"Chat Trigger\":{\"main\":[[{\"node\":\"AI Agent\",\"type\":\"main\",\"index\":0}]]},\"Prepare Documents\":{\"main\":[[{\"node\":\"Qdrant Vector Store\",\"type\":\"main\",\"index\":0},{\"node\":\"Save Recipes to DB\",\"type\":\"main\",\"index\":0}]]},\"Default Data Loader\":{\"ai_document\":[[{\"node\":\"Qdrant Vector Store\",\"type\":\"ai_document\",\"index\":0}]]},\"Extract Server Data\":{\"main\":[[{\"node\":\"Extract Available Courses\",\"type\":\"main\",\"index\":0}]]},\"Get Course Metadata\":{\"main\":[[{\"node\":\"Merge Course & Recipe\",\"type\":\"main\",\"index\":0}]]},\"Get Recipes From DB\":{\"main\":[[{\"node\":\"Get Tool Response\",\"type\":\"main\",\"index\":0}]]},\"Get This Week's Menu\":{\"main\":[[{\"node\":\"Extract Server Data\",\"type\":\"main\",\"index\":0}]]},\"Qdrant Recommend API\":{\"ai_tool\":[[{\"node\":\"AI Agent\",\"type\":\"ai_tool\",\"index\":0}]]},\"Wait for Rate Limits\":{\"main\":[[{\"node\":\"Get Mistral Embeddings\",\"type\":\"main\",\"index\":0}]]},\"Merge Course & Recipe\":{\"main\":[[{\"node\":\"Prepare Documents\",\"type\":\"main\",\"index\":0}]]},\"Extract Recipe Details\":{\"main\":[[{\"node\":\"Merge Course & Recipe\",\"type\":\"main\",\"index\":1}]]},\"Get Mistral Embeddings\":{\"main\":[[{\"node\":\"Use Qdrant Recommend API\",\"type\":\"main\",\"index\":0}]]},\"Embeddings Mistral Cloud\":{\"ai_embedding\":[[{\"node\":\"Qdrant Vector Store\",\"type\":\"ai_embedding\",\"index\":0}]]},\"Execute Workflow Trigger\":{\"main\":[[{\"node\":\"Wait for Rate Limits\",\"type\":\"main\",\"index\":0}]]},\"Mistral Cloud Chat Model\":{\"ai_languageModel\":[[{\"node\":\"AI Agent\",\"type\":\"ai_languageModel\",\"index\":0}]]},\"Use Qdrant Recommend API\":{\"main\":[[{\"node\":\"Get Recipes From DB\",\"type\":\"main\",\"index\":0}]]},\"Extract Available Courses\":{\"main\":[[{\"node\":\"Get Course Metadata\",\"type\":\"main\",\"index\":0},{\"node\":\"Get Recipe\",\"type\":\"main\",\"index\":0}]]},\"When clicking \\\"Test workflow\\\"\":{\"main\":[[{\"node\":\"Get This Week's Menu\",\"type\":\"main\",\"index\":0}]]},\"Recursive Character Text Splitter\":{\"ai_textSplitter\":[[{\"node\":\"Default Data Loader\",\"type\":\"ai_textSplitter\",\"index\":0}]]}}}",
  "readme": "This n8n workflow demonstrates creating a recipe recommendation chatbot using the Qdrant vector store recommendation API.\n\nUse this example to build recommendation features in your AI Agents for your users.\n\n## How it works\n\n  * For our recipes, we'll use HelloFresh's weekly course and recipes for data. We'll scrape the website for this data.\n  * Each recipe is split, vectorised and inserted into a Qdrant Collection using Mistral Embeddings\n  * Additionally the whole recipe is stored in a SQLite database for later retrieval.\n  * Our AI Agent is setup to recommend recipes from our Qdrant vector store. However, instead of the default similarity search, we'll use the Recommendation API instead.\n  * Qdrant's Recommendation API allows you to provide a negative prompt; in our case, the user can specify recipes or ingredients to avoid.\n  * The AI Agent is now able to suggest a recipe recommendation better suited for the user and increase customer satisfaction.\n\n\n\n## Requirements\n\n  * Qdrant vector store instance to save the recipes\n  * [Mistral.ai](http://Mistral.ai) account for embeddings and LLM agent\n\n\n\n## Customising the workflow\n\nThis workflow can work for a variety of different audiences. Try different sets of data such as clothes, sports shoes, vehicles or even holidays.\n",
  "crawled_at": "2025-05-25T23:31:21.741225",
  "readme_zh": "此n8n工作流展示了如何利用Qdrant向量数据库推荐API构建一个食谱推荐聊天机器人。\n\n您可参考此示例，在AI智能体中为用户开发推荐功能。\n\n## 实现原理\n\n* 采用HelloFresh平台的每周课程与食谱作为数据源，通过网页抓取获取数据\n* 每条食谱经拆分、向量化后，使用Mistral嵌入模型存入Qdrant集合\n* 完整食谱同时存储于SQLite数据库以备后续检索\n* AI智能体配置为从Qdrant向量库推荐食谱，但采用推荐API而非默认相似性搜索\n* Qdrant推荐API支持负面提示输入，用户可指定需排除的食谱或食材\n* 由此AI智能体能提供更贴合用户需求的食谱推荐，有效提升客户满意度\n\n## 环境要求\n\n* 需部署Qdrant向量数据库实例存储食谱数据\n* 需注册[Mistral.ai](http://Mistral.ai)账号获取嵌入模型及LLM智能体服务\n\n## 定制扩展\n\n本方案适用于多类应用场景，可尝试替换为服装、运动鞋、交通工具或度假行程等不同数据集进行适配。",
  "title_zh": "使用Qdrant与Mistral的食谱推荐",
  "publish_date_zh": "最后更新于10个月前",
  "workflow_json_zh": "{\n  \"meta\": {\n    \"instanceId\": \"26ba763460b97c249b82942b23b6384876dfeb9327513332e743c5f6219c2b8e\"\n  },\n  \"nodes\": [\n    {\n      \"id\": \"1eb82902-a1d6-4eff-82a2-26908a82cea2\",\n      \"name\": \"When clicking \\\"Test workflow\\\"\",\n      \"type\": \"n8n-nodes-base.manualTrigger\",\n      \"position\": [\n        720,\n        320\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"e0031fc3-27f1-45d9-910b-4c07dd322115\",\n      \"name\": \"Get This Week's Menu\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        992,\n        370\n      ],\n      \"parameters\": {\n        \"url\": \"=https://www.hellofresh.co.uk/menus/{{ $now.year }}-W{{ $now.weekNumber }}\",\n        \"options\": {}\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"2c556cc7-7d4e-4d80-902f-9686e756ed8c\",\n      \"name\": \"Extract Available Courses\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        992,\n        650\n      ],\n      \"parameters\": {\n        \"jsCode\": \"const pageData = JSON.parse($input.first().json.data)\\nreturn pageData.props.pageProps.ssrPayload.courses.slice(0, 10);\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"90c39db6-6116-4c37-8d48-a6d5e8f8c777\",\n      \"name\": \"Extract Server Data\",\n      \"type\": \"n8n-nodes-base.html\",\n      \"position\": [\n        992,\n        510\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"trimValues\": false,\n          \"cleanUpText\": true\n        },\n        \"operation\": \"extractHtmlContent\",\n        \"extractionValues\": {\n          \"values\": [\n            {\n              \"key\": \"data\",\n              \"cssSelector\": \"script#__NEXT_DATA__\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"fbd4ed97-0154-4991-bf16-d9c4cb3f4776\",\n      \"name\": \"Get Course Metadata\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        1172,\n        370\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"3c90fd1e-e9ac-49c1-a459-7cff8c87fe8d\",\n              \"name\": \"name\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.recipe.name }}\"\n            },\n            {\n              \"id\": \"c4f3a5df-346c-4e8d-90ba-a49ed6afdedf\",\n              \"name\": \"cuisines\",\n              \"type\": \"array\",\n              \"value\": \"={{ $json.recipe.cuisines.map(item => item.name) }}\"\n            },\n            {\n              \"id\": \"97917928-0956-497b-bb68-507df1783240\",\n              \"name\": \"category\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.recipe.category.name }}\"\n            },\n            {\n              \"id\": \"1e84cf1e-7ad7-4888-9606-d3f7a310ce5f\",\n              \"name\": \"tags\",\n              \"type\": \"array\",\n              \"value\": \"={{ $json.recipe.tags.flatMap(tag => tag.preferences) }}\"\n            },\n            {\n              \"id\": \"cf6e2174-e8cb-4935-8303-2f8ed067f510\",\n              \"name\": \"nutrition\",\n              \"type\": \"object\",\n              \"value\": \"={{ $json.recipe.nutrition.reduce((acc,item) => ({ ...acc, [item.name]: item.amount + item.unit }), {}) }}\"\n            },\n            {\n              \"id\": \"25ba3fe6-c2fa-4315-a2cb-112ec7e3620f\",\n              \"name\": \"url\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.recipe.websiteUrl }}\"\n            },\n            {\n              \"id\": \"8f444fb3-c2ee-4254-b505-440cca3c7b8b\",\n              \"name\": \"id\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.recipe.id }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.3\n    },\n    {\n      \"id\": \"5ab1a5fa-adc3-41e0-be6d-f680af301aca\",\n      \"name\": \"Get Recipe\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        1172,\n        510\n      ],\n      \"parameters\": {\n        \"url\": \"={{ $json.recipe.websiteUrl }}\",\n        \"options\": {}\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"5014dc62-8320-4968-b9bd-396a517a2b5c\",\n      \"name\": \"Embeddings Mistral Cloud\",\n      \"type\": \"@n8n/n8n-nodes-langchain.embeddingsMistralCloud\",\n      \"position\": [\n        1960,\n        420\n      ],\n      \"parameters\": {\n        \"options\": {}\n      },\n      \"credentials\": {\n        \"mistralCloudApi\": {\n          \"id\": \"EIl2QxhXAS9Hkg37\",\n          \"name\": \"Mistral Cloud account\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"2a8fad89-f74b-4808-8cb6-97c6b46a53ee\",\n      \"name\": \"Default Data Loader\",\n      \"type\": \"@n8n/n8n-nodes-langchain.documentDefaultDataLoader\",\n      \"position\": [\n        2080,\n        420\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"metadata\": {\n            \"metadataValues\": [\n              {\n                \"name\": \"week\",\n                \"value\": \"={{ $json.week }}\"\n              },\n              {\n                \"name\": \"cuisine\",\n                \"value\": \"={{ $json.cuisines }}\"\n              },\n              {\n                \"name\": \"category\",\n                \"value\": \"={{ $json.category }}\"\n              },\n              {\n                \"name\": \"tag\",\n                \"value\": \"={{ $json.tags }}\"\n              },\n              {\n                \"name\": \"recipe_id\",\n                \"value\": \"={{ $json.id }}\"\n              }\n            ]\n          }\n        },\n        \"jsonData\": \"={{ $json.data }}\",\n        \"jsonMode\": \"expressionData\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"44ceef5c-1d08-40d2-8ab4-227b551f72f5\",\n      \"name\": \"Merge Course & Recipe\",\n      \"type\": \"n8n-nodes-base.merge\",\n      \"position\": [\n        1480,\n        500\n      ],\n      \"parameters\": {\n        \"mode\": \"combine\",\n        \"options\": {},\n        \"combinationMode\": \"mergeByPosition\"\n      },\n      \"typeVersion\": 2.1\n    },\n    {\n      \"id\": \"b56bd85e-f182-49d1-aeb1-062e905c316a\",\n      \"name\": \"Prepare Documents\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        1660,\n        500\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"462567fe-02ec-4747-ae33-407d2bc6d776\",\n              \"name\": \"data\",\n              \"type\": \"string\",\n              \"value\": \"=# {{ $json.name }}\\n{{ $json.description.replaceAll('\\\\n\\\\n','\\\\n') }}\\n\\n# Website\\n{{ $json.url }}\\n\\n## Ingredients\\n{{ $json.ingredients.replaceAll('\\\\n\\\\n','\\\\n') }}\\n\\n## Utensils\\n{{ $json.utensils }}\\n\\n## Nutrition\\n{{ Object.keys($json.nutrition).map(key => `* ${key}: ${$json.nutrition[key]}`).join('\\\\n') }}\\n\\n## Instructions\\n{{ $json.instructions.replaceAll('\\\\n\\\\n','\\\\n') }}\"\n            },\n            {\n              \"id\": \"5738e420-abfe-4a85-b7ad-541cfc181563\",\n              \"name\": \"cuisine\",\n              \"type\": \"array\",\n              \"value\": \"={{ $json.cuisines }}\"\n            },\n            {\n              \"id\": \"349f46d4-e230-4da8-a118-50227ceb7233\",\n              \"name\": \"category\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.category }}\"\n            },\n            {\n              \"id\": \"9588b347-4469-4aa5-93a2-e7bf41b4c468\",\n              \"name\": \"tag\",\n              \"type\": \"array\",\n              \"value\": \"={{ $json.tags }}\"\n            },\n            {\n              \"id\": \"7ddab229-fa52-4d27-84e1-83ed47280d29\",\n              \"name\": \"week\",\n              \"type\": \"string\",\n              \"value\": \"={{ $now.year }}-W{{ $now.weekNumber }}\"\n            },\n            {\n              \"id\": \"13163e45-5699-4d25-af3d-4c7910dd2926\",\n              \"name\": \"id\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.id }}\"\n            },\n            {\n              \"id\": \"a0c5d599-ff2b-420d-9173-2baf9218abc5\",\n              \"name\": \"name\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.name }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.3\n    },\n    {\n      \"id\": \"6b800632-f320-4fc3-bd2a-6a062834343d\",\n      \"name\": \"Recursive Character Text Splitter\",\n      \"type\": \"@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter\",\n      \"position\": [\n        2080,\n        560\n      ],\n      \"parameters\": {\n        \"options\": {}\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"df7f17a2-8b27-4203-a2ff-091aaf6609b8\",\n      \"name\": \"Chat Trigger\",\n      \"type\": \"@n8n/n8n-nodes-langchain.chatTrigger\",\n      \"position\": [\n        2440,\n        360\n      ],\n      \"webhookId\": \"745056ec-2d36-4ac3-9c70-6ff0b1055d0a\",\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"ee38effe-5929-421e-a3c5-b1055a755242\",\n      \"name\": \"Extract Recipe Details\",\n      \"type\": \"n8n-nodes-base.html\",\n      \"position\": [\n        1172,\n        650\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"operation\": \"extractHtmlContent\",\n        \"extractionValues\": {\n          \"values\": [\n            {\n              \"key\": \"description\",\n              \"cssSelector\": \"[data-test-id=\\\"recipe-description\\\"]\"\n            },\n            {\n              \"key\": \"ingredients\",\n              \"cssSelector\": \"[data-test-id=\\\"ingredients-list\\\"]\"\n            },\n            {\n              \"key\": \"utensils\",\n              \"cssSelector\": \"[data-test-id=\\\"utensils\\\"]\"\n            },\n            {\n              \"key\": \"instructions\",\n              \"cssSelector\": \"[data-test-id=\\\"instructions\\\"]\",\n              \"skipSelectors\": \"img,a\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"dede108f-2fde-49cb-8a0e-fa5786c59d4b\",\n      \"name\": \"Qdrant Recommend API\",\n      \"type\": \"@n8n/n8n-nodes-langchain.toolWorkflow\",\n      \"position\": [\n        2840,\n        540\n      ],\n      \"parameters\": {\n        \"name\": \"get_recipe_recommendation\",\n        \"fields\": {\n          \"values\": [\n            {\n              \"name\": \"week\",\n              \"stringValue\": \"={{ $now.year }}-W{{ $now.weekNumber }}\"\n            }\n          ]\n        },\n        \"schemaType\": \"manual\",\n        \"workflowId\": \"={{ $workflow.id }}\",\n        \"description\": \"Call this tool to get a recipe recommendation. Pass in the following params as a json object:\\n* positives - a description of what the user wants to cook. This could be ingredients, flavours, utensils available, number of diners, type of meal etc.\\n* negatives - a description of what the user wants to avoid in the recipe. This could be flavours to avoid, allergen considerations, conflicts with theme of meal etc.\",\n        \"inputSchema\": \"{\\n\\\"type\\\": \\\"object\\\",\\n\\\"properties\\\": {\\n\\t\\\"positive\\\": {\\n\\t\\t\\\"type\\\": \\\"string\\\",\\n\\t\\t\\\"description\\\": \\\"a description of what the user wants to cook. This could be ingredients, flavours, utensils available, number of diners, type of meal etc.\\\"\\n\\t},\\n   \\\"negative\\\": {\\n    \\\"type\\\": \\\"string\\\",\\n    \\\"description\\\": \\\"a description of what the user wants to avoid in the recipe. This could be flavours to avoid, allergen considerations, conflicts with theme of meal etc.\\\"\\n  }\\n}\\n}\",\n        \"specifyInputSchema\": true\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"5e703134-4dd9-464b-9ec9-dc6103907a1e\",\n      \"name\": \"Execute Workflow Trigger\",\n      \"type\": \"n8n-nodes-base.executeWorkflowTrigger\",\n      \"position\": [\n        2420,\n        940\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"9fb5f4fd-3b38-4a35-8986-d3955754c8d1\",\n      \"name\": \"Mistral Cloud Chat Model\",\n      \"type\": \"@n8n/n8n-nodes-langchain.lmChatMistralCloud\",\n      \"position\": [\n        2660,\n        540\n      ],\n      \"parameters\": {\n        \"model\": \"mistral-large-2402\",\n        \"options\": {}\n      },\n      \"credentials\": {\n        \"mistralCloudApi\": {\n          \"id\": \"EIl2QxhXAS9Hkg37\",\n          \"name\": \"Mistral Cloud account\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"d38275e6-aede-4f1c-9b05-018f3cf4faab\",\n      \"name\": \"Get Tool Response\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        3160,\n        940\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"10b55200-4610-4e9b-8be7-d487c6b56a78\",\n              \"name\": \"response\",\n              \"type\": \"string\",\n              \"value\": \"={{ JSON.stringify($json.result) }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.3\n    },\n    {\n      \"id\": \"dc3ceb2f-3c64-4b42-aeca-ddcdb84abf12\",\n      \"name\": \"Wait for Rate Limits\",\n      \"type\": \"n8n-nodes-base.wait\",\n      \"position\": [\n        2420,\n        1080\n      ],\n      \"webhookId\": \"e86d8ae4-3b0d-4c40-9d12-a11d6501a043\",\n      \"parameters\": {\n        \"amount\": 1.1\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"ec36d6f8-c3da-4732-8d56-a092a3358864\",\n      \"name\": \"Get Mistral Embeddings\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        2620,\n        940\n      ],\n      \"parameters\": {\n        \"url\": \"https://api.mistral.ai/v1/embeddings\",\n        \"method\": \"POST\",\n        \"options\": {},\n        \"sendBody\": true,\n        \"authentication\": \"predefinedCredentialType\",\n        \"bodyParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"model\",\n              \"value\": \"mistral-embed\"\n            },\n            {\n              \"name\": \"encoding_format\",\n              \"value\": \"float\"\n            },\n            {\n              \"name\": \"input\",\n              \"value\": \"={{ [$json.query.positive, $json.query.negative].compact() }}\"\n            }\n          ]\n        },\n        \"nodeCredentialType\": \"mistralCloudApi\"\n      },\n      \"credentials\": {\n        \"mistralCloudApi\": {\n          \"id\": \"EIl2QxhXAS9Hkg37\",\n          \"name\": \"Mistral Cloud account\"\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"aebcb860-d25c-4833-9e9d-0297101259c7\",\n      \"name\": \"Use Qdrant Recommend API\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        2800,\n        940\n      ],\n      \"parameters\": {\n        \"url\": \"=http://qdrant:6333/collections/hello_fresh/points/recommend/groups\",\n        \"method\": \"POST\",\n        \"options\": {},\n        \"sendBody\": true,\n        \"authentication\": \"predefinedCredentialType\",\n        \"bodyParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"strategy\",\n              \"value\": \"average_vector\"\n            },\n            {\n              \"name\": \"limit\",\n              \"value\": \"={{ 3 }}\"\n            },\n            {\n              \"name\": \"positive\",\n              \"value\": \"={{ [$json.data[0].embedding] }}\"\n            },\n            {\n              \"name\": \"negative\",\n              \"value\": \"={{ [$json.data[1].embedding] }}\"\n            },\n            {\n              \"name\": \"filter\",\n              \"value\": \"={{ { \\\"must\\\": {\\\"key\\\": \\\"metadata.week\\\", \\\"match\\\": { \\\"value\\\": $('Execute Workflow Trigger').item.json.week } } } }}\"\n            },\n            {\n              \"name\": \"with_payload\",\n              \"value\": \"={{ true }}\"\n            },\n            {\n              \"name\": \"group_by\",\n              \"value\": \"metadata.recipe_id\"\n            },\n            {\n              \"name\": \"group_size\",\n              \"value\": \"={{ 3 }}\"\n            }\n          ]\n        },\n        \"nodeCredentialType\": \"qdrantApi\"\n      },\n      \"credentials\": {\n        \"qdrantApi\": {\n          \"id\": \"NyinAS3Pgfik66w5\",\n          \"name\": \"QdrantApi account\"\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"2474c97d-0d85-4acc-a95e-2eb6494786dc\",\n      \"name\": \"Get Recipes From DB\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        2980,\n        940\n      ],\n      \"parameters\": {\n        \"language\": \"python\",\n        \"pythonCode\": \"import sqlite3\\ncon = sqlite3.connect(\\\"hello_fresh_1.db\\\")\\n\\nrecipe_ids = list(set([group.id for group in _input.all()[0].json.result.groups if group.hits[0].score > 0.5]))\\nplaceholders = ','.join(['?' for i in range(0,len(recipe_ids))])\\n\\ncur = con.cursor()\\nres = cur.execute(f'SELECT * FROM recipes WHERE id IN ({placeholders})', recipe_ids)\\nrows = res.fetchall()\\n\\ncon.close()\\n\\nreturn [{ \\\"result\\\": [row[2] for row in rows] }]\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"54229c2a-6e26-4350-8a94-57f415ef2340\",\n      \"name\": \"Save Recipes to DB\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        1960,\n        940\n      ],\n      \"parameters\": {\n        \"language\": \"python\",\n        \"pythonCode\": \"import sqlite3\\ncon = sqlite3.connect(\\\"hello_fresh_1.db\\\")\\n\\ncur = con.cursor()\\ncur.execute(\\\"CREATE TABLE IF NOT EXISTS recipes (id TEXT PRIMARY KEY, name TEXT, data TEXT, cuisine TEXT, category TEXT, tag TEXT, week TEXT);\\\")\\n\\nfor item in _input.all():\\n  cur.execute('INSERT OR REPLACE INTO recipes VALUES(?,?,?,?,?,?,?)', (\\n    item.json.id,\\n    item.json.name,\\n    item.json.data,\\n    ','.join(item.json.cuisine),\\n    item.json.category,\\n    ','.join(item.json.tag),\\n    item.json.week\\n  ))\\n\\ncon.commit()\\ncon.close()\\n\\nreturn [{ \\\"affected_rows\\\": len(_input.all()) }]\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"725c1f56-5373-4891-92b9-3f32dd28892b\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        901.1666225087287,\n        180.99920515712074\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 484.12381677448207,\n        \"height\": 674.1153489831718,\n        \"content\": \"## 第一步：获取本周可选课程\\n\\n为了填充我们的向量数据库，我们将从HelloFresh官网抓取每周菜单页面。由于网页内容较大，加载可能需要一些时间，请耐心等待。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"f4e882b8-3762-4e6b-9e95-b0d708d0c284\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1420,\n        300\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 409.1756468632768,\n        \"height\": 398.81415970574335,\n        \"content\": \"## 第二步：为向量数据库创建食谱文档\\n\\n我们将从HelloFresh网站上抓取每周菜单内容来填充向量数据库。由于网页数据量较大，处理可能需要一些时间，请耐心等待。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"fc3c2221-b67c-451c-9096-d6acd2a297fa\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1860,\n        19.326425127730317\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 486.02284096214964,\n        \"height\": 690.7816167755491,\n        \"content\": \"## 第三步：为推荐引擎向量化食谱\\n[详细了解Qdrant节点](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.vectorstoreqdrant)\\n\\n我们将通过Mistral Embed将文档转化为向量，存储至Qdrant向量数据库。目标是构建一周膳食推荐引擎，Qdrant正是实现这一目标的理想解决方案。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"43296173-b929-46cc-b6ea-58007837b8df\",\n      \"name\": \"Sticky Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1740,\n        740\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 547.0098868353456,\n        \"height\": 347.6002738958705,\n        \"content\": \"## 第四步：将原始文档保存至数据库\\n[详细了解代码节点](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.code)\\n\\n最后，我们需要将原始文档存储到更传统的数据存储系统中。通常向量搜索返回的文档片段已能满足多数场景需求，但本例中我们将调取完整文档，供智能体获取生成推荐所需的完整信息。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"6e2e58d2-e0ad-4503-8ed6-891124c8035b\",\n      \"name\": \"Sticky Note4\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        2380,\n        160\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 673.6008766895472,\n        \"height\": 552.9202706743265,\n        \"content\": \"## 5. 与我们的HelloFresh推荐AI助手对话\\n[了解更多关于AI助手的信息](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.agent)\\n\\n该助手专为根据您当前的口味偏好推荐HelloFresh食谱而设计。想要热辣刺激、温暖舒心还是快捷冰爽的美食？它能准确捕捉您的饮食喜好，并通过基于Qdrant向量数据库构建的食谱推荐引擎为您精准查询。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"ba692c21-38bc-48a1-8b40-bad298be8b9e\",\n      \"name\": \"AI Agent\",\n      \"type\": \"@n8n/n8n-nodes-langchain.agent\",\n      \"position\": [\n        2660,\n        360\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"systemMessage\": \"=You are a recipe bot for the company, \\\"Hello fresh\\\". You will help the user choose which Hello Fresh recipe to choose from this week's menu. The current week is {{ $now.year }}-W{{ $now.weekNumber }}.\\nDo not recommend any recipes other from the current week's menu. If there are no recipes to recommend, please ask the user to visit the website instead https://hellofresh.com.\"\n        }\n      },\n      \"typeVersion\": 1.6\n    },\n    {\n      \"id\": \"d7ca0f97-72dc-4f4c-8b46-3ff57b9068a4\",\n      \"name\": \"Sticky Note5\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        2320,\n        740\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 987.4785537889618,\n        \"height\": 531.9173034334732,\n        \"content\": \"## 5. 使用Qdrant的推荐API与分组功能\\n[详细了解Qdrant的推荐API](https://qdrant.tech/documentation/concepts/explore/?q=recommend)\\n\\n与基础相似性搜索不同，Qdrant的推荐API采用正向查询匹配（如\\\"烤晚餐\\\"）和反向查询规避（如\\\"烤鸡肉\\\"）机制。这一特性显著提升了推荐引擎的结果质量。此外，通过运用Qdrant的分组功能，我们能够将同一食谱中的相似匹配项归类——这意味着每次都能确保推荐独特的食谱。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"96a294e2-1437-4ded-9973-0999b444c999\",\n      \"name\": \"Sticky Note6\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        440,\n        -40\n      ],\n      \"parameters\": {\n        \"width\": 432.916474478624,\n        \"height\": 542.9295980774649,\n        \"content\": \"## 试试看吧！\\n### 本工作流实现以下功能：\\n* 获取并存储本周HelloFresh的菜单\\n* 通过将食谱存入Qdrant向量数据库和SQLite数据库，构建推荐引擎的基础框架\\n* 开发一个AI智能体，提供聊天界面查询本周食谱推荐\\n* AI智能体调用Qdrant推荐API，以用户喜好/厌恶作为查询条件\\n* Qdrant返回结果，使AI智能体能向用户提供个性化推荐\\n\\n### 需要帮助？\\n加入[Discord讨论群](https://discord.com/invite/XPKeKXeB7d) 或访问[社区论坛](https://community.n8n.io/)提问！\\n\\n祝您探索愉快！\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"72c98600-f21a-42d4-97be-836b8ef6dc77\",\n      \"name\": \"Qdrant Vector Store\",\n      \"type\": \"@n8n/n8n-nodes-langchain.vectorStoreQdrant\",\n      \"position\": [\n        1960,\n        240\n      ],\n      \"parameters\": {\n        \"mode\": \"insert\",\n        \"options\": {},\n        \"qdrantCollection\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"hello_fresh\",\n          \"cachedResultName\": \"hello_fresh\"\n        }\n      },\n      \"credentials\": {\n        \"qdrantApi\": {\n          \"id\": \"NyinAS3Pgfik66w5\",\n          \"name\": \"QdrantApi account\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b7c4b597-ac2b-41d7-8f0f-1cbba25085de\",\n      \"name\": \"Sticky Note7\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1860,\n        -195.8987124522777\n      ],\n      \"parameters\": {\n        \"width\": 382.47301504497716,\n        \"height\": 195.8987124522777,\n        \"content\": \"### 🚨Ensure Qdrant collection exists!\\nYou'll need to run the following command in Qdrant:\\n```\\nPUT collections/hello_fresh\\n{\\n  \\\"vectors\\\": {\\n    \\\"distance\\\": \\\"Cosine\\\",\\n    \\\"size\\\": 1024\\n  }\\n}\\n```\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"39191834-ecc2-46f0-a31a-0a7e9c47ac5d\",\n      \"name\": \"Sticky Note8\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        2740,\n        920\n      ],\n      \"parameters\": {\n        \"width\": 213.30551928619226,\n        \"height\": 332.38559808882246,\n        \"content\": \"### 🚨配置您的 Qdrant 连接\\n* 请务必输入您的终端地址\"\n      },\n      \"typeVersion\": 1\n    }\n  ],\n  \"pinData\": {},\n  \"connections\": {\n    \"Get Recipe\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Extract Recipe Details\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Chat Trigger\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"AI Agent\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Prepare Documents\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Qdrant Vector Store\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Save Recipes to DB\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Default Data Loader\": {\n      \"ai_document\": [\n        [\n          {\n            \"node\": \"Qdrant Vector Store\",\n            \"type\": \"ai_document\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Extract Server Data\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Extract Available Courses\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get Course Metadata\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Merge Course & Recipe\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get Recipes From DB\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get Tool Response\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get This Week's Menu\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Extract Server Data\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Qdrant Recommend API\": {\n      \"ai_tool\": [\n        [\n          {\n            \"node\": \"AI Agent\",\n            \"type\": \"ai_tool\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Wait for Rate Limits\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get Mistral Embeddings\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Merge Course & Recipe\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Prepare Documents\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Extract Recipe Details\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Merge Course & Recipe\",\n            \"type\": \"main\",\n            \"index\": 1\n          }\n        ]\n      ]\n    },\n    \"Get Mistral Embeddings\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Use Qdrant Recommend API\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Embeddings Mistral Cloud\": {\n      \"ai_embedding\": [\n        [\n          {\n            \"node\": \"Qdrant Vector Store\",\n            \"type\": \"ai_embedding\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Execute Workflow Trigger\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Wait for Rate Limits\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Mistral Cloud Chat Model\": {\n      \"ai_languageModel\": [\n        [\n          {\n            \"node\": \"AI Agent\",\n            \"type\": \"ai_languageModel\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Use Qdrant Recommend API\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get Recipes From DB\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Extract Available Courses\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get Course Metadata\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Get Recipe\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"When clicking \\\"Test workflow\\\"\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get This Week's Menu\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Recursive Character Text Splitter\": {\n      \"ai_textSplitter\": [\n        [\n          {\n            \"node\": \"Default Data Loader\",\n            \"type\": \"ai_textSplitter\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}"
}