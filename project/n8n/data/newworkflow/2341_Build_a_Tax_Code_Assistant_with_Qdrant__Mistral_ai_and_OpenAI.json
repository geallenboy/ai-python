{
  "url": "https://n8n.io/workflows/2341-build-a-tax-code-assistant-with-qdrant-mistralai-and-openai/",
  "title": "Build a Tax Code Assistant with Qdrant, Mistral.ai and OpenAI",
  "author": "Jimleuk",
  "publish_date": "Last update 10 months ago",
  "publish_date_absolute": "2024-07-25",
  "categories": [
    {
      "name": "Finance"
    },
    {
      "name": "AI"
    }
  ],
  "workflow_json": "{\"meta\":{\"instanceId\":\"26ba763460b97c249b82942b23b6384876dfeb9327513332e743c5f6219c2b8e\"},\"nodes\":[{\"id\":\"1bb3c94e-326e-41ca-82e4-102a598dba39\",\"name\":\"When clicking ‘Test workflow’\",\"type\":\"n8n-nodes-base.manualTrigger\",\"position\":[-320,300],\"parameters\":{},\"typeVersion\":1},{\"id\":\"751b283b-ea88-4fcd-ace3-3c86631f8876\",\"name\":\"Embeddings Mistral Cloud\",\"type\":\"@n8n/n8n-nodes-langchain.embeddingsMistralCloud\",\"position\":[1760,560],\"parameters\":{\"options\":{}},\"credentials\":{\"mistralCloudApi\":{\"id\":\"EIl2QxhXAS9Hkg37\",\"name\":\"Mistral Cloud account\"}},\"typeVersion\":1},{\"id\":\"f0851949-1036-4040-84df-61295cc5db74\",\"name\":\"Default Data Loader\",\"type\":\"@n8n/n8n-nodes-langchain.documentDefaultDataLoader\",\"position\":[1900,560],\"parameters\":{\"options\":{\"metadata\":{\"metadataValues\":[{\"name\":\"chapter\",\"value\":\"={{ $('For Each Section...').item.json.chapter }}\"},{\"name\":\"section\",\"value\":\"={{ $('For Each Section...').item.json.label }}\"},{\"name\":\"=title\",\"value\":\"={{ $('For Each Section...').item.json.title }}\"},{\"name\":\"content_order\",\"value\":\"={{ $itemIndex }}\"}]}},\"jsonData\":\"={{ $json.content }}\",\"jsonMode\":\"expressionData\"},\"typeVersion\":1},{\"id\":\"41d10b61-9fbe-446e-a65a-0db6e0116e5b\",\"name\":\"Recursive Character Text Splitter\",\"type\":\"@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter\",\"position\":[1920,680],\"parameters\":{\"options\":{},\"chunkSize\":2000},\"typeVersion\":1},{\"id\":\"a1ecb096-4d31-4993-b801-ca3f09a9edc7\",\"name\":\"Get Tax Code Zip File\",\"type\":\"n8n-nodes-base.httpRequest\",\"position\":[-20,340],\"parameters\":{\"url\":\"https://statutes.capitol.texas.gov/Docs/Zips/TX.pdf.zip\",\"options\":{\"response\":{\"response\":{\"responseFormat\":\"file\"}}}},\"typeVersion\":4.2},{\"id\":\"cf983315-fe2a-43c1-8dc6-b17a217b845e\",\"name\":\"Extract Zip Files\",\"type\":\"n8n-nodes-base.compression\",\"position\":[140,340],\"parameters\":{},\"typeVersion\":1.1},{\"id\":\"8d02dd80-d14a-4e56-ab40-f2c4a445c57b\",\"name\":\"Files as Items\",\"type\":\"n8n-nodes-base.splitOut\",\"position\":[300,340],\"parameters\":{\"include\":\"allOtherFields\",\"options\":{},\"fieldToSplitOut\":\"$binary\"},\"typeVersion\":1},{\"id\":\"038060dc-e01d-40ae-878d-5043bc36ab91\",\"name\":\"Extract PDF Contents\",\"type\":\"n8n-nodes-base.extractFromFile\",\"position\":[560,380],\"parameters\":{\"options\":{},\"operation\":\"pdf\",\"binaryPropertyName\":\"=file_{{ $itemIndex }}\"},\"typeVersion\":1},{\"id\":\"4a85003b-b988-467b-b1cb-29206cbed879\",\"name\":\"Extract From Chapter\",\"type\":\"n8n-nodes-base.set\",\"position\":[740,380],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"d791928a-d775-48cc-9004-a92cbe2403d3\",\"name\":\"contents\",\"type\":\"array\",\"value\":\"={{\\n  $json.text\\n    .substring($json.text.search(/\\\\nSec\\\\.\\\\nA[0-9]{1,4}\\\\.[0-9]{1,5}\\\\.AA/), $json.text.length)\\n    .split(/\\\\nSec\\\\.\\\\nA[0-9]{1,2}\\\\.[0-9]{1,2}\\\\.AA/g)\\n    .filter(text => !text.isEmpty())\\n    .map(text => {\\n      const output = text.replaceAll('AA', ' ').replaceAll('\\\\nA', ' ');\\n      const title = output.substring(0, output.indexOf('.'));\\n      const content = output.substring(output.indexOf('.')+1, output.length).replaceAll('\\\\n', ' ').trim();\\n      return { title, content };\\n    })\\n}}\"},{\"id\":\"bc06641f-0b75-4a35-8752-78803231d5d6\",\"name\":\"labels\",\"type\":\"array\",\"value\":\"={{\\n  $json.text\\n    .match(/\\\\nSec\\\\.\\\\nA[0-9]{1,4}\\\\.[0-9]{1,5}\\\\.AA/g)\\n    .map(text => ({\\n        label: text.replaceAll('AA', ' ')\\n                  .replaceAll('\\\\nA', ' ')\\n                  .replaceAll('\\\\n', '')\\n                  .trim()\\n    }))\\n}}\"}]}},\"typeVersion\":3.3},{\"id\":\"ee338786-91df-4784-bd7e-f86c0e13ca26\",\"name\":\"Map To Sections\",\"type\":\"n8n-nodes-base.set\",\"position\":[740,520],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"60109e60-d760-45bb-be09-7cb2b5eb85bc\",\"name\":\"section\",\"type\":\"array\",\"value\":\"={{\\n  $json.labels.map((label, idx) => ({\\n    label: label.label.match(/\\\\d.+/)[0].replace(/\\\\.$/, ''),\\n    title: $json.contents[idx].title,\\n    content: $json.contents[idx].content,\\n    chapter: $('Extract PDF Contents').first().json.info.Title,\\n  }))\\n}}\"}]}},\"typeVersion\":3.3},{\"id\":\"41c9899d-26d7-48af-9af2-8563ab0fb7e4\",\"name\":\"Execute Workflow Trigger\",\"type\":\"n8n-nodes-base.executeWorkflowTrigger\",\"position\":[1313,1200],\"parameters\":{},\"typeVersion\":1},{\"id\":\"3a93c19b-09d9-4e38-8b0c-2008fc03f7fc\",\"name\":\"Get Mistral Embeddings\",\"type\":\"n8n-nodes-base.httpRequest\",\"position\":[1660,1060],\"parameters\":{\"url\":\"https://api.mistral.ai/v1/embeddings\",\"method\":\"POST\",\"options\":{},\"sendBody\":true,\"authentication\":\"predefinedCredentialType\",\"bodyParameters\":{\"parameters\":[{\"name\":\"model\",\"value\":\"mistral-embed\"},{\"name\":\"encoding_format\",\"value\":\"float\"},{\"name\":\"input\",\"value\":\"={{ $json.query }}\"}]},\"nodeCredentialType\":\"mistralCloudApi\"},\"credentials\":{\"mistralCloudApi\":{\"id\":\"EIl2QxhXAS9Hkg37\",\"name\":\"Mistral Cloud account\"}},\"typeVersion\":4.2},{\"id\":\"1adc12bd-ba61-4f1a-b1f9-3f19a542e294\",\"name\":\"Content Chunking @ 50k Chars\",\"type\":\"n8n-nodes-base.set\",\"position\":[1580,400],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"7753a4f4-3ec2-4c05-81df-3d5e8979a478\",\"name\":\"=content\",\"type\":\"array\",\"value\":\"={{ new Array(Math.round($json.content.length / Math.min($json.content.length, 30000))).fill('').map((_,idx) => $json.content.substring(idx * 30000, idx * 50000 + 30000)) }}\"}]}},\"typeVersion\":3.3},{\"id\":\"ff8adce2-8f73-4a8f-b512-5aa560ca0954\",\"name\":\"Split Out Chunks\",\"type\":\"n8n-nodes-base.splitOut\",\"position\":[1580,580],\"parameters\":{\"options\":{},\"fieldToSplitOut\":\"content\"},\"typeVersion\":1},{\"id\":\"5f08ce3c-240d-4c91-bb23-953866fd0361\",\"name\":\"For Each Section...\",\"type\":\"n8n-nodes-base.splitInBatches\",\"position\":[1400,280],\"parameters\":{\"options\":{},\"batchSize\":5},\"typeVersion\":3},{\"id\":\"6346cf67-7d93-4315-bb0d-2e016c9853b9\",\"name\":\"Sections To List\",\"type\":\"n8n-nodes-base.splitOut\",\"position\":[940,380],\"parameters\":{\"options\":{},\"fieldToSplitOut\":\"section\"},\"typeVersion\":1},{\"id\":\"95e34952-03e2-40e3-a245-9da8c9e1f249\",\"name\":\"Only Valid Sections\",\"type\":\"n8n-nodes-base.filter\",\"position\":[1100,380],\"parameters\":{\"options\":{},\"conditions\":{\"options\":{\"leftValue\":\"\",\"caseSensitive\":true,\"typeValidation\":\"strict\"},\"combinator\":\"or\",\"conditions\":[{\"id\":\"121e8f86-2ead-47e0-8e17-52d7c6ba8265\",\"operator\":{\"type\":\"string\",\"operation\":\"notEmpty\",\"singleValue\":true},\"leftValue\":\"={{ $json.content }}\",\"rightValue\":\"\"}]}},\"typeVersion\":2},{\"id\":\"dfe1818f-93b7-4116-8a6e-dcb2e6c23fcf\",\"name\":\"Use Qdrant Search API1\",\"type\":\"n8n-nodes-base.httpRequest\",\"position\":[1860,1060],\"parameters\":{\"url\":\"=http://qdrant:6333/collections/texas_tax_codes/points/search\",\"method\":\"POST\",\"options\":{},\"sendBody\":true,\"authentication\":\"predefinedCredentialType\",\"bodyParameters\":{\"parameters\":[{\"name\":\"limit\",\"value\":\"={{ 4 }}\"},{\"name\":\"vector\",\"value\":\"={{ $json.data[0].embedding }}\"},{\"name\":\"with_payload\",\"value\":\"={{ true }}\"}]},\"nodeCredentialType\":\"qdrantApi\"},\"credentials\":{\"qdrantApi\":{\"id\":\"NyinAS3Pgfik66w5\",\"name\":\"QdrantApi account\"}},\"typeVersion\":4.2},{\"id\":\"588318e6-e188-4d99-9c11-39b2f3fb1c18\",\"name\":\"Use Qdrant Scroll API\",\"type\":\"n8n-nodes-base.httpRequest\",\"position\":[1660,1320],\"parameters\":{\"url\":\"=http://qdrant:6333/collections/texas_tax_codes/points/scroll\",\"method\":\"POST\",\"options\":{\"pagination\":{\"pagination\":{\"parameters\":{\"parameters\":[{\"name\":\"next_page_offset\",\"type\":\"body\",\"value\":\"={{ $response.body.result.next_page_offset }}\"}]},\"completeExpression\":\"={{ $response.body.result.next_page_offset === null }}\",\"paginationCompleteWhen\":\"other\"}}},\"sendBody\":true,\"authentication\":\"predefinedCredentialType\",\"bodyParameters\":{\"parameters\":[{\"name\":\"limit\",\"value\":\"={{ 100 }}\"},{\"name\":\"with_payload\",\"value\":\"={{ true }}\"},{\"name\":\"filter\",\"value\":\"={{\\n{\\n  \\\"must\\\": [\\n    ($json.query.section\\n      ? { \\\"key\\\": \\\"metadata.section\\\", \\\"match\\\": { \\\"value\\\": $json.query.section } }\\n      : { \\\"key\\\": \\\"metadata.chapter\\\", \\\"match\\\": { \\\"value\\\": $json.query.chapter } }\\n    )\\n  ]\\n}\\n}}\"}]},\"nodeCredentialType\":\"qdrantApi\"},\"credentials\":{\"qdrantApi\":{\"id\":\"NyinAS3Pgfik66w5\",\"name\":\"QdrantApi account\"}},\"typeVersion\":4.2},{\"id\":\"bbf01344-c60e-42b3-8d7d-2bb360876d79\",\"name\":\"Get Search Response\",\"type\":\"n8n-nodes-base.set\",\"position\":[1860,1320],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"08ad2d6e-4ed1-409e-b89c-1f0c7fdf1b64\",\"name\":\"response\",\"type\":\"string\",\"value\":\"=---\\nchapter: {{ $json.result.points.first().payload.metadata.chapter }}\\nsection: {{ $json.result.points.first().payload.metadata.section }}\\ntitle: {{ $json.result.points.first().payload.metadata.title }}\\n---\\n{{ $json.result.points\\n      .toSorted((a,b) => (a.payload.metadata.content_order || 0) - (b.payload.metadata.content_order || 0))\\n      .map(point => point.payload.content).join('\\\\n') }}\"}]}},\"typeVersion\":3.3},{\"id\":\"3b23ff5e-158a-470f-a262-d001d52feeba\",\"name\":\"Sticky Note\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[-100,183.38345554113084],\"parameters\":{\"color\":7,\"width\":571.4359274276384,\"height\":352.65642339230595,\"content\":\"## Step 1. Download the Tax Code PDF\\n[Read more about handling Zip Files](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.compression/)\\n\\nLet's begin by pulling a zip file containing all the tax codes as separate PDF files. We can unzip on the fly with n8n's compression node.\"},\"typeVersion\":1},{\"id\":\"02826887-eb26-48a0-928e-fe56ee008425\",\"name\":\"Sticky Note1\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[500,199.87747230655896],\"parameters\":{\"color\":7,\"width\":777.897719182587,\"height\":503.3459981018574,\"content\":\"## Step 2. Extract and Partition Into Chapters & Sections\\n[Learn more about reading PDF Files](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.extractfromfile)\\n\\nRather than ingest the raw text of the PDF, we'll be a little more strategic and extract the tax code sections separately instead. Not only will this provide cleaner results, we'll also be able to fetch sections in isolation if required.\"},\"typeVersion\":1},{\"id\":\"31a34972-31ab-4b96-9d09-cd30a3b184cf\",\"name\":\"Sticky Note2\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1300,108.82958126396],\"parameters\":{\"color\":7,\"width\":1045.1698686248747,\"height\":771.1260499456115,\"content\":\"## Step 3. Save into Qdrant VectorStore\\n[Read more about using the Qdrant Vectorstore](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.vectorstoreqdrant)\\n\\nWe'll save our data into a Qdrant collection being mindful to use metadata to take full advantage of Qdrant's filtering capabilities later.\\nThough not always required, since the tax code documents can be quite large we'll implement a loop here to throttle the number of tokens being processed as to not trip the Mistral.ai rate limits for embeddings.\"},\"typeVersion\":1},{\"id\":\"27039fa6-6388-45ee-a2d5-6bb68554944b\",\"name\":\"Qdrant Vector Store\",\"type\":\"@n8n/n8n-nodes-langchain.vectorStoreQdrant\",\"position\":[1760,400],\"parameters\":{\"mode\":\"insert\",\"options\":{},\"qdrantCollection\":{\"__rl\":true,\"mode\":\"list\",\"value\":\"texas_tax_codes\",\"cachedResultName\":\"texas_tax_codes\"}},\"credentials\":{\"qdrantApi\":{\"id\":\"NyinAS3Pgfik66w5\",\"name\":\"QdrantApi account\"}},\"typeVersion\":1},{\"id\":\"5ec16c20-eb1e-454a-8165-594d83dd8711\",\"name\":\"Sticky Note3\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[360,900],\"parameters\":{\"color\":7,\"width\":858.1415560000298,\"height\":513.2269439624808,\"content\":\"## Step 4. Build a Tax Code Assistant ChatBot\\n[Learn more about using AI Agents in n8n](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.agent)\\n\\nFor our chatbot, we'll use an AI agent node because we want to achieve more than one functionality. The first will be querying to relevant texts to answer a user's question and secondly, a direct search feature to pull full section text when requested.\"},\"typeVersion\":1},{\"id\":\"d5145c6f-768b-42d8-a045-20e045f52b0b\",\"name\":\"Sticky Note4\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1240,904.6076722083936],\"parameters\":{\"color\":7,\"width\":1030.0926850706744,\"height\":577.7854680142904,\"content\":\"## Step 5. Use Qdrant API as Tools\\n[Learn more about using AI Agents in n8n](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.agent)\\n\\nOur Ask Tool will generate embeddings using Mistral.ai and query our Qdrant collection using the Qdrant Search API.\\nOur Search Tool will use filter our Qdrant collection using the Qdrant Scroll API, matching on each doc's section metadata key.\"},\"typeVersion\":1},{\"id\":\"ccf50479-53d8-4edf-8f2b-73060a6a6e0f\",\"name\":\"AI Agent\",\"type\":\"@n8n/n8n-nodes-langchain.agent\",\"position\":[700,1063],\"parameters\":{\"options\":{\"systemMessage\":\"You are a helpful assistant answering user questions on the tax code legistration for the state of Texas, united states of america.\\n\\nAlong with your response also note in which chapter and section number the information was found. \"}},\"typeVersion\":1.6},{\"id\":\"d7e7fa9e-73ba-4df3-862e-25af63d9d9b4\",\"name\":\"Window Buffer Memory\",\"type\":\"@n8n/n8n-nodes-langchain.memoryBufferWindow\",\"position\":[820,1223],\"parameters\":{},\"typeVersion\":1.2},{\"id\":\"a79bdbcd-7157-470a-aadc-bd3f8a4c40d2\",\"name\":\"When chat message received\",\"type\":\"@n8n/n8n-nodes-langchain.chatTrigger\",\"position\":[420,1063],\"webhookId\":\"db2b118d-942e-4be9-b154-7df887232f97\",\"parameters\":{\"public\":true,\"options\":{\"loadPreviousSession\":\"memory\"},\"initialMessages\":\"\"},\"typeVersion\":1},{\"id\":\"6046f137-b508-484f-8577-ac51a35eee09\",\"name\":\"Window Buffer Memory1\",\"type\":\"@n8n/n8n-nodes-langchain.memoryBufferWindow\",\"position\":[420,1223],\"parameters\":{},\"typeVersion\":1.2},{\"id\":\"30f238f8-1987-4d6d-b06d-ac2106ea3734\",\"name\":\"OpenAI Chat Model\",\"type\":\"@n8n/n8n-nodes-langchain.lmChatOpenAi\",\"position\":[700,1223],\"parameters\":{\"options\":{}},\"credentials\":{\"openAiApi\":{\"id\":\"8gccIjcuf3gvaoEr\",\"name\":\"OpenAi account\"}},\"typeVersion\":1},{\"id\":\"8a8490f6-5957-495c-a7af-15cec669f39c\",\"name\":\"1sec\",\"type\":\"n8n-nodes-base.wait\",\"position\":[2160,660],\"webhookId\":\"852317f0-aadf-4658-ae44-d05e5de29302\",\"parameters\":{\"amount\":1},\"executeOnce\":false,\"typeVersion\":1.1},{\"id\":\"142450f5-8ec1-4ae6-b25c-df3233394d4e\",\"name\":\"Ask Tool\",\"type\":\"@n8n/n8n-nodes-langchain.toolWorkflow\",\"position\":[960,1223],\"parameters\":{\"name\":\"query_tax_code_knowledgebase\",\"fields\":{\"values\":[{\"name\":\"route\",\"stringValue\":\"ask_tool\"}]},\"workflowId\":\"={{ $workflow.id }}\",\"description\":\"Call this tool to query the tax code database for information. Structure your query in the form of a question for best results.\"},\"typeVersion\":1.1},{\"id\":\"ee455a4e-c9a1-49b2-a036-d3f3d34099c6\",\"name\":\"Search Tool\",\"type\":\"@n8n/n8n-nodes-langchain.toolWorkflow\",\"position\":[1060,1223],\"parameters\":{\"name\":\"get_tax_code_section\",\"fields\":{\"values\":[{\"name\":\"route\",\"stringValue\":\"search_tool\"}]},\"workflowId\":\"={{ $workflow.id }}\",\"description\":\"Call this tool to search for specific sections of the tax code document. Pass in either a known section number/id to get the section's text or a known chapter name to return all sections for the chapter.\",\"jsonSchemaExample\":\"{\\n\\t\\\"chapter\\\": \\\"some_value\\\",\\n    \\\"section\\\": \\\"Sec 1.01\\\"\\n}\",\"specifyInputSchema\":true},\"typeVersion\":1.1},{\"id\":\"f3240f8d-8869-4088-8e4f-d4e23a3c12a8\",\"name\":\"Switch\",\"type\":\"n8n-nodes-base.switch\",\"position\":[1473,1200],\"parameters\":{\"rules\":{\"values\":[{\"outputKey\":\"ask_tool\",\"conditions\":{\"options\":{\"leftValue\":\"\",\"caseSensitive\":true,\"typeValidation\":\"strict\"},\"combinator\":\"and\",\"conditions\":[{\"operator\":{\"type\":\"string\",\"operation\":\"equals\"},\"leftValue\":\"={{ $json.route }}\",\"rightValue\":\"ask_tool\"}]},\"renameOutput\":true},{\"outputKey\":\"search_tool\",\"conditions\":{\"options\":{\"leftValue\":\"\",\"caseSensitive\":true,\"typeValidation\":\"strict\"},\"combinator\":\"and\",\"conditions\":[{\"id\":\"909362ed-eb97-405c-9f2f-f404a3bfeaf3\",\"operator\":{\"name\":\"filter.operator.equals\",\"type\":\"string\",\"operation\":\"equals\"},\"leftValue\":\"={{ $json.route }}\",\"rightValue\":\"search_tool\"}]},\"renameOutput\":true}]},\"options\":{}},\"typeVersion\":3},{\"id\":\"71441b5a-099b-49e0-a212-3087d958b38b\",\"name\":\"Get Ask Response\",\"type\":\"n8n-nodes-base.set\",\"position\":[2060,1060],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"eb5f2b3c-bb88-4cae-a960-164016c9a9e4\",\"name\":\"response\",\"type\":\"string\",\"value\":\"=|chapter|section|title|content|\\n|-|-|-|-|\\n{{\\n  $json.result.map(row => [\\n    '',\\n    row.payload.metadata.chapter,\\n    row.payload.metadata.section,\\n    row.payload.metadata.title,\\n    row.payload.content,\\n    ''\\n  ].join('|')).join('\\\\n')\\n}}\"}]}},\"typeVersion\":3.3},{\"id\":\"54a744a3-95c9-4d9a-b1e7-e266a51f77ca\",\"name\":\"Sticky Note5\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[-520,-79.56762868134751],\"parameters\":{\"width\":383.14868794462586,\"height\":563.604204119637,\"content\":\"## Try Me Out!\\n### This workflow builds an AI powered Legal assistant who answers questions about tax codes.\\n* Download publically available tax code PDFs from the relevant government website.\\n* Strategically exact tax code sections and store these in our Qdrant Vectorstore using Mistral.ai embeddings.\\n* Use an AI Agent to answer user's tax questions by attaching tools which query our Qdrant vectorstore.\\n\\n### Need Help?\\nJoin the [Discord](https://discord.com/invite/XPKeKXeB7d) or ask in the [Forum](https://community.n8n.io/)!\\n\\nHappy Hacking!\"},\"typeVersion\":1},{\"id\":\"7f802f12-03e0-4b8e-a880-8c26242c1152\",\"name\":\"Sticky Note6\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[790.1971986436472,720],\"parameters\":{\"color\":5,\"width\":489.3944544742706,\"height\":131.61363932813174,\"content\":\"### 🙋‍♀️What's the difference?\\nWith raw PDF data, we may blur the boundaries between chapters and sections making later results hard to find, incoherent or misleading.\\nDepending on your use-case, store your data in a way you intend to retrieve it!\"},\"typeVersion\":1}],\"pinData\":{},\"connections\":{\"1sec\":{\"main\":[[{\"node\":\"For Each Section...\",\"type\":\"main\",\"index\":0}]]},\"Switch\":{\"main\":[[{\"node\":\"Get Mistral Embeddings\",\"type\":\"main\",\"index\":0}],[{\"node\":\"Use Qdrant Scroll API\",\"type\":\"main\",\"index\":0}]]},\"Ask Tool\":{\"ai_tool\":[[{\"node\":\"AI Agent\",\"type\":\"ai_tool\",\"index\":0}]]},\"Search Tool\":{\"ai_tool\":[[{\"node\":\"AI Agent\",\"type\":\"ai_tool\",\"index\":0}]]},\"Files as Items\":{\"main\":[[{\"node\":\"Extract PDF Contents\",\"type\":\"main\",\"index\":0}]]},\"Map To Sections\":{\"main\":[[{\"node\":\"Sections To List\",\"type\":\"main\",\"index\":0}]]},\"Sections To List\":{\"main\":[[{\"node\":\"Only Valid Sections\",\"type\":\"main\",\"index\":0}]]},\"Split Out Chunks\":{\"main\":[[{\"node\":\"Qdrant Vector Store\",\"type\":\"main\",\"index\":0}]]},\"Extract Zip Files\":{\"main\":[[{\"node\":\"Files as Items\",\"type\":\"main\",\"index\":0}]]},\"OpenAI Chat Model\":{\"ai_languageModel\":[[{\"node\":\"AI Agent\",\"type\":\"ai_languageModel\",\"index\":0}]]},\"Default Data Loader\":{\"ai_document\":[[{\"node\":\"Qdrant Vector Store\",\"type\":\"ai_document\",\"index\":0}]]},\"For Each Section...\":{\"main\":[null,[{\"node\":\"Content Chunking @ 50k Chars\",\"type\":\"main\",\"index\":0}]]},\"Only Valid Sections\":{\"main\":[[{\"node\":\"For Each Section...\",\"type\":\"main\",\"index\":0}]]},\"Qdrant Vector Store\":{\"main\":[[{\"node\":\"1sec\",\"type\":\"main\",\"index\":0}]]},\"Extract From Chapter\":{\"main\":[[{\"node\":\"Map To Sections\",\"type\":\"main\",\"index\":0}]]},\"Extract PDF Contents\":{\"main\":[[{\"node\":\"Extract From Chapter\",\"type\":\"main\",\"index\":0}]]},\"Window Buffer Memory\":{\"ai_memory\":[[{\"node\":\"AI Agent\",\"type\":\"ai_memory\",\"index\":0}]]},\"Get Tax Code Zip File\":{\"main\":[[{\"node\":\"Extract Zip Files\",\"type\":\"main\",\"index\":0}]]},\"Use Qdrant Scroll API\":{\"main\":[[{\"node\":\"Get Search Response\",\"type\":\"main\",\"index\":0}]]},\"Window Buffer Memory1\":{\"ai_memory\":[[{\"node\":\"When chat message received\",\"type\":\"ai_memory\",\"index\":0}]]},\"Get Mistral Embeddings\":{\"main\":[[{\"node\":\"Use Qdrant Search API1\",\"type\":\"main\",\"index\":0}]]},\"Use Qdrant Search API1\":{\"main\":[[{\"node\":\"Get Ask Response\",\"type\":\"main\",\"index\":0}]]},\"Embeddings Mistral Cloud\":{\"ai_embedding\":[[{\"node\":\"Qdrant Vector Store\",\"type\":\"ai_embedding\",\"index\":0}]]},\"Execute Workflow Trigger\":{\"main\":[[{\"node\":\"Switch\",\"type\":\"main\",\"index\":0}]]},\"When chat message received\":{\"main\":[[{\"node\":\"AI Agent\",\"type\":\"main\",\"index\":0}]]},\"Content Chunking @ 50k Chars\":{\"main\":[[{\"node\":\"Split Out Chunks\",\"type\":\"main\",\"index\":0}]]},\"Recursive Character Text Splitter\":{\"ai_textSplitter\":[[{\"node\":\"Default Data Loader\",\"type\":\"ai_textSplitter\",\"index\":0}]]},\"When clicking ‘Test workflow’\":{\"main\":[[{\"node\":\"Get Tax Code Zip File\",\"type\":\"main\",\"index\":0}]]}}}",
  "readme": "This n8n workflows builds another example of creating a knowledgebase assistant but demonstrates how a more deliberate and targeted approach to ingesting the data can produce much better results for your chatbot.\n\nIn this example, a government tax code policy document is used. Whilst we could split the document into chunks by content length, we often lose the context of chapters and sections which may be required by the user.\n\nOur approach then is to first split the document into chapters and sections before importing into our vector store. Additionally, using metadata correctly is key to allow filtering and scoped queries.\n\n## Example\n\n**Human** : \"Tell me about what the tax code says about cargo for intentional commerce?\"\n\n**AI** : \"Section 11.25 of the Texas Property Tax Code pertains to \"MARINE CARGO CONTAINERS USED EXCLUSIVELY IN INTERNATIONAL COMMERCE.\" In this section, a person who is a citizen of a foreign country or an en...\"\n\n## How it works\n\n  * The tax code policy document is downloaded as a zip file from the government website and its pages are extracted as separate chapters.\n  * Each chapter is then parsed and split into its sections using data manipulation expressions.\n  * Each section is then inserted into our Qdrant vector store tagged with its source, chapter and section numbers as metadata.\n  * When our AI Agent needs to retrieve data from our vector store, we use a custom workflow tool to perform the query to Qdrant.\n  * Because we're relying on Qdrant's advanced filtering capabilities, we perform the search using the Qdrant API rather than the Qdrant node.\n  * When the AI Agent, needs to pull full wording or extracts, we can use Qdrant's scroll API and metadata filtering to do so. This makes Qdrant behave like a key-value store for our document.\n\n\n\n## Requirements\n\n  * A Qdrant instance is required for the vector store and specifically for it's filtering functionality.\n  * [Mistral.ai](http://Mistral.ai) account for Embeddings and AI models.\n\n\n\n## Customising this workflow\n\nDepending on your use-case, consider returning actual PDF pages (or links) to the user for the extra confirmation and to build trust.\n\nNot using Mistral? You are able to replace but note to match the distance and dimension size of Qdrant collection to your chosen embedding model.\n",
  "crawled_at": "2025-05-25T23:33:05.729082",
  "readme_zh": "这个n8n工作流构建了另一个创建知识库助手的示例，但展示了如何通过更精细和有针对性的数据摄取方法，为聊天机器人带来更优质的结果。\n\n本例采用了一份政府税法政策文件。虽然我们可以按内容长度分割文档，但这样做往往会丢失用户可能需要的章节上下文信息。\n\n我们的解决方案是：在将文档导入向量数据库前，先按章节进行结构化拆分。同时，正确使用元数据是实现筛选和范围查询的关键。\n\n## 案例演示\n\n**用户提问**：\"告诉我税法中关于国际商贸货物的规定？\"\n\n**AI回答**：\"《得克萨斯州财产税法》第11.25条涉及'专门用于国际商贸的海运集装箱'。该条款规定，外国公民或...\"\n\n## 实现原理\n\n* 从政府网站下载ZIP格式的税法文件，按章节提取为独立文档\n* 通过数据处理表达式解析每个章节并拆分为具体条款\n* 将每个条款存入Qdrant向量数据库，并标注来源、章节编号等元数据\n* AI代理查询时，通过定制工作流工具向Qdrant发起检索\n* 借助Qdrant高级筛选功能，直接调用其API而非标准节点进行搜索\n* 当需要获取完整条文时，利用Qdrant的滚动API和元数据筛选功能，使其发挥类似文档键值库的作用\n\n## 环境要求\n\n* 需要部署Qdrant实例以支持向量存储及筛选功能\n* 需注册[Mistral.ai](http://Mistral.ai)账户获取嵌入模型和AI服务\n\n## 定制建议\n\n根据实际需求，可考虑向用户返回PDF原文页面（或链接）以增强可信度。若未使用Mistral服务，替换时需注意调整Qdrant集合的距离参数和维度设置以匹配所选嵌入模型。",
  "title_zh": "使用Qdrant、Mistral.ai和OpenAI构建税务法规助手",
  "publish_date_zh": "最后更新于9个月前",
  "workflow_json_zh": "{\n  \"meta\": {\n    \"instanceId\": \"26ba763460b97c249b82942b23b6384876dfeb9327513332e743c5f6219c2b8e\"\n  },\n  \"nodes\": [\n    {\n      \"id\": \"1bb3c94e-326e-41ca-82e4-102a598dba39\",\n      \"name\": \"When clicking ‘Test workflow’\",\n      \"type\": \"n8n-nodes-base.manualTrigger\",\n      \"position\": [\n        -320,\n        300\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"751b283b-ea88-4fcd-ace3-3c86631f8876\",\n      \"name\": \"Embeddings Mistral Cloud\",\n      \"type\": \"@n8n/n8n-nodes-langchain.embeddingsMistralCloud\",\n      \"position\": [\n        1760,\n        560\n      ],\n      \"parameters\": {\n        \"options\": {}\n      },\n      \"credentials\": {\n        \"mistralCloudApi\": {\n          \"id\": \"EIl2QxhXAS9Hkg37\",\n          \"name\": \"Mistral Cloud account\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"f0851949-1036-4040-84df-61295cc5db74\",\n      \"name\": \"Default Data Loader\",\n      \"type\": \"@n8n/n8n-nodes-langchain.documentDefaultDataLoader\",\n      \"position\": [\n        1900,\n        560\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"metadata\": {\n            \"metadataValues\": [\n              {\n                \"name\": \"chapter\",\n                \"value\": \"={{ $('For Each Section...').item.json.chapter }}\"\n              },\n              {\n                \"name\": \"section\",\n                \"value\": \"={{ $('For Each Section...').item.json.label }}\"\n              },\n              {\n                \"name\": \"=title\",\n                \"value\": \"={{ $('For Each Section...').item.json.title }}\"\n              },\n              {\n                \"name\": \"content_order\",\n                \"value\": \"={{ $itemIndex }}\"\n              }\n            ]\n          }\n        },\n        \"jsonData\": \"={{ $json.content }}\",\n        \"jsonMode\": \"expressionData\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"41d10b61-9fbe-446e-a65a-0db6e0116e5b\",\n      \"name\": \"Recursive Character Text Splitter\",\n      \"type\": \"@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter\",\n      \"position\": [\n        1920,\n        680\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"chunkSize\": 2000\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"a1ecb096-4d31-4993-b801-ca3f09a9edc7\",\n      \"name\": \"Get Tax Code Zip File\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        -20,\n        340\n      ],\n      \"parameters\": {\n        \"url\": \"https://statutes.capitol.texas.gov/Docs/Zips/TX.pdf.zip\",\n        \"options\": {\n          \"response\": {\n            \"response\": {\n              \"responseFormat\": \"file\"\n            }\n          }\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"cf983315-fe2a-43c1-8dc6-b17a217b845e\",\n      \"name\": \"Extract Zip Files\",\n      \"type\": \"n8n-nodes-base.compression\",\n      \"position\": [\n        140,\n        340\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"8d02dd80-d14a-4e56-ab40-f2c4a445c57b\",\n      \"name\": \"Files as Items\",\n      \"type\": \"n8n-nodes-base.splitOut\",\n      \"position\": [\n        300,\n        340\n      ],\n      \"parameters\": {\n        \"include\": \"allOtherFields\",\n        \"options\": {},\n        \"fieldToSplitOut\": \"$binary\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"038060dc-e01d-40ae-878d-5043bc36ab91\",\n      \"name\": \"Extract PDF Contents\",\n      \"type\": \"n8n-nodes-base.extractFromFile\",\n      \"position\": [\n        560,\n        380\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"operation\": \"pdf\",\n        \"binaryPropertyName\": \"=file_{{ $itemIndex }}\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"4a85003b-b988-467b-b1cb-29206cbed879\",\n      \"name\": \"Extract From Chapter\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        740,\n        380\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"d791928a-d775-48cc-9004-a92cbe2403d3\",\n              \"name\": \"contents\",\n              \"type\": \"array\",\n              \"value\": \"={{\\n  $json.text\\n    .substring($json.text.search(/\\\\nSec\\\\.\\\\nA[0-9]{1,4}\\\\.[0-9]{1,5}\\\\.AA/), $json.text.length)\\n    .split(/\\\\nSec\\\\.\\\\nA[0-9]{1,2}\\\\.[0-9]{1,2}\\\\.AA/g)\\n    .filter(text => !text.isEmpty())\\n    .map(text => {\\n      const output = text.replaceAll('AA', ' ').replaceAll('\\\\nA', ' ');\\n      const title = output.substring(0, output.indexOf('.'));\\n      const content = output.substring(output.indexOf('.')+1, output.length).replaceAll('\\\\n', ' ').trim();\\n      return { title, content };\\n    })\\n}}\"\n            },\n            {\n              \"id\": \"bc06641f-0b75-4a35-8752-78803231d5d6\",\n              \"name\": \"labels\",\n              \"type\": \"array\",\n              \"value\": \"={{\\n  $json.text\\n    .match(/\\\\nSec\\\\.\\\\nA[0-9]{1,4}\\\\.[0-9]{1,5}\\\\.AA/g)\\n    .map(text => ({\\n        label: text.replaceAll('AA', ' ')\\n                  .replaceAll('\\\\nA', ' ')\\n                  .replaceAll('\\\\n', '')\\n                  .trim()\\n    }))\\n}}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.3\n    },\n    {\n      \"id\": \"ee338786-91df-4784-bd7e-f86c0e13ca26\",\n      \"name\": \"Map To Sections\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        740,\n        520\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"60109e60-d760-45bb-be09-7cb2b5eb85bc\",\n              \"name\": \"section\",\n              \"type\": \"array\",\n              \"value\": \"={{\\n  $json.labels.map((label, idx) => ({\\n    label: label.label.match(/\\\\d.+/)[0].replace(/\\\\.$/, ''),\\n    title: $json.contents[idx].title,\\n    content: $json.contents[idx].content,\\n    chapter: $('Extract PDF Contents').first().json.info.Title,\\n  }))\\n}}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.3\n    },\n    {\n      \"id\": \"41c9899d-26d7-48af-9af2-8563ab0fb7e4\",\n      \"name\": \"Execute Workflow Trigger\",\n      \"type\": \"n8n-nodes-base.executeWorkflowTrigger\",\n      \"position\": [\n        1313,\n        1200\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"3a93c19b-09d9-4e38-8b0c-2008fc03f7fc\",\n      \"name\": \"Get Mistral Embeddings\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        1660,\n        1060\n      ],\n      \"parameters\": {\n        \"url\": \"https://api.mistral.ai/v1/embeddings\",\n        \"method\": \"POST\",\n        \"options\": {},\n        \"sendBody\": true,\n        \"authentication\": \"predefinedCredentialType\",\n        \"bodyParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"model\",\n              \"value\": \"mistral-embed\"\n            },\n            {\n              \"name\": \"encoding_format\",\n              \"value\": \"float\"\n            },\n            {\n              \"name\": \"input\",\n              \"value\": \"={{ $json.query }}\"\n            }\n          ]\n        },\n        \"nodeCredentialType\": \"mistralCloudApi\"\n      },\n      \"credentials\": {\n        \"mistralCloudApi\": {\n          \"id\": \"EIl2QxhXAS9Hkg37\",\n          \"name\": \"Mistral Cloud account\"\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"1adc12bd-ba61-4f1a-b1f9-3f19a542e294\",\n      \"name\": \"Content Chunking @ 50k Chars\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        1580,\n        400\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"7753a4f4-3ec2-4c05-81df-3d5e8979a478\",\n              \"name\": \"=content\",\n              \"type\": \"array\",\n              \"value\": \"={{ new Array(Math.round($json.content.length / Math.min($json.content.length, 30000))).fill('').map((_,idx) => $json.content.substring(idx * 30000, idx * 50000 + 30000)) }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.3\n    },\n    {\n      \"id\": \"ff8adce2-8f73-4a8f-b512-5aa560ca0954\",\n      \"name\": \"Split Out Chunks\",\n      \"type\": \"n8n-nodes-base.splitOut\",\n      \"position\": [\n        1580,\n        580\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"fieldToSplitOut\": \"content\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"5f08ce3c-240d-4c91-bb23-953866fd0361\",\n      \"name\": \"For Each Section...\",\n      \"type\": \"n8n-nodes-base.splitInBatches\",\n      \"position\": [\n        1400,\n        280\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"batchSize\": 5\n      },\n      \"typeVersion\": 3\n    },\n    {\n      \"id\": \"6346cf67-7d93-4315-bb0d-2e016c9853b9\",\n      \"name\": \"Sections To List\",\n      \"type\": \"n8n-nodes-base.splitOut\",\n      \"position\": [\n        940,\n        380\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"fieldToSplitOut\": \"section\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"95e34952-03e2-40e3-a245-9da8c9e1f249\",\n      \"name\": \"Only Valid Sections\",\n      \"type\": \"n8n-nodes-base.filter\",\n      \"position\": [\n        1100,\n        380\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"conditions\": {\n          \"options\": {\n            \"leftValue\": \"\",\n            \"caseSensitive\": true,\n            \"typeValidation\": \"strict\"\n          },\n          \"combinator\": \"or\",\n          \"conditions\": [\n            {\n              \"id\": \"121e8f86-2ead-47e0-8e17-52d7c6ba8265\",\n              \"operator\": {\n                \"type\": \"string\",\n                \"operation\": \"notEmpty\",\n                \"singleValue\": true\n              },\n              \"leftValue\": \"={{ $json.content }}\",\n              \"rightValue\": \"\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"dfe1818f-93b7-4116-8a6e-dcb2e6c23fcf\",\n      \"name\": \"Use Qdrant Search API1\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        1860,\n        1060\n      ],\n      \"parameters\": {\n        \"url\": \"=http://qdrant:6333/collections/texas_tax_codes/points/search\",\n        \"method\": \"POST\",\n        \"options\": {},\n        \"sendBody\": true,\n        \"authentication\": \"predefinedCredentialType\",\n        \"bodyParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"limit\",\n              \"value\": \"={{ 4 }}\"\n            },\n            {\n              \"name\": \"vector\",\n              \"value\": \"={{ $json.data[0].embedding }}\"\n            },\n            {\n              \"name\": \"with_payload\",\n              \"value\": \"={{ true }}\"\n            }\n          ]\n        },\n        \"nodeCredentialType\": \"qdrantApi\"\n      },\n      \"credentials\": {\n        \"qdrantApi\": {\n          \"id\": \"NyinAS3Pgfik66w5\",\n          \"name\": \"QdrantApi account\"\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"588318e6-e188-4d99-9c11-39b2f3fb1c18\",\n      \"name\": \"Use Qdrant Scroll API\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        1660,\n        1320\n      ],\n      \"parameters\": {\n        \"url\": \"=http://qdrant:6333/collections/texas_tax_codes/points/scroll\",\n        \"method\": \"POST\",\n        \"options\": {\n          \"pagination\": {\n            \"pagination\": {\n              \"parameters\": {\n                \"parameters\": [\n                  {\n                    \"name\": \"next_page_offset\",\n                    \"type\": \"body\",\n                    \"value\": \"={{ $response.body.result.next_page_offset }}\"\n                  }\n                ]\n              },\n              \"completeExpression\": \"={{ $response.body.result.next_page_offset === null }}\",\n              \"paginationCompleteWhen\": \"other\"\n            }\n          }\n        },\n        \"sendBody\": true,\n        \"authentication\": \"predefinedCredentialType\",\n        \"bodyParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"limit\",\n              \"value\": \"={{ 100 }}\"\n            },\n            {\n              \"name\": \"with_payload\",\n              \"value\": \"={{ true }}\"\n            },\n            {\n              \"name\": \"filter\",\n              \"value\": \"={{\\n{\\n  \\\"must\\\": [\\n    ($json.query.section\\n      ? { \\\"key\\\": \\\"metadata.section\\\", \\\"match\\\": { \\\"value\\\": $json.query.section } }\\n      : { \\\"key\\\": \\\"metadata.chapter\\\", \\\"match\\\": { \\\"value\\\": $json.query.chapter } }\\n    )\\n  ]\\n}\\n}}\"\n            }\n          ]\n        },\n        \"nodeCredentialType\": \"qdrantApi\"\n      },\n      \"credentials\": {\n        \"qdrantApi\": {\n          \"id\": \"NyinAS3Pgfik66w5\",\n          \"name\": \"QdrantApi account\"\n        }\n      },\n      \"typeVersion\": 4.2\n    },\n    {\n      \"id\": \"bbf01344-c60e-42b3-8d7d-2bb360876d79\",\n      \"name\": \"Get Search Response\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        1860,\n        1320\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"08ad2d6e-4ed1-409e-b89c-1f0c7fdf1b64\",\n              \"name\": \"response\",\n              \"type\": \"string\",\n              \"value\": \"=---\\nchapter: {{ $json.result.points.first().payload.metadata.chapter }}\\nsection: {{ $json.result.points.first().payload.metadata.section }}\\ntitle: {{ $json.result.points.first().payload.metadata.title }}\\n---\\n{{ $json.result.points\\n      .toSorted((a,b) => (a.payload.metadata.content_order || 0) - (b.payload.metadata.content_order || 0))\\n      .map(point => point.payload.content).join('\\\\n') }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.3\n    },\n    {\n      \"id\": \"3b23ff5e-158a-470f-a262-d001d52feeba\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -100,\n        183.38345554113084\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 571.4359274276384,\n        \"height\": 352.65642339230595,\n        \"content\": \"## 第一步：下载税则PDF文件  \\n[了解更多关于处理压缩文件的信息](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.compression/)  \\n\\n首先，我们需要下载一个包含所有税则的ZIP压缩包（每个税则均为独立PDF文件）。通过n8n的压缩节点，我们可以实现即时解压操作。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"02826887-eb26-48a0-928e-fe56ee008425\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        500,\n        199.87747230655896\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 777.897719182587,\n        \"height\": 503.3459981018574,\n        \"content\": \"## 第二步：提取并划分章节与条款  \\n[进一步了解如何读取PDF文件](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.extractfromfile)  \\n\\n我们不会直接导入PDF的原始文本，而是采取更策略性的方法，单独提取税法条款。这样不仅能得到更清晰的结果，还能在需要时独立获取特定条款内容。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"31a34972-31ab-4b96-9d09-cd30a3b184cf\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1300,\n        108.82958126396\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 1045.1698686248747,\n        \"height\": 771.1260499456115,\n        \"content\": \"## 第三步：存入Qdrant向量数据库  \\n[详细了解Qdrant向量库的使用方法](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.vectorstoreqdrant)  \\n\\n我们将数据存入Qdrant集合时，会特别注意使用元数据标注，以便后续充分利用Qdrant的筛选功能。  \\n虽然并非必需操作，但由于税法文档体量较大，这里我们会通过循环机制控制处理的令牌数量，避免触发Mistral.ai嵌入模型的速率限制。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"27039fa6-6388-45ee-a2d5-6bb68554944b\",\n      \"name\": \"Qdrant Vector Store\",\n      \"type\": \"@n8n/n8n-nodes-langchain.vectorStoreQdrant\",\n      \"position\": [\n        1760,\n        400\n      ],\n      \"parameters\": {\n        \"mode\": \"insert\",\n        \"options\": {},\n        \"qdrantCollection\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"texas_tax_codes\",\n          \"cachedResultName\": \"texas_tax_codes\"\n        }\n      },\n      \"credentials\": {\n        \"qdrantApi\": {\n          \"id\": \"NyinAS3Pgfik66w5\",\n          \"name\": \"QdrantApi account\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"5ec16c20-eb1e-454a-8165-594d83dd8711\",\n      \"name\": \"Sticky Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        360,\n        900\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 858.1415560000298,\n        \"height\": 513.2269439624808,\n        \"content\": \"## 步骤4. 构建税务法规助手聊天机器人  \\n[详细了解如何在n8n中使用AI代理](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.agent)  \\n\\n我们将采用AI代理节点来构建聊天机器人，以实现多重功能：一是通过检索相关文本回答用户提问，二是当用户需要时，能直接搜索并调取完整的法规条款全文。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"d5145c6f-768b-42d8-a045-20e045f52b0b\",\n      \"name\": \"Sticky Note4\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1240,\n        904.6076722083936\n      ],\n      \"parameters\": {\n        \"color\": 7,\n        \"width\": 1030.0926850706744,\n        \"height\": 577.7854680142904,\n        \"content\": \"## 第五步：将Qdrant API作为工具使用\\n[详细了解如何在n8n中使用AI代理](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.agent)\\n\\n我们的提问工具将通过Mistral.ai生成嵌入向量，并利用Qdrant搜索API查询Qdrant集合。\\n而搜索工具则会通过Qdrant滚动API筛选Qdrant集合，依据每个文档的章节元数据键进行匹配。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"ccf50479-53d8-4edf-8f2b-73060a6a6e0f\",\n      \"name\": \"AI Agent\",\n      \"type\": \"@n8n/n8n-nodes-langchain.agent\",\n      \"position\": [\n        700,\n        1063\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"systemMessage\": \"You are a helpful assistant answering user questions on the tax code legistration for the state of Texas, united states of america.\\n\\nAlong with your response also note in which chapter and section number the information was found. \"\n        }\n      },\n      \"typeVersion\": 1.6\n    },\n    {\n      \"id\": \"d7e7fa9e-73ba-4df3-862e-25af63d9d9b4\",\n      \"name\": \"Window Buffer Memory\",\n      \"type\": \"@n8n/n8n-nodes-langchain.memoryBufferWindow\",\n      \"position\": [\n        820,\n        1223\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"a79bdbcd-7157-470a-aadc-bd3f8a4c40d2\",\n      \"name\": \"When chat message received\",\n      \"type\": \"@n8n/n8n-nodes-langchain.chatTrigger\",\n      \"position\": [\n        420,\n        1063\n      ],\n      \"webhookId\": \"db2b118d-942e-4be9-b154-7df887232f97\",\n      \"parameters\": {\n        \"public\": true,\n        \"options\": {\n          \"loadPreviousSession\": \"memory\"\n        },\n        \"initialMessages\": \"\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"6046f137-b508-484f-8577-ac51a35eee09\",\n      \"name\": \"Window Buffer Memory1\",\n      \"type\": \"@n8n/n8n-nodes-langchain.memoryBufferWindow\",\n      \"position\": [\n        420,\n        1223\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1.2\n    },\n    {\n      \"id\": \"30f238f8-1987-4d6d-b06d-ac2106ea3734\",\n      \"name\": \"OpenAI Chat Model\",\n      \"type\": \"@n8n/n8n-nodes-langchain.lmChatOpenAi\",\n      \"position\": [\n        700,\n        1223\n      ],\n      \"parameters\": {\n        \"options\": {}\n      },\n      \"credentials\": {\n        \"openAiApi\": {\n          \"id\": \"8gccIjcuf3gvaoEr\",\n          \"name\": \"OpenAi account\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"8a8490f6-5957-495c-a7af-15cec669f39c\",\n      \"name\": \"1sec\",\n      \"type\": \"n8n-nodes-base.wait\",\n      \"position\": [\n        2160,\n        660\n      ],\n      \"webhookId\": \"852317f0-aadf-4658-ae44-d05e5de29302\",\n      \"parameters\": {\n        \"amount\": 1\n      },\n      \"executeOnce\": false,\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"142450f5-8ec1-4ae6-b25c-df3233394d4e\",\n      \"name\": \"Ask Tool\",\n      \"type\": \"@n8n/n8n-nodes-langchain.toolWorkflow\",\n      \"position\": [\n        960,\n        1223\n      ],\n      \"parameters\": {\n        \"name\": \"query_tax_code_knowledgebase\",\n        \"fields\": {\n          \"values\": [\n            {\n              \"name\": \"route\",\n              \"stringValue\": \"ask_tool\"\n            }\n          ]\n        },\n        \"workflowId\": \"={{ $workflow.id }}\",\n        \"description\": \"Call this tool to query the tax code database for information. Structure your query in the form of a question for best results.\"\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"ee455a4e-c9a1-49b2-a036-d3f3d34099c6\",\n      \"name\": \"Search Tool\",\n      \"type\": \"@n8n/n8n-nodes-langchain.toolWorkflow\",\n      \"position\": [\n        1060,\n        1223\n      ],\n      \"parameters\": {\n        \"name\": \"get_tax_code_section\",\n        \"fields\": {\n          \"values\": [\n            {\n              \"name\": \"route\",\n              \"stringValue\": \"search_tool\"\n            }\n          ]\n        },\n        \"workflowId\": \"={{ $workflow.id }}\",\n        \"description\": \"Call this tool to search for specific sections of the tax code document. Pass in either a known section number/id to get the section's text or a known chapter name to return all sections for the chapter.\",\n        \"jsonSchemaExample\": \"{\\n\\t\\\"chapter\\\": \\\"some_value\\\",\\n    \\\"section\\\": \\\"Sec 1.01\\\"\\n}\",\n        \"specifyInputSchema\": true\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"f3240f8d-8869-4088-8e4f-d4e23a3c12a8\",\n      \"name\": \"Switch\",\n      \"type\": \"n8n-nodes-base.switch\",\n      \"position\": [\n        1473,\n        1200\n      ],\n      \"parameters\": {\n        \"rules\": {\n          \"values\": [\n            {\n              \"outputKey\": \"ask_tool\",\n              \"conditions\": {\n                \"options\": {\n                  \"leftValue\": \"\",\n                  \"caseSensitive\": true,\n                  \"typeValidation\": \"strict\"\n                },\n                \"combinator\": \"and\",\n                \"conditions\": [\n                  {\n                    \"operator\": {\n                      \"type\": \"string\",\n                      \"operation\": \"equals\"\n                    },\n                    \"leftValue\": \"={{ $json.route }}\",\n                    \"rightValue\": \"ask_tool\"\n                  }\n                ]\n              },\n              \"renameOutput\": true\n            },\n            {\n              \"outputKey\": \"search_tool\",\n              \"conditions\": {\n                \"options\": {\n                  \"leftValue\": \"\",\n                  \"caseSensitive\": true,\n                  \"typeValidation\": \"strict\"\n                },\n                \"combinator\": \"and\",\n                \"conditions\": [\n                  {\n                    \"id\": \"909362ed-eb97-405c-9f2f-f404a3bfeaf3\",\n                    \"operator\": {\n                      \"name\": \"filter.operator.equals\",\n                      \"type\": \"string\",\n                      \"operation\": \"equals\"\n                    },\n                    \"leftValue\": \"={{ $json.route }}\",\n                    \"rightValue\": \"search_tool\"\n                  }\n                ]\n              },\n              \"renameOutput\": true\n            }\n          ]\n        },\n        \"options\": {}\n      },\n      \"typeVersion\": 3\n    },\n    {\n      \"id\": \"71441b5a-099b-49e0-a212-3087d958b38b\",\n      \"name\": \"Get Ask Response\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        2060,\n        1060\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"eb5f2b3c-bb88-4cae-a960-164016c9a9e4\",\n              \"name\": \"response\",\n              \"type\": \"string\",\n              \"value\": \"=|chapter|section|title|content|\\n|-|-|-|-|\\n{{\\n  $json.result.map(row => [\\n    '',\\n    row.payload.metadata.chapter,\\n    row.payload.metadata.section,\\n    row.payload.metadata.title,\\n    row.payload.content,\\n    ''\\n  ].join('|')).join('\\\\n')\\n}}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.3\n    },\n    {\n      \"id\": \"54a744a3-95c9-4d9a-b1e7-e266a51f77ca\",\n      \"name\": \"Sticky Note5\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -520,\n        -79.56762868134751\n      ],\n      \"parameters\": {\n        \"width\": 383.14868794462586,\n        \"height\": 563.604204119637,\n        \"content\": \"## 快来试试吧！\\n### 本流程打造了一个AI驱动的法律助手，专门解答税法条款相关问题\\n* 从相关政府网站下载公开的税法PDF文件\\n* 精准提取税法条款章节，通过Mistral.ai嵌入技术存储至Qdrant向量数据库\\n* 部署AI代理工具，通过查询Qdrant数据库来解答用户税务咨询\\n\\n### 需要帮助？\\n加入[Discord讨论群](https://discord.com/invite/XPKeKXeB7d) 或访问[社区论坛](https://community.n8n.io/)提问！\\n\\n祝您探索愉快！\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"7f802f12-03e0-4b8e-a880-8c26242c1152\",\n      \"name\": \"Sticky Note6\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        790.1971986436472,\n        720\n      ],\n      \"parameters\": {\n        \"color\": 5,\n        \"width\": 489.3944544742706,\n        \"height\": 131.61363932813174,\n        \"content\": \"### 🙋‍♀️区别何在？\\n若直接使用原始PDF数据，我们可能会模糊章节之间的界限，导致后续检索结果难以定位、内容不连贯或产生误导。\\n根据具体使用场景，请以符合检索意图的方式存储数据！\"\n      },\n      \"typeVersion\": 1\n    }\n  ],\n  \"pinData\": {},\n  \"connections\": {\n    \"1sec\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"For Each Section...\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Switch\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get Mistral Embeddings\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Use Qdrant Scroll API\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Ask Tool\": {\n      \"ai_tool\": [\n        [\n          {\n            \"node\": \"AI Agent\",\n            \"type\": \"ai_tool\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Search Tool\": {\n      \"ai_tool\": [\n        [\n          {\n            \"node\": \"AI Agent\",\n            \"type\": \"ai_tool\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Files as Items\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Extract PDF Contents\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Map To Sections\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Sections To List\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Sections To List\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Only Valid Sections\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Split Out Chunks\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Qdrant Vector Store\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Extract Zip Files\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Files as Items\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"OpenAI Chat Model\": {\n      \"ai_languageModel\": [\n        [\n          {\n            \"node\": \"AI Agent\",\n            \"type\": \"ai_languageModel\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Default Data Loader\": {\n      \"ai_document\": [\n        [\n          {\n            \"node\": \"Qdrant Vector Store\",\n            \"type\": \"ai_document\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"For Each Section...\": {\n      \"main\": [\n        null,\n        [\n          {\n            \"node\": \"Content Chunking @ 50k Chars\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Only Valid Sections\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"For Each Section...\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Qdrant Vector Store\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"1sec\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Extract From Chapter\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Map To Sections\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Extract PDF Contents\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Extract From Chapter\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Window Buffer Memory\": {\n      \"ai_memory\": [\n        [\n          {\n            \"node\": \"AI Agent\",\n            \"type\": \"ai_memory\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get Tax Code Zip File\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Extract Zip Files\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Use Qdrant Scroll API\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get Search Response\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Window Buffer Memory1\": {\n      \"ai_memory\": [\n        [\n          {\n            \"node\": \"When chat message received\",\n            \"type\": \"ai_memory\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get Mistral Embeddings\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Use Qdrant Search API1\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Use Qdrant Search API1\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get Ask Response\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Embeddings Mistral Cloud\": {\n      \"ai_embedding\": [\n        [\n          {\n            \"node\": \"Qdrant Vector Store\",\n            \"type\": \"ai_embedding\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Execute Workflow Trigger\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Switch\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"When chat message received\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"AI Agent\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Content Chunking @ 50k Chars\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Split Out Chunks\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Recursive Character Text Splitter\": {\n      \"ai_textSplitter\": [\n        [\n          {\n            \"node\": \"Default Data Loader\",\n            \"type\": \"ai_textSplitter\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"When clicking ‘Test workflow’\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get Tax Code Zip File\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}"
}