{
  "url": "https://n8n.io/workflows/1855-sync-stripe-charges-to-hubspot-contacts/",
  "title": "Sync Stripe charges to HubSpot contacts",
  "author": "n8n Team",
  "publish_date": "Last update 10 months ago",
  "publish_date_absolute": "2024-07-25",
  "categories": [
    {
      "name": "Sales"
    },
    {
      "name": "Marketing"
    }
  ],
  "workflow_json": "{\"meta\":{\"instanceId\":\"a2434c94d549548a685cca39cc4614698e94f527bcea84eefa363f1037ae14cd\"},\"nodes\":[{\"id\":\"9be821db-fbc7-4168-962f-26c8382cefbf\",\"name\":\"If charge has customer\",\"type\":\"n8n-nodes-base.if\",\"position\":[1560,880],\"parameters\":{\"conditions\":{\"string\":[{\"value1\":\"={{ $json[\\\"customer\\\"] }}\",\"operation\":\"isNotEmpty\"}]}},\"typeVersion\":1},{\"id\":\"d06bae31-6856-4941-b86c-c611fc9d3da6\",\"name\":\"Get customer\",\"type\":\"n8n-nodes-base.stripe\",\"position\":[2160,920],\"parameters\":{\"resource\":\"customer\",\"customerId\":\"={{ $json[\\\"customer\\\"] }}\"},\"credentials\":{\"stripeApi\":{\"id\":\"22\",\"name\":\"[UPDATE ME]\"}},\"typeVersion\":1},{\"id\":\"4e0d87bf-084f-4958-b2d3-cf7985f8c901\",\"name\":\"On schedule\",\"type\":\"n8n-nodes-base.scheduleTrigger\",\"position\":[-400,1400],\"parameters\":{\"rule\":{\"interval\":[{}]}},\"typeVersion\":1},{\"id\":\"fb620c92-5e22-4a9c-9320-847442b5e955\",\"name\":\"Remove duplicate customers\",\"type\":\"n8n-nodes-base.itemLists\",\"position\":[1880,920],\"parameters\":{\"compare\":\"selectedFields\",\"options\":{\"removeOtherFields\":true},\"operation\":\"removeDuplicates\",\"fieldsToCompare\":{\"fields\":[{\"fieldName\":\"customer\"}]}},\"typeVersion\":1},{\"id\":\"3ad7554d-24b3-4ee2-8136-6a151bf06c71\",\"name\":\"Aggregate `amount_captured`\",\"type\":\"n8n-nodes-base.itemLists\",\"position\":[1880,540],\"parameters\":{\"options\":{},\"operation\":\"aggregateItems\",\"fieldsToAggregate\":{\"fieldToAggregate\":[{\"fieldToAggregate\":\"amount_captured\"}]}},\"typeVersion\":1},{\"id\":\"c8448580-40f2-4cf6-87ba-80903555d5a5\",\"name\":\"Aggregate totals\",\"type\":\"n8n-nodes-base.code\",\"position\":[2820,1360],\"parameters\":{\"jsCode\":\"// aggregate `amounts_captured` with the customer, taking note \\n// that `aggregateAmountsPerContact` is the value in cents\\nconst aggregateAmountsPerContact = new Object();\\nfor (const item of $input.all()) {\\n  if (aggregateAmountsPerContact[item.json.email] == null) {\\n    aggregateAmountsPerContact[item.json.email] = 0;\\n  }\\n  aggregateAmountsPerContact[item.json.email] += item.json.amount_captured;\\n}\\n\\n// parse the data in a way that is usable in future nodes, and\\n// converts amounts from cents to dollars\\nconst parsed = [];\\nfor (const contact of Object.keys(aggregateAmountsPerContact)) {\\n    parsed.push({\\n        email: contact,\\n        amount_captured: aggregateAmountsPerContact[contact] / 100\\n    });\\n}\\n\\nreturn parsed;\"},\"typeVersion\":1},{\"id\":\"dedaf89e-84d1-4964-9c87-94beea4adf26\",\"name\":\"Create or update customer\",\"type\":\"n8n-nodes-base.hubspot\",\"position\":[3140,1360],\"parameters\":{\"email\":\"={{$node[\\\"Aggregate totals\\\"].json[\\\"email\\\"]}}\",\"resource\":\"contact\",\"authentication\":\"oAuth2\",\"additionalFields\":{\"customPropertiesUi\":{\"customPropertiesValues\":[{\"value\":\"={{$node[\\\"Aggregate totals\\\"].json[\\\"amount_captured\\\"]}}\",\"property\":\"={{$(\\\"Configure\\\").first().json[\\\"contactPropertyId\\\"]}}\"}]}}},\"credentials\":{\"hubspotOAuth2Api\":{\"id\":\"11\",\"name\":\"[UPDATE ME]\"}},\"notesInFlow\":false,\"typeVersion\":1},{\"id\":\"4c419e90-facc-4a64-83f2-d349264338c6\",\"name\":\"Merge data\",\"type\":\"n8n-nodes-base.merge\",\"position\":[2520,1360],\"parameters\":{\"mode\":\"combine\",\"options\":{},\"mergeByFields\":{\"values\":[{\"field1\":\"id\",\"field2\":\"customer\"}]}},\"typeVersion\":2},{\"id\":\"6a21495f-e567-4b0f-b584-34306bf7fa18\",\"name\":\"Note\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[2460,1160],\"parameters\":{\"width\":219.61431588546765,\"height\":378.32426823578305,\"content\":\"### `Merge data`\\nMore specifically, we merge the Stripe data from `Get charges` and `Get customer` nodes. Only the charges with customers on them will continue.\"},\"typeVersion\":1},{\"id\":\"7319c8fe-9e55-43d9-a634-3a7884268016\",\"name\":\"Note1\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[2760,1160],\"parameters\":{\"width\":218.46574043407196,\"height\":379.1631729345614,\"content\":\"### `Aggregate totals`\\nGiven the merged data, we now aggregate the amounts from charges to the customers/contacts.\"},\"typeVersion\":1},{\"id\":\"c24d972b-270d-4467-9352-4ced18e377c0\",\"name\":\"Note2\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1780,400],\"parameters\":{\"width\":297.57428772569784,\"height\":325.06310253513686,\"content\":\"### ``Aggregate `amount_captured` ``\\nThis does nothing. It is an alternative way to find the totals of every charge in existence in Stripe. Potentially useful for debugging purposes.\"},\"typeVersion\":1},{\"id\":\"43da8885-fac3-4cb7-9f01-c4770cd0b030\",\"name\":\"Get all charges\",\"type\":\"n8n-nodes-base.stripe\",\"position\":[1300,1380],\"parameters\":{\"resource\":\"charge\",\"operation\":\"getAll\",\"returnAll\":true},\"credentials\":{\"stripeApi\":{\"id\":\"22\",\"name\":\"[UPDATE ME]\"}},\"typeVersion\":1},{\"id\":\"abfe75f5-c36f-4904-a703-cb8d1d83b686\",\"name\":\"Note3\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[-960,1220],\"parameters\":{\"width\":504,\"height\":510.0404950205649,\"content\":\"## Sync Stripe charges to HubSpot contacts\\nThis workflow pushes Stripe charges to HubSpot contacts. It uses the Stripe API to get all charges and the HubSpot API to update the contacts. The workflow will create a new HubSpot property to store the total amount charged. If the property already exists, it will update the property.\\n\\n### How it works\\n1. On a schedule, the first Stripe node gets all charges. The default schedule is once a day at midnight.\\n2. Once the charges are returned, the second Stripe node gets extra customer information.\\n3. Once the customer information is returned, `Merge data` node will merge the customer information with the charges so that the next node `Aggregate totals` can calculate the total amount charged per contact.\\n4. Once we have the total amount charged per contact, the `Create or update customer` node will create a new HubSpot property to store the total amount charged. If the property already exists, it will update the property.\\n\\n\\n\\nWorkflow written by [David Sha](https://davidsha.me).\"},\"typeVersion\":1},{\"id\":\"67e44a47-18db-48a3-a08e-c4f2afb13a30\",\"name\":\"Note4\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1780,760],\"parameters\":{\"width\":298.2919335506821,\"height\":339.6783118583311,\"content\":\"### `Remove duplicate customers`\\nEnsures that we do not poll Stripe too many times unnecessarily. If multiple charges have the same customer, we ensure that we do not ask for the same information again.\"},\"typeVersion\":1},{\"id\":\"02d46492-f3ba-47fe-ba88-f2baad30fc73\",\"name\":\"Get HubSpot field\",\"type\":\"n8n-nodes-base.httpRequest\",\"position\":[580,1540],\"parameters\":{\"url\":\"=https://api.hubapi.com/crm/v3/properties/contact/{{$(\\\"Configure\\\").first().json[\\\"contactPropertyId\\\"]}}\",\"options\":{},\"authentication\":\"predefinedCredentialType\",\"nodeCredentialType\":\"hubspotOAuth2Api\"},\"credentials\":{\"hubspotOAuth2Api\":{\"id\":\"11\",\"name\":\"[UPDATE ME]\"}},\"typeVersion\":3,\"continueOnFail\":true},{\"id\":\"827882c4-5d3f-4cc6-b876-ae575a9a1b36\",\"name\":\"Create field in HubSpot\",\"type\":\"n8n-nodes-base.httpRequest\",\"position\":[980,1660],\"parameters\":{\"url\":\"https://api.hubapi.com/crm/v3/properties/contact\",\"method\":\"POST\",\"options\":{\"response\":{\"response\":{\"neverError\":true}}},\"sendBody\":true,\"authentication\":\"predefinedCredentialType\",\"bodyParameters\":{\"parameters\":[{\"name\":\"name\",\"value\":\"={{$(\\\"Configure\\\").first().json[\\\"contactPropertyId\\\"]}}\"},{\"name\":\"label\",\"value\":\"={{$(\\\"Configure\\\").first().json[\\\"contactPropertyLabelName\\\"]}}\"},{\"name\":\"type\",\"value\":\"number\"},{\"name\":\"fieldType\",\"value\":\"number\"},{\"name\":\"groupName\",\"value\":\"contactinformation\"},{\"name\":\"formField\",\"value\":\"false\"},{\"name\":\"description\",\"value\":\"=The total spend determined by the charges in Stripe. This is a field required for \\\"{{$workflow.name}}\\\" n8n workflow.\"}]},\"nodeCredentialType\":\"hubspotOAuth2Api\"},\"credentials\":{\"hubspotOAuth2Api\":{\"id\":\"11\",\"name\":\"[UPDATE ME]\"}},\"typeVersion\":3},{\"id\":\"b4092718-bf35-49b5-aefa-b9900596fcb5\",\"name\":\"Note5\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[500,1480],\"parameters\":{\"width\":656.5118956254801,\"height\":367.20468504951214,\"content\":\"### Create HubSpot field if required\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n_These nodes create a HubSpot field if required.\\nIt makes the contact field that this workflow uses \\nto store the Stripe information. To disable this \\nsection, in `Configure` node change `checkFields`\\nto false._\"},\"typeVersion\":1},{\"id\":\"6d74e2e3-bd95-4ccb-89c0-3d6f8f1e01f9\",\"name\":\"Configure\",\"type\":\"n8n-nodes-base.set\",\"position\":[-80,1400],\"parameters\":{\"values\":{\"string\":[{\"name\":\"contactPropertyId\",\"value\":\"stripe___total_spend\"},{\"name\":\"contactPropertyLabelName\",\"value\":\"Stripe - Total Spend\"}],\"boolean\":[{\"name\":\"checkFields\",\"value\":true}]},\"options\":{}},\"typeVersion\":1},{\"id\":\"8a8262bc-0742-4529-9f10-328c338854fe\",\"name\":\"Note6\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[-200,1340],\"parameters\":{\"width\":338.8262165118159,\"height\":505.43603897947025,\"content\":\"### Configuration\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\nBy default, this does not need to be updated. \\n\\n__`contactPropertyId` (required)__: Only change if the specific HubSpot field ID has been taken.\\n\\n__`contactPropertyLabelName` (required)__: Change if you would like a different display name.\\n\\n__`checkFields` (required)__: Turn to false if you would like to optimise this workflow, provided this workflow has run once before with this configurable enabled. This will disable the section of this workflow which deals with creating a HubSpot field.\"},\"typeVersion\":1},{\"id\":\"fc640a31-2050-4276-a1f7-8154f61d2729\",\"name\":\"Note7\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[3080,1160],\"parameters\":{\"width\":219.86482940052417,\"height\":377.58888520886353,\"content\":\"### `Create or update customer`\\nBy default, the only field updated is \\\"Stripe - Total Spend\\\". The contact is identified by its email.\"},\"typeVersion\":1},{\"id\":\"c91295e6-0306-4f3d-adcf-923fbef1c173\",\"name\":\"Skip field checking\",\"type\":\"n8n-nodes-base.if\",\"position\":[240,1400],\"parameters\":{\"conditions\":{\"boolean\":[{\"value1\":\"={{$node[\\\"Configure\\\"].json[\\\"checkFields\\\"]}}\",\"value2\":\"={{false}}\"}]}},\"typeVersion\":1},{\"id\":\"8f8b5a15-4895-4c5a-b8ba-8592dd754aca\",\"name\":\"Do nothing\",\"type\":\"n8n-nodes-base.noOp\",\"position\":[1880,1240],\"parameters\":{},\"typeVersion\":1},{\"id\":\"b953e439-955c-4046-9000-32cbb3577c27\",\"name\":\"Note8\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1780,1140],\"parameters\":{\"width\":298.2919335506821,\"height\":247.94509463108915,\"content\":\"### `Do nothing`\\nThis is useful to know what Stripe charges had no customer assigned.\"},\"typeVersion\":1},{\"id\":\"ec2116e5-2a4a-4edf-a816-b15c349f23e0\",\"name\":\"If field exists\",\"type\":\"n8n-nodes-base.if\",\"position\":[780,1540],\"parameters\":{\"conditions\":{\"number\":[{\"value1\":\"={{ $json[\\\"error\\\"][\\\"httpCode\\\"] }}\",\"value2\":\"404\",\"operation\":\"notEqual\"}]}},\"typeVersion\":1}],\"connections\":{\"Configure\":{\"main\":[[{\"node\":\"Skip field checking\",\"type\":\"main\",\"index\":0}]]},\"Merge data\":{\"main\":[[{\"node\":\"Aggregate totals\",\"type\":\"main\",\"index\":0}]]},\"On schedule\":{\"main\":[[{\"node\":\"Configure\",\"type\":\"main\",\"index\":0}]]},\"Get customer\":{\"main\":[[{\"node\":\"Merge data\",\"type\":\"main\",\"index\":0}]]},\"Get all charges\":{\"main\":[[{\"node\":\"If charge has customer\",\"type\":\"main\",\"index\":0},{\"node\":\"Merge data\",\"type\":\"main\",\"index\":1}]]},\"If field exists\":{\"main\":[[{\"node\":\"Get all charges\",\"type\":\"main\",\"index\":0}],[{\"node\":\"Create field in HubSpot\",\"type\":\"main\",\"index\":0}]]},\"Aggregate totals\":{\"main\":[[{\"node\":\"Create or update customer\",\"type\":\"main\",\"index\":0}]]},\"Get HubSpot field\":{\"main\":[[{\"node\":\"If field exists\",\"type\":\"main\",\"index\":0}]]},\"Skip field checking\":{\"main\":[[{\"node\":\"Get all charges\",\"type\":\"main\",\"index\":0}],[{\"node\":\"Get HubSpot field\",\"type\":\"main\",\"index\":0}]]},\"If charge has customer\":{\"main\":[[{\"node\":\"Remove duplicate customers\",\"type\":\"main\",\"index\":0},{\"node\":\"Aggregate `amount_captured`\",\"type\":\"main\",\"index\":0}],[{\"node\":\"Do nothing\",\"type\":\"main\",\"index\":0}]]},\"Create field in HubSpot\":{\"main\":[[{\"node\":\"Get all charges\",\"type\":\"main\",\"index\":0}]]},\"Remove duplicate customers\":{\"main\":[[{\"node\":\"Get customer\",\"type\":\"main\",\"index\":0}]]}}}",
  "readme": "This workflow pushes Stripe charges to HubSpot contacts. It uses the Stripe API to get all charges and the HubSpot API to update the contacts. The workflow will create a new HubSpot property to store the total amount charged. If the property already exists, it will update the property.\n\n## Prerequisites\n\n  * [Stripe credentials](https://docs.n8n.io/integrations/builtin/credentials/stripe/).\n  * [HubSpot credentials](https://docs.n8n.io/integrations/builtin/credentials/hubspot/).\n\n\n\n## How it works\n\n  1. On a schedule, check if the property exists in HubSpot. If it doesn't exist, create it. The default schedule is once a day at midnight.\n  2. Once property is acertained, the first Stripe node gets all charges.\n  3. Once the charges are returned, the second Stripe node gets extra customer information.\n  4. Once the customer information is returned, `Merge data` node will merge the customer information with the charges so that the next node `Aggregate totals` can calculate the total amount charged per contact.\n  5. Once we have the total amount charged per contact, the `Create or update customer` node will create a new HubSpot contact if it doesn't exist or update the contact if it does exist with the total amount charged.\n\n\n",
  "crawled_at": "2025-05-25T20:13:35.524484",
  "readme_zh": "该工作流将Stripe的收费记录推送至HubSpot联系人系统。它通过Stripe API获取所有收费记录，并利用HubSpot API更新联系人信息。工作流将创建一个新的HubSpot属性来存储累计收费金额。若该属性已存在，则直接更新属性值。\n\n## 前提条件\n\n* [Stripe凭证](https://docs.n8n.io/integrations/builtin/credentials/stripe/)\n* [HubSpot凭证](https://docs.n8n.io/integrations/builtin/credentials/hubspot/)\n\n## 运作流程\n\n1. 按计划周期检查HubSpot中是否存在该属性，若不存在则创建（默认每天午夜执行一次）\n2. 确认属性存在后，首个Stripe节点将获取所有收费记录\n3. 获取收费记录后，第二个Stripe节点将补充客户详细信息\n4. 客户信息返回后，\"合并数据\"节点会将客户信息与收费记录整合，供后续\"汇总统计\"节点计算每个联系人的累计收费金额\n5. 获得各联系人累计金额后，\"创建或更新客户\"节点将执行：若HubSpot中不存在该联系人则新建，若已存在则更新其累计收费金额",
  "title_zh": "将Stripe收费同步至HubSpot联系人",
  "publish_date_zh": "最后更新于10个月前",
  "workflow_json_zh": "{\n  \"meta\": {\n    \"instanceId\": \"a2434c94d549548a685cca39cc4614698e94f527bcea84eefa363f1037ae14cd\"\n  },\n  \"nodes\": [\n    {\n      \"id\": \"9be821db-fbc7-4168-962f-26c8382cefbf\",\n      \"name\": \"If charge has customer\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        1560,\n        880\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"string\": [\n            {\n              \"value1\": \"={{ $json[\\\"customer\\\"] }}\",\n              \"operation\": \"isNotEmpty\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"d06bae31-6856-4941-b86c-c611fc9d3da6\",\n      \"name\": \"Get customer\",\n      \"type\": \"n8n-nodes-base.stripe\",\n      \"position\": [\n        2160,\n        920\n      ],\n      \"parameters\": {\n        \"resource\": \"customer\",\n        \"customerId\": \"={{ $json[\\\"customer\\\"] }}\"\n      },\n      \"credentials\": {\n        \"stripeApi\": {\n          \"id\": \"22\",\n          \"name\": \"[UPDATE ME]\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"4e0d87bf-084f-4958-b2d3-cf7985f8c901\",\n      \"name\": \"On schedule\",\n      \"type\": \"n8n-nodes-base.scheduleTrigger\",\n      \"position\": [\n        -400,\n        1400\n      ],\n      \"parameters\": {\n        \"rule\": {\n          \"interval\": [\n            {}\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"fb620c92-5e22-4a9c-9320-847442b5e955\",\n      \"name\": \"Remove duplicate customers\",\n      \"type\": \"n8n-nodes-base.itemLists\",\n      \"position\": [\n        1880,\n        920\n      ],\n      \"parameters\": {\n        \"compare\": \"selectedFields\",\n        \"options\": {\n          \"removeOtherFields\": true\n        },\n        \"operation\": \"removeDuplicates\",\n        \"fieldsToCompare\": {\n          \"fields\": [\n            {\n              \"fieldName\": \"customer\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"3ad7554d-24b3-4ee2-8136-6a151bf06c71\",\n      \"name\": \"Aggregate `amount_captured`\",\n      \"type\": \"n8n-nodes-base.itemLists\",\n      \"position\": [\n        1880,\n        540\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"operation\": \"aggregateItems\",\n        \"fieldsToAggregate\": {\n          \"fieldToAggregate\": [\n            {\n              \"fieldToAggregate\": \"amount_captured\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"c8448580-40f2-4cf6-87ba-80903555d5a5\",\n      \"name\": \"Aggregate totals\",\n      \"type\": \"n8n-nodes-base.code\",\n      \"position\": [\n        2820,\n        1360\n      ],\n      \"parameters\": {\n        \"jsCode\": \"// aggregate `amounts_captured` with the customer, taking note \\n// that `aggregateAmountsPerContact` is the value in cents\\nconst aggregateAmountsPerContact = new Object();\\nfor (const item of $input.all()) {\\n  if (aggregateAmountsPerContact[item.json.email] == null) {\\n    aggregateAmountsPerContact[item.json.email] = 0;\\n  }\\n  aggregateAmountsPerContact[item.json.email] += item.json.amount_captured;\\n}\\n\\n// parse the data in a way that is usable in future nodes, and\\n// converts amounts from cents to dollars\\nconst parsed = [];\\nfor (const contact of Object.keys(aggregateAmountsPerContact)) {\\n    parsed.push({\\n        email: contact,\\n        amount_captured: aggregateAmountsPerContact[contact] / 100\\n    });\\n}\\n\\nreturn parsed;\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"dedaf89e-84d1-4964-9c87-94beea4adf26\",\n      \"name\": \"Create or update customer\",\n      \"type\": \"n8n-nodes-base.hubspot\",\n      \"position\": [\n        3140,\n        1360\n      ],\n      \"parameters\": {\n        \"email\": \"={{$node[\\\"Aggregate totals\\\"].json[\\\"email\\\"]}}\",\n        \"resource\": \"contact\",\n        \"authentication\": \"oAuth2\",\n        \"additionalFields\": {\n          \"customPropertiesUi\": {\n            \"customPropertiesValues\": [\n              {\n                \"value\": \"={{$node[\\\"Aggregate totals\\\"].json[\\\"amount_captured\\\"]}}\",\n                \"property\": \"={{$(\\\"Configure\\\").first().json[\\\"contactPropertyId\\\"]}}\"\n              }\n            ]\n          }\n        }\n      },\n      \"credentials\": {\n        \"hubspotOAuth2Api\": {\n          \"id\": \"11\",\n          \"name\": \"[UPDATE ME]\"\n        }\n      },\n      \"notesInFlow\": false,\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"4c419e90-facc-4a64-83f2-d349264338c6\",\n      \"name\": \"Merge data\",\n      \"type\": \"n8n-nodes-base.merge\",\n      \"position\": [\n        2520,\n        1360\n      ],\n      \"parameters\": {\n        \"mode\": \"combine\",\n        \"options\": {},\n        \"mergeByFields\": {\n          \"values\": [\n            {\n              \"field1\": \"id\",\n              \"field2\": \"customer\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"6a21495f-e567-4b0f-b584-34306bf7fa18\",\n      \"name\": \"Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        2460,\n        1160\n      ],\n      \"parameters\": {\n        \"width\": 219.61431588546765,\n        \"height\": 378.32426823578305,\n        \"content\": \"### `合并数据`\\n具体来说，我们将来自`获取交易`和`获取客户`节点的Stripe数据进行合并。只有那些关联了客户的交易记录才会被保留下来。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"7319c8fe-9e55-43d9-a634-3a7884268016\",\n      \"name\": \"Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        2760,\n        1160\n      ],\n      \"parameters\": {\n        \"width\": 218.46574043407196,\n        \"height\": 379.1631729345614,\n        \"content\": \"### `汇总总计`\\n根据合并后的数据，我们现在将来自客户/联系人的费用金额进行汇总。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"c24d972b-270d-4467-9352-4ced18e377c0\",\n      \"name\": \"Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1780,\n        400\n      ],\n      \"parameters\": {\n        \"width\": 297.57428772569784,\n        \"height\": 325.06310253513686,\n        \"content\": \"### ``汇总 `amount_captured` ``\\n此操作无实际功能，仅作为查询Stripe系统中所有费用总和的替代方法，可能对调试有所帮助。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"43da8885-fac3-4cb7-9f01-c4770cd0b030\",\n      \"name\": \"Get all charges\",\n      \"type\": \"n8n-nodes-base.stripe\",\n      \"position\": [\n        1300,\n        1380\n      ],\n      \"parameters\": {\n        \"resource\": \"charge\",\n        \"operation\": \"getAll\",\n        \"returnAll\": true\n      },\n      \"credentials\": {\n        \"stripeApi\": {\n          \"id\": \"22\",\n          \"name\": \"[UPDATE ME]\"\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"abfe75f5-c36f-4904-a703-cb8d1d83b686\",\n      \"name\": \"Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -960,\n        1220\n      ],\n      \"parameters\": {\n        \"width\": 504,\n        \"height\": 510.0404950205649,\n        \"content\": \"## 同步Stripe收费记录至HubSpot联系人  \\n该工作流将Stripe收费记录推送至HubSpot联系人，通过Stripe API获取所有收费记录，并利用HubSpot API更新联系人信息。工作流将创建一个新的HubSpot属性来存储总收费金额，若属性已存在则会进行更新。\\n\\n### 运行原理  \\n1. **定时获取收费记录**：首个Stripe节点按计划获取所有收费记录（默认每日午夜执行一次）  \\n2. **补充客户信息**：第二个Stripe节点在获取收费记录后，进一步获取客户详细信息  \\n3. **数据合并**：`Merge data`节点将客户信息与收费记录合并，供后续`Aggregate totals`节点计算每位联系人的总收费金额  \\n4. **更新联系人属性**：`Create or update customer`节点将创建新的HubSpot属性存储总金额（若属性已存在则直接更新）  \\n\\n工作流作者：[David Sha](https://davidsha.me)  \\n\\n（注：保留英文专有名词\\\"Stripe/HubSpot/API\\\"及节点名称不译，技术术语如\\\"node/workflow\\\"分别译为\\\"节点/工作流\\\"，时间描述\\\"midnight\\\"本地化为\\\"午夜\\\"，链接与署名格式保持原貌）\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"67e44a47-18db-48a3-a08e-c4f2afb13a30\",\n      \"name\": \"Note4\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1780,\n        760\n      ],\n      \"parameters\": {\n        \"width\": 298.2919335506821,\n        \"height\": 339.6783118583311,\n        \"content\": \"### `去除重复客户`\\n确保我们不会不必要地频繁查询Stripe。如果多个收费对应同一客户，系统将避免重复获取相同信息。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"02d46492-f3ba-47fe-ba88-f2baad30fc73\",\n      \"name\": \"Get HubSpot field\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        580,\n        1540\n      ],\n      \"parameters\": {\n        \"url\": \"=https://api.hubapi.com/crm/v3/properties/contact/{{$(\\\"Configure\\\").first().json[\\\"contactPropertyId\\\"]}}\",\n        \"options\": {},\n        \"authentication\": \"predefinedCredentialType\",\n        \"nodeCredentialType\": \"hubspotOAuth2Api\"\n      },\n      \"credentials\": {\n        \"hubspotOAuth2Api\": {\n          \"id\": \"11\",\n          \"name\": \"[UPDATE ME]\"\n        }\n      },\n      \"typeVersion\": 3,\n      \"continueOnFail\": true\n    },\n    {\n      \"id\": \"827882c4-5d3f-4cc6-b876-ae575a9a1b36\",\n      \"name\": \"Create field in HubSpot\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        980,\n        1660\n      ],\n      \"parameters\": {\n        \"url\": \"https://api.hubapi.com/crm/v3/properties/contact\",\n        \"method\": \"POST\",\n        \"options\": {\n          \"response\": {\n            \"response\": {\n              \"neverError\": true\n            }\n          }\n        },\n        \"sendBody\": true,\n        \"authentication\": \"predefinedCredentialType\",\n        \"bodyParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"name\",\n              \"value\": \"={{$(\\\"Configure\\\").first().json[\\\"contactPropertyId\\\"]}}\"\n            },\n            {\n              \"name\": \"label\",\n              \"value\": \"={{$(\\\"Configure\\\").first().json[\\\"contactPropertyLabelName\\\"]}}\"\n            },\n            {\n              \"name\": \"type\",\n              \"value\": \"number\"\n            },\n            {\n              \"name\": \"fieldType\",\n              \"value\": \"number\"\n            },\n            {\n              \"name\": \"groupName\",\n              \"value\": \"contactinformation\"\n            },\n            {\n              \"name\": \"formField\",\n              \"value\": \"false\"\n            },\n            {\n              \"name\": \"description\",\n              \"value\": \"=The total spend determined by the charges in Stripe. This is a field required for \\\"{{$workflow.name}}\\\" n8n workflow.\"\n            }\n          ]\n        },\n        \"nodeCredentialType\": \"hubspotOAuth2Api\"\n      },\n      \"credentials\": {\n        \"hubspotOAuth2Api\": {\n          \"id\": \"11\",\n          \"name\": \"[UPDATE ME]\"\n        }\n      },\n      \"typeVersion\": 3\n    },\n    {\n      \"id\": \"b4092718-bf35-49b5-aefa-b9900596fcb5\",\n      \"name\": \"Note5\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        500,\n        1480\n      ],\n      \"parameters\": {\n        \"width\": 656.5118956254801,\n        \"height\": 367.20468504951214,\n        \"content\": \"### 若需创建HubSpot字段\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"6d74e2e3-bd95-4ccb-89c0-3d6f8f1e01f9\",\n      \"name\": \"Configure\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        -80,\n        1400\n      ],\n      \"parameters\": {\n        \"values\": {\n          \"string\": [\n            {\n              \"name\": \"contactPropertyId\",\n              \"value\": \"stripe___total_spend\"\n            },\n            {\n              \"name\": \"contactPropertyLabelName\",\n              \"value\": \"Stripe - Total Spend\"\n            }\n          ],\n          \"boolean\": [\n            {\n              \"name\": \"checkFields\",\n              \"value\": true\n            }\n          ]\n        },\n        \"options\": {}\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"8a8262bc-0742-4529-9f10-328c338854fe\",\n      \"name\": \"Note6\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        -200,\n        1340\n      ],\n      \"parameters\": {\n        \"width\": 338.8262165118159,\n        \"height\": 505.43603897947025,\n        \"content\": \"### 配置\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"fc640a31-2050-4276-a1f7-8154f61d2729\",\n      \"name\": \"Note7\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        3080,\n        1160\n      ],\n      \"parameters\": {\n        \"width\": 219.86482940052417,\n        \"height\": 377.58888520886353,\n        \"content\": \"### `创建或更新客户`\\n默认情况下，仅更新“Stripe - 总消费”字段。联系人通过其电子邮件进行识别。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"c91295e6-0306-4f3d-adcf-923fbef1c173\",\n      \"name\": \"Skip field checking\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        240,\n        1400\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"boolean\": [\n            {\n              \"value1\": \"={{$node[\\\"Configure\\\"].json[\\\"checkFields\\\"]}}\",\n              \"value2\": \"={{false}}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"8f8b5a15-4895-4c5a-b8ba-8592dd754aca\",\n      \"name\": \"Do nothing\",\n      \"type\": \"n8n-nodes-base.noOp\",\n      \"position\": [\n        1880,\n        1240\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b953e439-955c-4046-9000-32cbb3577c27\",\n      \"name\": \"Note8\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1780,\n        1140\n      ],\n      \"parameters\": {\n        \"width\": 298.2919335506821,\n        \"height\": 247.94509463108915,\n        \"content\": \"### `无操作`\\n这有助于了解哪些Stripe收费未关联任何客户。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"ec2116e5-2a4a-4edf-a816-b15c349f23e0\",\n      \"name\": \"If field exists\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        780,\n        1540\n      ],\n      \"parameters\": {\n        \"conditions\": {\n          \"number\": [\n            {\n              \"value1\": \"={{ $json[\\\"error\\\"][\\\"httpCode\\\"] }}\",\n              \"value2\": \"404\",\n              \"operation\": \"notEqual\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 1\n    }\n  ],\n  \"connections\": {\n    \"Configure\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Skip field checking\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Merge data\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Aggregate totals\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"On schedule\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Configure\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get customer\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Merge data\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get all charges\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"If charge has customer\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Merge data\",\n            \"type\": \"main\",\n            \"index\": 1\n          }\n        ]\n      ]\n    },\n    \"If field exists\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get all charges\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Create field in HubSpot\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Aggregate totals\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Create or update customer\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Get HubSpot field\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"If field exists\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Skip field checking\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get all charges\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Get HubSpot field\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"If charge has customer\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Remove duplicate customers\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Aggregate `amount_captured`\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Do nothing\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Create field in HubSpot\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get all charges\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Remove duplicate customers\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get customer\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}"
}