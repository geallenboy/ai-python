{
  "title": "Parse DMARC reports, save them in database and notify on DKIM or SPF error",
  "url": "https://n8n.io/workflows/2369-parse-dmarc-reports-save-them-in-database-and-notify-on-dkim-or-spf-error/",
  "category": "ITOps",
  "category_url": "https://n8n.io/workflows/categories/it-ops/?sort=createdAt:desc",
  "author": "Łukasz",
  "publish_date": "Last update 9 months ago",
  "publish_date_absolute": "2024-08-07",
  "content": "",
  "workflow_json": "{\"id\":\"ATxZ5QYhdJq9mZDO\",\"meta\":{\"instanceId\":\"bdce9ec27bbe2b742054f01d034b8b468d2e7758edd716403ad5bd4583a8f649\",\"templateCredsSetupCompleted\":true},\"name\":\"Parse DMARC reports\",\"tags\":[{\"id\":\"w055QEEFrp6ZYNCr\",\"name\":\"DevOps\",\"createdAt\":\"2023-12-19T18:45:02.513Z\",\"updatedAt\":\"2023-12-19T18:45:02.513Z\"}],\"nodes\":[{\"id\":\"ce9ce59c-3cf6-45db-97fc-825cb8516da8\",\"name\":\"Email Trigger (IMAP)\",\"type\":\"n8n-nodes-base.emailReadImap\",\"position\":[580,300],\"parameters\":{\"options\":{},\"downloadAttachments\":true},\"credentials\":{\"imap\":{\"id\":\"vx30lEB3JcemyffM\",\"name\":\"IMAP account\"}},\"typeVersion\":2},{\"id\":\"903f949d-ab1e-48ec-a903-a1ebde4cfbe9\",\"name\":\"End date format\",\"type\":\"n8n-nodes-base.dateTime\",\"position\":[800,880],\"parameters\":{\"date\":\"={{ $json.date_range_end.toDateTime('s') }}\",\"format\":\"custom\",\"options\":{\"includeInputFields\":true},\"operation\":\"formatDate\",\"customFormat\":\"yyyy-MM-dd hh:mm:ss\",\"outputFieldName\":\"=date_range_end\"},\"typeVersion\":2},{\"id\":\"3303e551-8557-4220-ab24-48fcb0859a26\",\"name\":\"If multiple records to parse\",\"type\":\"n8n-nodes-base.if\",\"position\":[560,620],\"parameters\":{\"options\":{},\"conditions\":{\"options\":{\"leftValue\":\"\",\"caseSensitive\":true,\"typeValidation\":\"strict\"},\"combinator\":\"and\",\"conditions\":[{\"id\":\"b809e758-c3d2-4cbf-bab8-54d278a435dd\",\"operator\":{\"type\":\"object\",\"operation\":\"exists\",\"singleValue\":true},\"leftValue\":\"={{ $json.feedback.record[0] }}\",\"rightValue\":\"\"}]}},\"typeVersion\":2},{\"id\":\"513864bc-c124-452d-8be3-44feb73454ed\",\"name\":\"Map fields for DB input and parse\",\"type\":\"n8n-nodes-base.set\",\"position\":[1200,660],\"parameters\":{\"options\":{\"ignoreConversionErrors\":true},\"assignments\":{\"assignments\":[{\"id\":\"621508ee-fbea-4233-aaf3-96b573a60bd5\",\"name\":\"full_data\",\"type\":\"object\",\"value\":\"={{ $json.feedback }}\"},{\"id\":\"d605e93a-0e0a-4584-aa1e-e38b49f264e7\",\"name\":\"org_name\",\"type\":\"string\",\"value\":\"={{ $json.feedback.report_metadata.org_name }}\"},{\"id\":\"604a5573-67db-4bb6-80d8-4421dce2406b\",\"name\":\"date_range_begin\",\"type\":\"string\",\"value\":\"={{ $json.feedback.report_metadata.date_range.begin }}\"},{\"id\":\"b9d7244f-9d58-43fc-a477-f0750c31e5e2\",\"name\":\"date_range_end\",\"type\":\"string\",\"value\":\"={{ $json.feedback.report_metadata.date_range.end }}\"},{\"id\":\"3570869a-9dc9-4b20-b48c-5f382825d021\",\"name\":\"domain\",\"type\":\"string\",\"value\":\"={{ $json.feedback.policy_published.domain }}\"},{\"id\":\"979e4eb4-6e39-4a3c-8f0a-21ecf8086a3c\",\"name\":\"policy_published\",\"type\":\"object\",\"value\":\"={{ $json.feedback.policy_published }}\"},{\"id\":\"91cdfa19-49c6-4e5d-a423-d76bbb61eddc\",\"name\":\"source_ip\",\"type\":\"string\",\"value\":\"={{ $json['fbr'].row.source_ip }}\"},{\"id\":\"2434b04e-3c5e-4e61-8be9-1f9c1ec2a6ce\",\"name\":\"mail_count\",\"type\":\"string\",\"value\":\"={{ $json['fbr'].row.count }}\"},{\"id\":\"09b73b84-0f6a-443b-8da0-c7ad9742a9c1\",\"name\":\"evaluated_disposition\",\"type\":\"string\",\"value\":\"={{ $json['fbr'].row.policy_evaluated.disposition }}\"},{\"id\":\"6c8e81ab-abc6-497c-8919-6b2e8008a1e8\",\"name\":\"evaluated_dkim\",\"type\":\"string\",\"value\":\"={{ $json['fbr'].row.policy_evaluated.dkim }}\"},{\"id\":\"fa8ca9d6-5e1b-402c-9afc-e6bf42e2c6ad\",\"name\":\"evaluated_spf\",\"type\":\"string\",\"value\":\"={{ $json['fbr'].row.policy_evaluated.spf }}\"},{\"id\":\"42f269c3-978a-45f6-bfe5-1fa1536500fb\",\"name\":\"identifiers\",\"type\":\"object\",\"value\":\"={{ $json['fbr'].identifiers }}\"},{\"id\":\"3375dc26-a739-4bf9-8a46-2f6739337921\",\"name\":\"auth_results\",\"type\":\"object\",\"value\":\"={{ $json['fbr'].auth_results }}\"}]}},\"typeVersion\":3.4},{\"id\":\"00cca3ae-1f0a-4ea9-8fb7-ac52d35c261b\",\"name\":\"Begin format date\",\"type\":\"n8n-nodes-base.dateTime\",\"position\":[560,880],\"parameters\":{\"date\":\"={{ $json.date_range_begin.toDateTime('s') }}\",\"format\":\"custom\",\"options\":{\"includeInputFields\":true},\"operation\":\"formatDate\",\"customFormat\":\"yyyy-MM-dd hh:mm:ss\",\"outputFieldName\":\"=date_range_begin\"},\"typeVersion\":2},{\"id\":\"18c2305a-db44-4e4d-97b9-1f04018085b0\",\"name\":\"Input into database\",\"type\":\"n8n-nodes-base.mySql\",\"position\":[620,1100],\"parameters\":{\"table\":{\"__rl\":true,\"mode\":\"list\",\"value\":\"dmarc\",\"cachedResultName\":\"dmarc\"},\"options\":{\"detailedOutput\":true},\"dataMode\":\"defineBelow\",\"valuesToSend\":{\"values\":[{\"value\":\"={{ $json.full_data.toJsonString() }}\",\"column\":\"full_data\"},{\"value\":\"={{ $json.org_name }}\",\"column\":\"org_name\"},{\"value\":\"={{ $json.date_range_begin }}\",\"column\":\"date_range_begin\"},{\"value\":\"={{ $json.date_range_end }}\",\"column\":\"date_range_end\"},{\"value\":\"={{ $json.domain }}\",\"column\":\"domain\"},{\"value\":\"={{ $json.policy_published.toJsonString() }}\",\"column\":\"policy_published\"},{\"value\":\"={{ $json.source_ip }}\",\"column\":\"source_ip\"},{\"value\":\"={{ $json.mail_count }}\",\"column\":\"mail_count\"},{\"value\":\"={{ $json.evaluated_disposition }}\",\"column\":\"evaluated_disposition\"},{\"value\":\"={{ $json.evaluated_dkim }}\",\"column\":\"evaluated_dkim\"},{\"value\":\"={{ $json.evaluated_spf }}\",\"column\":\"evaluated_spf\"},{\"value\":\"={{ $json.identifiers == null ? null : $json.identifiers.toJsonString() }}\",\"column\":\"identifiers\"},{\"value\":\"={{ $json.auth_results == null ? null : $json.auth_results.toJsonString() }}\",\"column\":\"auth_results\"}]}},\"credentials\":{\"mySql\":{\"id\":\"HFwF4pL62FWEFHqR\",\"name\":\"MySQL account\"}},\"typeVersion\":2.4},{\"id\":\"c65c4cfb-3912-4b45-a5e0-3ab787e018c8\",\"name\":\"If issue with DKIM or SPF\",\"type\":\"n8n-nodes-base.if\",\"position\":[580,1260],\"parameters\":{\"options\":{},\"conditions\":{\"options\":{\"leftValue\":\"\",\"caseSensitive\":true,\"typeValidation\":\"strict\"},\"combinator\":\"or\",\"conditions\":[{\"id\":\"818b461b-4bdc-4842-9f89-d1d8966b8c0a\",\"operator\":{\"type\":\"string\",\"operation\":\"notEquals\"},\"leftValue\":\"={{ $json.evaluated_dkim }}\",\"rightValue\":\"pass\"},{\"id\":\"4322cb26-5ff1-4278-94ae-7ff278c61c6c\",\"operator\":{\"type\":\"string\",\"operation\":\"notEquals\"},\"leftValue\":\"={{ $json.evaluated_spf }}\",\"rightValue\":\"pass\"}]}},\"typeVersion\":2},{\"id\":\"5d17bf15-ecef-40e8-acc4-6af5ad1c712d\",\"name\":\"Rename Keys\",\"type\":\"n8n-nodes-base.renameKeys\",\"position\":[1000,500],\"parameters\":{\"keys\":{\"key\":[{\"newKey\":\"fbr\",\"currentKey\":\"feedback.record\"}]},\"additionalOptions\":{}},\"typeVersion\":1},{\"id\":\"0e2b8c73-0f53-46f9-9692-cbe87c97862d\",\"name\":\"Rename column for consistency\",\"type\":\"n8n-nodes-base.set\",\"position\":[800,660],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"f563d673-bc82-4863-b132-d431ebe8f651\",\"name\":\"fbr\",\"type\":\"object\",\"value\":\"={{ $json.feedback.record }}\"}]},\"includeOtherFields\":true},\"typeVersion\":3.4},{\"id\":\"5796c124-645d-460e-88df-0a909a33b6b1\",\"name\":\"Sticky Note\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[100,300],\"parameters\":{\"width\":394.2691415313225,\"height\":304.36194895591655,\"content\":\"## How it works\\n- monitor postmaster email for DKIM reprots\\n- unpack report and parse XML\\n- map and format fields for DB input\\n\\t- input into database\\n\\t- send notification on DKIM or SPF failure\\n\\n## Remember to set up\\n- email input mailbox\\n- notification channels\"},\"typeVersion\":1},{\"id\":\"1457272e-630e-44ee-bb18-ac650d192cbf\",\"name\":\"Unzip File\",\"type\":\"n8n-nodes-base.compression\",\"position\":[800,300],\"parameters\":{\"binaryPropertyName\":\"attachment_0\"},\"typeVersion\":1.1},{\"id\":\"89ade90c-c7e3-4c6f-89cf-0e7ce1e55333\",\"name\":\"Extract XML data\",\"type\":\"n8n-nodes-base.extractFromFile\",\"position\":[1020,300],\"parameters\":{\"options\":{},\"operation\":\"xml\",\"binaryPropertyName\":\"file_0\"},\"typeVersion\":1},{\"id\":\"8fd70f3c-53d5-4d99-ad2c-d526089fe0f5\",\"name\":\"Parse XML data to JSON\",\"type\":\"n8n-nodes-base.xml\",\"position\":[1220,300],\"parameters\":{\"options\":{}},\"typeVersion\":1},{\"id\":\"b17352d9-135a-4c26-993f-0c1fdafc1fa3\",\"name\":\"Sticky Note1\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1420,300],\"parameters\":{\"width\":394.2691415313225,\"height\":159.80531276753783,\"content\":\"## Preparation\\nThis line is responsible for taking data from email and parsing it into JSON understandable by n8n\"},\"typeVersion\":1},{\"id\":\"31d2f822-aea6-41b4-bb1e-25b48cb3e972\",\"name\":\"Sticky Note2\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1420,500],\"parameters\":{\"width\":394.2691415313225,\"height\":316.3177609714967,\"content\":\"## Mapping\\nThis line is responsible for treating cases when XML has multiple info for domain. One DMARC report can contain more than one entries.\\n\\nLast node is responsible for matching data with database structure\"},\"typeVersion\":1},{\"id\":\"e8fc0f91-1bdf-4bc5-b488-4f2c169da9c0\",\"name\":\"Split Out For Separate Entries\",\"type\":\"n8n-nodes-base.splitOut\",\"position\":[800,500],\"parameters\":{\"include\":\"allOtherFields\",\"options\":{},\"fieldToSplitOut\":\"feedback.record\"},\"typeVersion\":1},{\"id\":\"9ba7a0b8-80e6-4559-83ec-894533194dc7\",\"name\":\"Sticky Note3\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1420,860],\"parameters\":{\"width\":394.2691415313225,\"height\":185.89072080153096,\"content\":\"## Date translate\\nThis line is responsible for translating date format into understandable by MySQL/MariaDB\\n\\nIn next node data is being input into MySQL/MariaDB \"},\"typeVersion\":1},{\"id\":\"96461e30-87f0-48f1-a43f-60185ea1d835\",\"name\":\"Sticky Note4\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1420,1180],\"parameters\":{\"width\":394.2691415313225,\"height\":320.66532897716223,\"content\":\"## Notifications\\nLast two nodes are responsible for sending notifications in case IF inside DMARC report is reported any issue with SPF or DKIM\"},\"typeVersion\":1},{\"id\":\"192b95c6-cdfe-4b5e-94e1-94deb728b0e2\",\"name\":\"Slack Post Message On Channel\",\"type\":\"n8n-nodes-base.slack\",\"disabled\":true,\"position\":[1200,1180],\"parameters\":{\"text\":\"=DMARC evaluation failed for {{ $json.domain }} on  {{ $json.mail_count }} mails with disposition:  {{ $json.evaluated_disposition }}. DKIM:  {{ $json.evaluated_dkim }} SPF:  {{ $json.evaluated_spf }}\",\"select\":\"channel\",\"channelId\":{\"__rl\":true,\"mode\":\"list\",\"value\":\"CCGJA1F1N\",\"cachedResultName\":\"powiadomienia\"},\"otherOptions\":{},\"authentication\":\"oAuth2\"},\"credentials\":{\"slackOAuth2Api\":{\"id\":\"B0jUtT53pVAEPaQM\",\"name\":\"Slack Oauth\"}},\"typeVersion\":2.2},{\"id\":\"ce400c97-cae4-41db-ad8f-e678fc4a27fe\",\"name\":\"Send Error Notification Email\",\"type\":\"n8n-nodes-base.emailSend\",\"disabled\":true,\"position\":[1200,1380],\"parameters\":{\"text\":\"DMARC evaluation failed for {{ $json.domain }} on  {{ $json.mail_count }} mails with disposition:  {{ $json.evaluated_disposition }}. DKIM:  {{ $json.evaluated_dkim }} SPF:  {{ $json.evaluated_spf }}\",\"options\":{},\"subject\":\"DMARC problem\",\"emailFormat\":\"text\"},\"typeVersion\":2.1}],\"active\":true,\"pinData\":{},\"settings\":{\"callerPolicy\":\"workflowsFromSameOwner\",\"errorWorkflow\":\"5\",\"executionOrder\":\"v1\",\"saveManualExecutions\":true,\"saveExecutionProgress\":true,\"saveDataSuccessExecution\":\"all\"},\"versionId\":\"1add308c-4aef-4a83-a958-bc66dead234f\",\"connections\":{\"Unzip File\":{\"main\":[[{\"node\":\"Extract XML data\",\"type\":\"main\",\"index\":0}]]},\"Rename Keys\":{\"main\":[[{\"node\":\"Map fields for DB input and parse\",\"type\":\"main\",\"index\":0}]]},\"End date format\":{\"main\":[[{\"node\":\"Input into database\",\"type\":\"main\",\"index\":0},{\"node\":\"If issue with DKIM or SPF\",\"type\":\"main\",\"index\":0}]]},\"Extract XML data\":{\"main\":[[{\"node\":\"Parse XML data to JSON\",\"type\":\"main\",\"index\":0}]]},\"Begin format date\":{\"main\":[[{\"node\":\"End date format\",\"type\":\"main\",\"index\":0}]]},\"Email Trigger (IMAP)\":{\"main\":[[{\"node\":\"Unzip File\",\"type\":\"main\",\"index\":0}]]},\"Parse XML data to JSON\":{\"main\":[[{\"node\":\"If multiple records to parse\",\"type\":\"main\",\"index\":0}]]},\"If issue with DKIM or SPF\":{\"main\":[[{\"node\":\"Slack Post Message On Channel\",\"type\":\"main\",\"index\":0},{\"node\":\"Send Error Notification Email\",\"type\":\"main\",\"index\":0}]]},\"If multiple records to parse\":{\"main\":[[{\"node\":\"Split Out For Separate Entries\",\"type\":\"main\",\"index\":0}],[{\"node\":\"Rename column for consistency\",\"type\":\"main\",\"index\":0}]]},\"Rename column for consistency\":{\"main\":[[{\"node\":\"Map fields for DB input and parse\",\"type\":\"main\",\"index\":0}]]},\"Split Out For Separate Entries\":{\"main\":[[{\"node\":\"Rename Keys\",\"type\":\"main\",\"index\":0}]]},\"Map fields for DB input and parse\":{\"main\":[[{\"node\":\"Begin format date\",\"type\":\"main\",\"index\":0}]]}}}",
  "readme": "## Who is it for\n\nIf you are a postmaster or you manage email server, you can set up DKIM and SPF records to ensure that spoofing your email address is hard. On your domain you can also set up DMARC record to receive XML reports from email providers (rua tag). Those reports contain data if email they received passed DKIM and SPF verifications.\n\nSince DMARC email is public, you will receive a lot of emails from email providers, not only if DKIM/SPF fail. There is no need for it - you probably only need to know if SPF/DKIM failed.\n\nSo this script is intended to automatically parse all DMARC reports that come from email providers, but ONLY send you notification if SPF or DKIM failed - meaning that either someone tries to spoof your email or your DKIM/SPF is improperly set up.\n\n## How it works\n\n  * script monitors postmaster email for DMARC reprots (rua)\n  * unpacks report and parses XML into JSON\n  * maps JSON and formats fields for MySQL/MariaDB input \n    * inputs into database\n    * sends notification on DKIM or SPF failure\n\n\n\n## Remember to set up\n\n  * email input mailbox\n  * notification channels \n    * for slack\n    * for email\n\n\n",
  "readme_html": "<!--[--><div data-v-50766329=\"\"><h2>Who is it for</h2>\n<p>If you are a postmaster or you manage email server, you can set up DKIM and SPF records to ensure that spoofing your email address is hard. On your domain you can also set up DMARC record to receive XML reports from email providers (rua tag). Those reports contain data if email they received passed DKIM and SPF verifications.</p>\n<p>Since DMARC email is public, you will receive a lot of emails from email providers, not only if DKIM/SPF fail. There is no need for it - you probably only need to know if SPF/DKIM failed.</p>\n<p>So this script is intended to automatically parse all DMARC reports that come from email providers, but ONLY send you notification if SPF or DKIM failed - meaning that either someone tries to spoof your email or your DKIM/SPF is improperly set up.</p>\n<h2>How it works</h2>\n<ul>\n<li>script monitors postmaster email for DMARC reprots (rua)</li>\n<li>unpacks report and parses XML into JSON</li>\n<li>maps JSON and formats fields for MySQL/MariaDB input\n<ul>\n<li>inputs into database</li>\n<li>sends notification on DKIM or SPF failure</li>\n</ul>\n</li>\n</ul>\n<h2>Remember to set up</h2>\n<ul>\n<li>email input mailbox</li>\n<li>notification channels\n<ul>\n<li>for slack</li>\n<li>for email</li>\n</ul>\n</li>\n</ul>\n</div><!--]-->",
  "readme_zh": "## 适用对象\n\n若您身为邮局管理员或负责管理邮件服务器，可通过配置DKIM与SPF记录有效防范发件人伪造。您还可在域名上设置DMARC记录（使用rua标签），用于接收来自邮件服务商的XML格式验证报告。这些报告将详细记录每封接收邮件是否通过DKIM及SPF验证。\n\n由于DMARC报告邮件是公开机制，您将收到大量来自各邮件服务商的报告，其中多数为验证成功的常规通知。实际上，您可能仅需关注SPF/DKIM验证失败的异常情况。\n\n本脚本专为自动处理所有DMARC报告而设计，但仅当SPF或DKIM验证失败时向您发送警报——这意味着要么存在伪造您邮箱的可疑行为，要么您的DKIM/SPF配置有误。\n\n## 工作原理\n\n  * 脚本实时监控邮局管理员邮箱中的DMARC报告（rua）\n  * 解压报告并将XML解析为JSON格式\n  * 将JSON数据映射并格式化为MySQL/MariaDB可识别的字段\n    * 将数据写入数据库\n    * 当DKIM或SPF验证失败时触发通知\n\n## 配置须知\n\n  * 设置接收报告的邮箱\n  * 配置通知渠道：\n    * Slack通知\n    * 邮件通知",
  "title_zh": "解析DMARC报告，将其存入数据库并在DKIM或SPF出现错误时发出通知",
  "publish_date_zh": "最后更新于9个月前",
  "workflow_json_zh": "{\n  \"id\": \"ATxZ5QYhdJq9mZDO\",\n  \"meta\": {\n    \"instanceId\": \"bdce9ec27bbe2b742054f01d034b8b468d2e7758edd716403ad5bd4583a8f649\",\n    \"templateCredsSetupCompleted\": true\n  },\n  \"name\": \"Parse DMARC reports\",\n  \"tags\": [\n    {\n      \"id\": \"w055QEEFrp6ZYNCr\",\n      \"name\": \"DevOps\",\n      \"createdAt\": \"2023-12-19T18:45:02.513Z\",\n      \"updatedAt\": \"2023-12-19T18:45:02.513Z\"\n    }\n  ],\n  \"nodes\": [\n    {\n      \"id\": \"ce9ce59c-3cf6-45db-97fc-825cb8516da8\",\n      \"name\": \"Email Trigger (IMAP)\",\n      \"type\": \"n8n-nodes-base.emailReadImap\",\n      \"position\": [\n        580,\n        300\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"downloadAttachments\": true\n      },\n      \"credentials\": {\n        \"imap\": {\n          \"id\": \"vx30lEB3JcemyffM\",\n          \"name\": \"IMAP account\"\n        }\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"903f949d-ab1e-48ec-a903-a1ebde4cfbe9\",\n      \"name\": \"End date format\",\n      \"type\": \"n8n-nodes-base.dateTime\",\n      \"position\": [\n        800,\n        880\n      ],\n      \"parameters\": {\n        \"date\": \"={{ $json.date_range_end.toDateTime('s') }}\",\n        \"format\": \"custom\",\n        \"options\": {\n          \"includeInputFields\": true\n        },\n        \"operation\": \"formatDate\",\n        \"customFormat\": \"yyyy-MM-dd hh:mm:ss\",\n        \"outputFieldName\": \"=date_range_end\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"3303e551-8557-4220-ab24-48fcb0859a26\",\n      \"name\": \"If multiple records to parse\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        560,\n        620\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"conditions\": {\n          \"options\": {\n            \"leftValue\": \"\",\n            \"caseSensitive\": true,\n            \"typeValidation\": \"strict\"\n          },\n          \"combinator\": \"and\",\n          \"conditions\": [\n            {\n              \"id\": \"b809e758-c3d2-4cbf-bab8-54d278a435dd\",\n              \"operator\": {\n                \"type\": \"object\",\n                \"operation\": \"exists\",\n                \"singleValue\": true\n              },\n              \"leftValue\": \"={{ $json.feedback.record[0] }}\",\n              \"rightValue\": \"\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"513864bc-c124-452d-8be3-44feb73454ed\",\n      \"name\": \"Map fields for DB input and parse\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        1200,\n        660\n      ],\n      \"parameters\": {\n        \"options\": {\n          \"ignoreConversionErrors\": true\n        },\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"621508ee-fbea-4233-aaf3-96b573a60bd5\",\n              \"name\": \"full_data\",\n              \"type\": \"object\",\n              \"value\": \"={{ $json.feedback }}\"\n            },\n            {\n              \"id\": \"d605e93a-0e0a-4584-aa1e-e38b49f264e7\",\n              \"name\": \"org_name\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.feedback.report_metadata.org_name }}\"\n            },\n            {\n              \"id\": \"604a5573-67db-4bb6-80d8-4421dce2406b\",\n              \"name\": \"date_range_begin\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.feedback.report_metadata.date_range.begin }}\"\n            },\n            {\n              \"id\": \"b9d7244f-9d58-43fc-a477-f0750c31e5e2\",\n              \"name\": \"date_range_end\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.feedback.report_metadata.date_range.end }}\"\n            },\n            {\n              \"id\": \"3570869a-9dc9-4b20-b48c-5f382825d021\",\n              \"name\": \"domain\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json.feedback.policy_published.domain }}\"\n            },\n            {\n              \"id\": \"979e4eb4-6e39-4a3c-8f0a-21ecf8086a3c\",\n              \"name\": \"policy_published\",\n              \"type\": \"object\",\n              \"value\": \"={{ $json.feedback.policy_published }}\"\n            },\n            {\n              \"id\": \"91cdfa19-49c6-4e5d-a423-d76bbb61eddc\",\n              \"name\": \"source_ip\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json['fbr'].row.source_ip }}\"\n            },\n            {\n              \"id\": \"2434b04e-3c5e-4e61-8be9-1f9c1ec2a6ce\",\n              \"name\": \"mail_count\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json['fbr'].row.count }}\"\n            },\n            {\n              \"id\": \"09b73b84-0f6a-443b-8da0-c7ad9742a9c1\",\n              \"name\": \"evaluated_disposition\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json['fbr'].row.policy_evaluated.disposition }}\"\n            },\n            {\n              \"id\": \"6c8e81ab-abc6-497c-8919-6b2e8008a1e8\",\n              \"name\": \"evaluated_dkim\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json['fbr'].row.policy_evaluated.dkim }}\"\n            },\n            {\n              \"id\": \"fa8ca9d6-5e1b-402c-9afc-e6bf42e2c6ad\",\n              \"name\": \"evaluated_spf\",\n              \"type\": \"string\",\n              \"value\": \"={{ $json['fbr'].row.policy_evaluated.spf }}\"\n            },\n            {\n              \"id\": \"42f269c3-978a-45f6-bfe5-1fa1536500fb\",\n              \"name\": \"identifiers\",\n              \"type\": \"object\",\n              \"value\": \"={{ $json['fbr'].identifiers }}\"\n            },\n            {\n              \"id\": \"3375dc26-a739-4bf9-8a46-2f6739337921\",\n              \"name\": \"auth_results\",\n              \"type\": \"object\",\n              \"value\": \"={{ $json['fbr'].auth_results }}\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"00cca3ae-1f0a-4ea9-8fb7-ac52d35c261b\",\n      \"name\": \"Begin format date\",\n      \"type\": \"n8n-nodes-base.dateTime\",\n      \"position\": [\n        560,\n        880\n      ],\n      \"parameters\": {\n        \"date\": \"={{ $json.date_range_begin.toDateTime('s') }}\",\n        \"format\": \"custom\",\n        \"options\": {\n          \"includeInputFields\": true\n        },\n        \"operation\": \"formatDate\",\n        \"customFormat\": \"yyyy-MM-dd hh:mm:ss\",\n        \"outputFieldName\": \"=date_range_begin\"\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"18c2305a-db44-4e4d-97b9-1f04018085b0\",\n      \"name\": \"Input into database\",\n      \"type\": \"n8n-nodes-base.mySql\",\n      \"position\": [\n        620,\n        1100\n      ],\n      \"parameters\": {\n        \"table\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"dmarc\",\n          \"cachedResultName\": \"dmarc\"\n        },\n        \"options\": {\n          \"detailedOutput\": true\n        },\n        \"dataMode\": \"defineBelow\",\n        \"valuesToSend\": {\n          \"values\": [\n            {\n              \"value\": \"={{ $json.full_data.toJsonString() }}\",\n              \"column\": \"full_data\"\n            },\n            {\n              \"value\": \"={{ $json.org_name }}\",\n              \"column\": \"org_name\"\n            },\n            {\n              \"value\": \"={{ $json.date_range_begin }}\",\n              \"column\": \"date_range_begin\"\n            },\n            {\n              \"value\": \"={{ $json.date_range_end }}\",\n              \"column\": \"date_range_end\"\n            },\n            {\n              \"value\": \"={{ $json.domain }}\",\n              \"column\": \"domain\"\n            },\n            {\n              \"value\": \"={{ $json.policy_published.toJsonString() }}\",\n              \"column\": \"policy_published\"\n            },\n            {\n              \"value\": \"={{ $json.source_ip }}\",\n              \"column\": \"source_ip\"\n            },\n            {\n              \"value\": \"={{ $json.mail_count }}\",\n              \"column\": \"mail_count\"\n            },\n            {\n              \"value\": \"={{ $json.evaluated_disposition }}\",\n              \"column\": \"evaluated_disposition\"\n            },\n            {\n              \"value\": \"={{ $json.evaluated_dkim }}\",\n              \"column\": \"evaluated_dkim\"\n            },\n            {\n              \"value\": \"={{ $json.evaluated_spf }}\",\n              \"column\": \"evaluated_spf\"\n            },\n            {\n              \"value\": \"={{ $json.identifiers == null ? null : $json.identifiers.toJsonString() }}\",\n              \"column\": \"identifiers\"\n            },\n            {\n              \"value\": \"={{ $json.auth_results == null ? null : $json.auth_results.toJsonString() }}\",\n              \"column\": \"auth_results\"\n            }\n          ]\n        }\n      },\n      \"credentials\": {\n        \"mySql\": {\n          \"id\": \"HFwF4pL62FWEFHqR\",\n          \"name\": \"MySQL account\"\n        }\n      },\n      \"typeVersion\": 2.4\n    },\n    {\n      \"id\": \"c65c4cfb-3912-4b45-a5e0-3ab787e018c8\",\n      \"name\": \"If issue with DKIM or SPF\",\n      \"type\": \"n8n-nodes-base.if\",\n      \"position\": [\n        580,\n        1260\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"conditions\": {\n          \"options\": {\n            \"leftValue\": \"\",\n            \"caseSensitive\": true,\n            \"typeValidation\": \"strict\"\n          },\n          \"combinator\": \"or\",\n          \"conditions\": [\n            {\n              \"id\": \"818b461b-4bdc-4842-9f89-d1d8966b8c0a\",\n              \"operator\": {\n                \"type\": \"string\",\n                \"operation\": \"notEquals\"\n              },\n              \"leftValue\": \"={{ $json.evaluated_dkim }}\",\n              \"rightValue\": \"pass\"\n            },\n            {\n              \"id\": \"4322cb26-5ff1-4278-94ae-7ff278c61c6c\",\n              \"operator\": {\n                \"type\": \"string\",\n                \"operation\": \"notEquals\"\n              },\n              \"leftValue\": \"={{ $json.evaluated_spf }}\",\n              \"rightValue\": \"pass\"\n            }\n          ]\n        }\n      },\n      \"typeVersion\": 2\n    },\n    {\n      \"id\": \"5d17bf15-ecef-40e8-acc4-6af5ad1c712d\",\n      \"name\": \"Rename Keys\",\n      \"type\": \"n8n-nodes-base.renameKeys\",\n      \"position\": [\n        1000,\n        500\n      ],\n      \"parameters\": {\n        \"keys\": {\n          \"key\": [\n            {\n              \"newKey\": \"fbr\",\n              \"currentKey\": \"feedback.record\"\n            }\n          ]\n        },\n        \"additionalOptions\": {}\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"0e2b8c73-0f53-46f9-9692-cbe87c97862d\",\n      \"name\": \"Rename column for consistency\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        800,\n        660\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"assignments\": {\n          \"assignments\": [\n            {\n              \"id\": \"f563d673-bc82-4863-b132-d431ebe8f651\",\n              \"name\": \"fbr\",\n              \"type\": \"object\",\n              \"value\": \"={{ $json.feedback.record }}\"\n            }\n          ]\n        },\n        \"includeOtherFields\": true\n      },\n      \"typeVersion\": 3.4\n    },\n    {\n      \"id\": \"5796c124-645d-460e-88df-0a909a33b6b1\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        100,\n        300\n      ],\n      \"parameters\": {\n        \"width\": 394.2691415313225,\n        \"height\": 304.36194895591655,\n        \"content\": \"## 工作原理\\n- 监控邮件服务器的DKIM报告邮件\\n- 解压报告并解析XML内容\\n- 映射并格式化字段以输入数据库\\n\\t- 将数据录入数据库\\n\\t- 当DKIM或SPF验证失败时发送通知\\n\\n## 需设置项\\n- 接收报告的邮箱账号\\n- 通知渠道配置\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"1457272e-630e-44ee-bb18-ac650d192cbf\",\n      \"name\": \"Unzip File\",\n      \"type\": \"n8n-nodes-base.compression\",\n      \"position\": [\n        800,\n        300\n      ],\n      \"parameters\": {\n        \"binaryPropertyName\": \"attachment_0\"\n      },\n      \"typeVersion\": 1.1\n    },\n    {\n      \"id\": \"89ade90c-c7e3-4c6f-89cf-0e7ce1e55333\",\n      \"name\": \"Extract XML data\",\n      \"type\": \"n8n-nodes-base.extractFromFile\",\n      \"position\": [\n        1020,\n        300\n      ],\n      \"parameters\": {\n        \"options\": {},\n        \"operation\": \"xml\",\n        \"binaryPropertyName\": \"file_0\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"8fd70f3c-53d5-4d99-ad2c-d526089fe0f5\",\n      \"name\": \"Parse XML data to JSON\",\n      \"type\": \"n8n-nodes-base.xml\",\n      \"position\": [\n        1220,\n        300\n      ],\n      \"parameters\": {\n        \"options\": {}\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b17352d9-135a-4c26-993f-0c1fdafc1fa3\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1420,\n        300\n      ],\n      \"parameters\": {\n        \"width\": 394.2691415313225,\n        \"height\": 159.80531276753783,\n        \"content\": \"## 准备工作\\n此流程负责从电子邮件中提取数据，并将其解析为n8n可理解的JSON格式\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"31d2f822-aea6-41b4-bb1e-25b48cb3e972\",\n      \"name\": \"Sticky Note2\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1420,\n        500\n      ],\n      \"parameters\": {\n        \"width\": 394.2691415313225,\n        \"height\": 316.3177609714967,\n        \"content\": \"## Mapping\\nThis line is responsible for treating cases when XML has multiple info for domain. One DMARC report can contain more than one entries.\\n\\nLast node is responsible for matching data with database structure\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"e8fc0f91-1bdf-4bc5-b488-4f2c169da9c0\",\n      \"name\": \"Split Out For Separate Entries\",\n      \"type\": \"n8n-nodes-base.splitOut\",\n      \"position\": [\n        800,\n        500\n      ],\n      \"parameters\": {\n        \"include\": \"allOtherFields\",\n        \"options\": {},\n        \"fieldToSplitOut\": \"feedback.record\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"9ba7a0b8-80e6-4559-83ec-894533194dc7\",\n      \"name\": \"Sticky Note3\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1420,\n        860\n      ],\n      \"parameters\": {\n        \"width\": 394.2691415313225,\n        \"height\": 185.89072080153096,\n        \"content\": \"## 日期转换\\n此行代码负责将日期格式转换为MySQL/MariaDB可识别的格式\\n\\n在下一个节点中，数据将被输入到MySQL/MariaDB数据库\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"96461e30-87f0-48f1-a43f-60185ea1d835\",\n      \"name\": \"Sticky Note4\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        1420,\n        1180\n      ],\n      \"parameters\": {\n        \"width\": 394.2691415313225,\n        \"height\": 320.66532897716223,\n        \"content\": \"## 通知功能  \\n最后两个节点负责在DMARC报告中如发现SPF或DKIM存在问题时发送通知。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"192b95c6-cdfe-4b5e-94e1-94deb728b0e2\",\n      \"name\": \"Slack Post Message On Channel\",\n      \"type\": \"n8n-nodes-base.slack\",\n      \"disabled\": true,\n      \"position\": [\n        1200,\n        1180\n      ],\n      \"parameters\": {\n        \"text\": \"=DMARC evaluation failed for {{ $json.domain }} on  {{ $json.mail_count }} mails with disposition:  {{ $json.evaluated_disposition }}. DKIM:  {{ $json.evaluated_dkim }} SPF:  {{ $json.evaluated_spf }}\",\n        \"select\": \"channel\",\n        \"channelId\": {\n          \"__rl\": true,\n          \"mode\": \"list\",\n          \"value\": \"CCGJA1F1N\",\n          \"cachedResultName\": \"powiadomienia\"\n        },\n        \"otherOptions\": {},\n        \"authentication\": \"oAuth2\"\n      },\n      \"credentials\": {\n        \"slackOAuth2Api\": {\n          \"id\": \"B0jUtT53pVAEPaQM\",\n          \"name\": \"Slack Oauth\"\n        }\n      },\n      \"typeVersion\": 2.2\n    },\n    {\n      \"id\": \"ce400c97-cae4-41db-ad8f-e678fc4a27fe\",\n      \"name\": \"Send Error Notification Email\",\n      \"type\": \"n8n-nodes-base.emailSend\",\n      \"disabled\": true,\n      \"position\": [\n        1200,\n        1380\n      ],\n      \"parameters\": {\n        \"text\": \"DMARC evaluation failed for {{ $json.domain }} on  {{ $json.mail_count }} mails with disposition:  {{ $json.evaluated_disposition }}. DKIM:  {{ $json.evaluated_dkim }} SPF:  {{ $json.evaluated_spf }}\",\n        \"options\": {},\n        \"subject\": \"DMARC problem\",\n        \"emailFormat\": \"text\"\n      },\n      \"typeVersion\": 2.1\n    }\n  ],\n  \"active\": true,\n  \"pinData\": {},\n  \"settings\": {\n    \"callerPolicy\": \"workflowsFromSameOwner\",\n    \"errorWorkflow\": \"5\",\n    \"executionOrder\": \"v1\",\n    \"saveManualExecutions\": true,\n    \"saveExecutionProgress\": true,\n    \"saveDataSuccessExecution\": \"all\"\n  },\n  \"versionId\": \"1add308c-4aef-4a83-a958-bc66dead234f\",\n  \"connections\": {\n    \"Unzip File\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Extract XML data\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Rename Keys\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Map fields for DB input and parse\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"End date format\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Input into database\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"If issue with DKIM or SPF\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Extract XML data\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Parse XML data to JSON\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Begin format date\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"End date format\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Email Trigger (IMAP)\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Unzip File\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Parse XML data to JSON\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"If multiple records to parse\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"If issue with DKIM or SPF\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Slack Post Message On Channel\",\n            \"type\": \"main\",\n            \"index\": 0\n          },\n          {\n            \"node\": \"Send Error Notification Email\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"If multiple records to parse\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Split Out For Separate Entries\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ],\n        [\n          {\n            \"node\": \"Rename column for consistency\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Rename column for consistency\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Map fields for DB input and parse\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Split Out For Separate Entries\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Rename Keys\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Map fields for DB input and parse\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Begin format date\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}"
}