{
  "title": "Chat Assistant (OpenAI assistant) with Postgres Memory And API Calling Capabalities",
  "url": "https://n8n.io/workflows/2637-chat-assistant-openai-assistant-with-postgres-memory-and-api-calling-capabalities/",
  "category": "AI",
  "category_url": "https://n8n.io/workflows/categories/ai/?count=20",
  "author": "Fernanda Silva",
  "publish_date": "Last update 4 months ago",
  "content": "",
  "workflow_json": "{\"id\":\"BMI5WkmyU8nZqfII\",\"meta\":{\"instanceId\":\"e03b0f22ca12c92061d789d5980a9bc31d9d7e7dd7513ac93c09ac5a0d147623\",\"templateCredsSetupCompleted\":true},\"name\":\"modelo do chatbot\",\"tags\":[],\"nodes\":[{\"id\":\"c6e454af-70a1-4c65-8450-8159f7fc738b\",\"name\":\"If\",\"type\":\"n8n-nodes-base.if\",\"position\":[160,560],\"parameters\":{\"options\":{},\"conditions\":{\"options\":{\"version\":1,\"leftValue\":\"\",\"caseSensitive\":true,\"typeValidation\":\"strict\"},\"combinator\":\"and\",\"conditions\":[{\"id\":\"7ea831a4-0e20-4725-a6f5-3dc2f41f1cf4\",\"operator\":{\"type\":\"object\",\"operation\":\"exists\",\"singleValue\":true},\"leftValue\":\"={{ $json.leadData }}\",\"rightValue\":\"\"},{\"id\":\"ccb46339-4e43-42e6-aa45-d5a0cbd62214\",\"operator\":{\"name\":\"filter.operator.equals\",\"type\":\"string\",\"operation\":\"equals\"},\"leftValue\":\"\",\"rightValue\":\"\"}]}},\"typeVersion\":2},{\"id\":\"2221736f-ef99-4ac8-8a81-51af6d4e7dcd\",\"name\":\"Edit Fields1\",\"type\":\"n8n-nodes-base.set\",\"position\":[440,960],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"19a16867-b574-4b99-82f1-a86752b7fe9f\",\"name\":\"chatInput\",\"type\":\"string\",\"value\":\"=\\\"Hello, just so you can get to know me, with no intention of a response, please save this information in your memory. My name is {{ $json.leadData.name }}. I am {{ $json.leadData.age }} years old and currently live in {{ $json.leadData.city }}, {{ $json.leadData.state }}. My profession is {{ $json.leadData.profession }}, and my education level is {{ $json.leadData.educationLevel }}.\\nIf I‚Äôm part of an adhesion group and have an entity, it would be {{ $json.leadData.entity }}.\\n\\nI am using a {{ $json.leadData.deviceType }} device to access this through the {{ $json.leadData.channel }} channel. At the moment, I am looking for a health insurance plan of type {{ $json.leadData.quotationType }}.\\\"\"},{\"id\":\"0df8d578-8332-4cde-9044-489de16ab390\",\"name\":\"session_id\",\"type\":\"string\",\"value\":\"={{ $json.session_id }}\"}]}},\"typeVersion\":3.4},{\"id\":\"6aa1b3a4-0e6a-4312-9d9f-f67c4bf8f443\",\"name\":\"Edit Fields2\",\"type\":\"n8n-nodes-base.set\",\"position\":[920,960],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"19a16867-b574-4b99-82f1-a86752b7fe9f\",\"name\":\"chatInput\",\"type\":\"string\",\"value\":\"={{ $('Chat Trigger').item.json.chatInput}}\"},{\"id\":\"0df8d578-8332-4cde-9044-489de16ab390\",\"name\":\"session_id\",\"type\":\"string\",\"value\":\"={{ $('Chat Trigger').item.json.session_id }}\"}]}},\"typeVersion\":3.4},{\"id\":\"6afe6158-7a8b-4a83-a778-6fd28e2a11af\",\"name\":\"OpenAI\",\"type\":\"@n8n/n8n-nodes-langchain.openAi\",\"position\":[600,960],\"parameters\":{\"options\":{},\"resource\":\"assistant\",\"assistantId\":{\"__rl\":true,\"mode\":\"list\",\"value\":\"asst_numdCoMZPQ6GwfiJg5drg9hr\",\"cachedResultName\":\"Chat IA - Testes - Dezembro - APIS\"}},\"credentials\":{\"openAiApi\":{\"id\":\"FW1FWHcMcwemQ1kZ\",\"name\":\"OpenAi account\"}},\"typeVersion\":1.4},{\"id\":\"4b961f1d-7da2-4a0b-98e3-7ec35ee14335\",\"name\":\"Chat Trigger\",\"type\":\"@n8n/n8n-nodes-langchain.chatTrigger\",\"position\":[-20,560],\"webhookId\":\"1f83e8ac-d465-454a-8327-cef7f0149cb1\",\"parameters\":{\"public\":true,\"options\":{},\"initialMessages\":\"Ol√° üëã\\nSou Jovelino, o servi√ßo de IA do Joov, me mande sua pergunta e responderei em seguida! :)\"},\"typeVersion\":1},{\"id\":\"dccdb07f-97db-4a5a-9b09-02a5de65246e\",\"name\":\"Postgres Chat Memory\",\"type\":\"@n8n/n8n-nodes-langchain.memoryPostgresChat\",\"position\":[640,720],\"parameters\":{\"tableName\":\"aimessages\",\"sessionKey\":\"={{ $('Chat Trigger').item.json.session_id }}{{ $json.sessionId }}\",\"sessionIdType\":\"customKey\",\"contextWindowLength\":30},\"credentials\":{\"postgres\":{\"id\":\"M1cYa0bOSX1nfczy\",\"name\":\"Postgres account\"}},\"typeVersion\":1.3},{\"id\":\"553dd27b-ab06-4605-99e0-8f15735cfff3\",\"name\":\"Postgres Chat Memory1\",\"type\":\"@n8n/n8n-nodes-langchain.memoryPostgresChat\",\"position\":[760,1160],\"parameters\":{\"tableName\":\"aimessages\",\"sessionKey\":\"={{ $('Chat Trigger').item.json.session_id }}{{ $json.sessionId }}\",\"sessionIdType\":\"customKey\",\"contextWindowLength\":1},\"credentials\":{\"postgres\":{\"id\":\"M1cYa0bOSX1nfczy\",\"name\":\"Postgres account\"}},\"typeVersion\":1.3},{\"id\":\"0103fb97-c691-4bd3-b26d-85aaa9774594\",\"name\":\"Products in Daatabase\",\"type\":\"n8n-nodes-base.mySqlTool\",\"position\":[1460,600],\"parameters\":{\"query\":\"SELECT * \\nFROM Products p \\nWHERE \\n  cityQuery = '{{ $fromAI(\\\"cityQuery\\\") }}' AND \\n  state = '{{ $fromAI(\\\"state\\\") }}' AND \\n  modality = 'PME' AND \\n  removed = 0 AND \\n  ({{ $fromAI(\\\"holderCount\\\") || 1 }} + {{ $fromAI(\\\"dependentsCount\\\") || 0 }}) BETWEEN p.minLifeAmount AND p.maxLifeAmount AND\\n  (CASE\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 0 AND 18 THEN priceAtAge0To18\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 19 AND 23 THEN priceAtAge19To23\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 24 AND 28 THEN priceAtAge24To28\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 29 AND 33 THEN priceAtAge29To33\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 34 AND 38 THEN priceAtAge34To38\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 39 AND 43 THEN priceAtAge39To43\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 44 AND 48 THEN priceAtAge44To48\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 49 AND 53 THEN priceAtAge49To53\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 54 AND 58 THEN priceAtAge54To58\\n      ELSE priceAtAge59To199\\n  END) IS NOT NULL\\nORDER BY \\n  (CASE\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 0 AND 18 THEN priceAtAge0To18\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 19 AND 23 THEN priceAtAge19To23\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 24 AND 28 THEN priceAtAge24To28\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 29 AND 33 THEN priceAtAge29To33\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 34 AND 38 THEN priceAtAge34To38\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 39 AND 43 THEN priceAtAge39To43\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 44 AND 48 THEN priceAtAge44To48\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 49 AND 53 THEN priceAtAge49To53\\n      WHEN {{ $fromAI(\\\"holderAge\\\") }} BETWEEN 54 AND 58 THEN priceAtAge54To58\\n      ELSE priceAtAge59To199\\n  END) ASC, \\n  createdAt DESC\\nLIMIT 3;\\n\",\"options\":{\"detailedOutput\":true},\"operation\":\"executeQuery\",\"descriptionType\":\"manual\",\"toolDescription\":\"//  Search for the X product bla bla bla\"},\"credentials\":{\"mySql\":{\"id\":\"lkGJt8aNB0azyaGy\",\"name\":\"MySQL account 2\"}},\"typeVersion\":2.4},{\"id\":\"0cdfd89f-eb9e-4b6c-90d1-1cf8d6ed96bb\",\"name\":\"Knowledge Base\",\"type\":\"@n8n/n8n-nodes-langchain.toolHttpRequest\",\"position\":[1340,600],\"parameters\":{\"url\":\"https://quotation.joov.com.br/widget/info?modalidade={modalidade}&estado=SP&cidade={city}&operadora={operadora}\",\"toolDescription\":\"Here you will find the knowlegde base of my shop and bla bla bla Use this when they ask for price, whatever i want.\"},\"typeVersion\":1.1},{\"id\":\"393f792a-4eff-4b33-aac0-025fc622a4b3\",\"name\":\"External API\",\"type\":\"@n8n/n8n-nodes-langchain.toolHttpRequest\",\"position\":[1200,600],\"parameters\":{\"url\":\"https://integracao-sed-alb-323570099.us-east-1.elb.amazonaws.com/findByNameAndBirthDate\",\"method\":\"POST\",\"jsonBody\":\"={\\n    \\\"name\\\": \\\"{{json.name}}\\\",\\n    \\\"birthdate\\\": \\\"{{json.birthdate }}\\\"\\n}\",\"sendBody\":true,\"specifyBody\":\"json\",\"toolDescription\":\"Pegue o nome completo em camel case, exemplo: Fernanda Melo, e a data de nacimento nesse formato: 1990-03-28\"},\"typeVersion\":1.1},{\"id\":\"7ce7a5e7-6238-4479-a26f-bdcde1784188\",\"name\":\"Sticky Note\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1160,414],\"parameters\":{\"color\":5,\"width\":436.73182569600795,\"height\":367.7413881276459,\"content\":\"TOOLS\"},\"typeVersion\":1},{\"id\":\"df6737ca-c588-48fc-9761-2a5307841298\",\"name\":\"OpenAI2\",\"type\":\"@n8n/n8n-nodes-langchain.openAi\",\"position\":[460,460],\"parameters\":{\"text\":\"={{ $json.chatInput }}\",\"prompt\":\"define\",\"options\":{},\"resource\":\"assistant\",\"assistantId\":{\"__rl\":true,\"mode\":\"list\",\"value\":\"asst_x2qfc7EuoPv7XGOL84ClEZ3L\",\"cachedResultName\":\"PINE\"}},\"credentials\":{\"openAiApi\":{\"id\":\"FW1FWHcMcwemQ1kZ\",\"name\":\"OpenAi account\"}},\"typeVersion\":1.4}],\"active\":false,\"pinData\":{},\"settings\":{\"executionOrder\":\"v1\"},\"versionId\":\"d1dc3988-6677-47c9-b91a-6875c7b6151d\",\"connections\":{\"If\":{\"main\":[[{\"node\":\"Edit Fields1\",\"type\":\"main\",\"index\":0}],[{\"node\":\"OpenAI2\",\"type\":\"main\",\"index\":0}]]},\"OpenAI\":{\"main\":[[{\"node\":\"Edit Fields2\",\"type\":\"main\",\"index\":0}]]},\"Chat Trigger\":{\"main\":[[{\"node\":\"If\",\"type\":\"main\",\"index\":0}]]},\"Edit Fields1\":{\"main\":[[{\"node\":\"OpenAI\",\"type\":\"main\",\"index\":0}]]},\"Edit Fields2\":{\"main\":[[{\"node\":\"OpenAI2\",\"type\":\"main\",\"index\":0}]]},\"External API\":{\"ai_tool\":[[{\"node\":\"OpenAI2\",\"type\":\"ai_tool\",\"index\":0}]]},\"Knowledge Base\":{\"ai_tool\":[[{\"node\":\"OpenAI2\",\"type\":\"ai_tool\",\"index\":0}]]},\"Postgres Chat Memory\":{\"ai_memory\":[[{\"node\":\"OpenAI2\",\"type\":\"ai_memory\",\"index\":0}]]},\"Postgres Chat Memory1\":{\"ai_memory\":[[{\"node\":\"OpenAI\",\"type\":\"ai_memory\",\"index\":0}]]},\"Products in Daatabase\":{\"ai_tool\":[[{\"node\":\"OpenAI2\",\"type\":\"ai_tool\",\"index\":0}]]}}}",
  "readme": "# Workflow Description\n\nYour workflow is an intelligent chatbot, using ++OpenAI assistant++, integrated with a backend that supports WhatsApp Business, designed to handle various use cases such as sales and customer support. Below is a breakdown of its functionality and key components:\n\n* * *\n\n## Workflow Structure and Functionality\n\n### Chat Input (Chat Trigger)\n\n  * The flow starts by receiving messages from customers via WhatsApp Business.\n  * Collects basic information, such as `session_id`, to organize interactions.\n\n\n\n### Condition Check (If Node)\n\n  * Checks if additional customer data (e.g., name, age, dependents) is sent along with the message.\n  * If additional data is present, a customized prompt is generated, which includes this information. The prompt specifies that this data is for the assistant's awareness and doesn‚Äôt require a response.\n\n\n\n### Data Preparation (Edit Fields Nodes)\n\n  * Formats customer data and the interaction details to be processed by the AI assistant.\n  * Compiles the customer data and their query into a single text block.\n\n\n\n### AI Responses (OpenAI Nodes)\n\n  * The assistant‚Äôs prompt is carefully designed to guide the AI in providing accurate and relevant responses based on the customer‚Äôs query and data provided.\n  * Prompts describe the available functionalities, including which APIs to call and their specific purposes, helping to prevent ‚Äúhallucinated‚Äù or irrelevant responses.\n\n\n\n### Memory and Context (Postgres Chat Memory)\n\n  * Stores context and messages in continuous sessions using a database, ensuring the chatbot maintains conversation history.\n\n\n\n### API Calls\n\n  * The workflow allows the use of **APIs** with any endpoints you choose, depending on your specific use case. This flexibility enables integration with various services tailored to your needs.\n  * The OpenAI assistant understands JSON structures, and you can define in the prompt how the responses should be formatted. This allows you to structure responses neatly for the client, ensuring clarity and professionalism.\n  * Make sure to describe the purpose of each endpoint in the assistant‚Äôs prompt to help guide the AI and prevent misinterpretation.\n\n\n\n### Customer Response Delivery\n\n  * After processing and querying APIs, the generated response is sent to the backend and ultimately delivered to the customer through WhatsApp Business.\n\n\n\n* * *\n\n## Best Practices Implemented\n\n  * **Preventing Hallucinations**  \nEvery API has a clear description in its prompt, ensuring the AI understands its intended use case.\n\n  * **Versatile Functionality**  \nThe chatbot is modular and flexible, capable of handling both sales and general customer inquiries.\n\n  * **Context Persistence**  \nBy utilizing persistent memory, the flow maintains continuous interaction context, which is crucial for longer conversations or follow-up queries.\n\n\n\n\n* * *\n\n## Additional Recommendations\n\n  * Include practical examples in the assistant‚Äôs prompt, such as frequently asked questions or decision-making flows based on API calls.\n  * Ensure all responses align with the customer‚Äôs objectives (e.g., making a purchase or resolving technical queries).\n  * Log interactions in detail for future analysis and workflow optimization.\n\n\n\n* * *\n\nThis workflow provides a solid foundation for a robust and multifunctional virtual assistant üöÄ\n",
  "readme_html": "<!--[--><div data-v-006f9244=\"\"><h1>Workflow Description</h1>\n<p>Your workflow is an intelligent chatbot, using ++OpenAI assistant++, integrated with a backend that supports WhatsApp Business, designed to handle various use cases such as sales and customer support. Below is a breakdown of its functionality and key components:</p>\n<hr>\n<h2>Workflow Structure and Functionality</h2>\n<h3>Chat Input (Chat Trigger)</h3>\n<ul>\n<li>The flow starts by receiving messages from customers via WhatsApp Business.</li>\n<li>Collects basic information, such as <code>session_id</code>, to organize interactions.</li>\n</ul>\n<h3>Condition Check (If Node)</h3>\n<ul>\n<li>Checks if additional customer data (e.g., name, age, dependents) is sent along with the message.</li>\n<li>If additional data is present, a customized prompt is generated, which includes this information. The prompt specifies that this data is for the assistant's awareness and doesn‚Äôt require a response.</li>\n</ul>\n<h3>Data Preparation (Edit Fields Nodes)</h3>\n<ul>\n<li>Formats customer data and the interaction details to be processed by the AI assistant.</li>\n<li>Compiles the customer data and their query into a single text block.</li>\n</ul>\n<h3>AI Responses (OpenAI Nodes)</h3>\n<ul>\n<li>The assistant‚Äôs prompt is carefully designed to guide the AI in providing accurate and relevant responses based on the customer‚Äôs query and data provided.</li>\n<li>Prompts describe the available functionalities, including which APIs to call and their specific purposes, helping to prevent ‚Äúhallucinated‚Äù or irrelevant responses.</li>\n</ul>\n<h3>Memory and Context (Postgres Chat Memory)</h3>\n<ul>\n<li>Stores context and messages in continuous sessions using a database, ensuring the chatbot maintains conversation history.</li>\n</ul>\n<h3>API Calls</h3>\n<ul>\n<li>The workflow allows the use of <strong>APIs</strong> with any endpoints you choose, depending on your specific use case. This flexibility enables integration with various services tailored to your needs.</li>\n<li>The OpenAI assistant understands JSON structures, and you can define in the prompt how the responses should be formatted. This allows you to structure responses neatly for the client, ensuring clarity and professionalism.</li>\n<li>Make sure to describe the purpose of each endpoint in the assistant‚Äôs prompt to help guide the AI and prevent misinterpretation.</li>\n</ul>\n<h3>Customer Response Delivery</h3>\n<ul>\n<li>After processing and querying APIs, the generated response is sent to the backend and ultimately delivered to the customer through WhatsApp Business.</li>\n</ul>\n<hr>\n<h2>Best Practices Implemented</h2>\n<ul>\n<li>\n<p><strong>Preventing Hallucinations</strong><br>\nEvery API has a clear description in its prompt, ensuring the AI understands its intended use case.</p>\n</li>\n<li>\n<p><strong>Versatile Functionality</strong><br>\nThe chatbot is modular and flexible, capable of handling both sales and general customer inquiries.</p>\n</li>\n<li>\n<p><strong>Context Persistence</strong><br>\nBy utilizing persistent memory, the flow maintains continuous interaction context, which is crucial for longer conversations or follow-up queries.</p>\n</li>\n</ul>\n<hr>\n<h2>Additional Recommendations</h2>\n<ul>\n<li>Include practical examples in the assistant‚Äôs prompt, such as frequently asked questions or decision-making flows based on API calls.</li>\n<li>Ensure all responses align with the customer‚Äôs objectives (e.g., making a purchase or resolving technical queries).</li>\n<li>Log interactions in detail for future analysis and workflow optimization.</li>\n</ul>\n<hr>\n<p>This workflow provides a solid foundation for a robust and multifunctional virtual assistant üöÄ</p>\n</div><!--]-->"
}