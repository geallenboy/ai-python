{
  "title": "Poll emails using JMAP",
  "url": "https://n8n.io/workflows/2032-poll-emails-using-jmap/",
  "category": "BuildingBlocks",
  "category_url": "https://n8n.io/workflows/categories/building-blocks/?sort=createdAt:desc",
  "author": "Tom",
  "publish_date": "Last update 10 months ago",
  "publish_date_absolute": "2024-07-07",
  "content": "",
  "workflow_json": "{\"nodes\":[{\"id\":\"31b6611c-e4d1-4ab8-9351-74718caf938d\",\"name\":\"When clicking \\\"Execute Workflow\\\"\",\"type\":\"n8n-nodes-base.manualTrigger\",\"position\":[820,360],\"parameters\":{},\"typeVersion\":1},{\"id\":\"5b8a2148-f8e3-4c21-ba39-6aa8cc492c5e\",\"name\":\"Get mailboxes\",\"type\":\"n8n-nodes-base.httpRequest\",\"position\":[1260,360],\"parameters\":{\"url\":\"https://api.fastmail.com/jmap/api/\",\"method\":\"POST\",\"options\":{},\"sendBody\":true,\"authentication\":\"genericCredentialType\",\"bodyParameters\":{\"parameters\":[{\"name\":\"using\",\"value\":\"={{ [ \\\"urn:ietf:params:jmap:core\\\", \\\"urn:ietf:params:jmap:mail\\\" ] }}\"},{\"name\":\"methodCalls\",\"value\":\"={{\\n[\\n  [ \\n    \\\"Mailbox/get\\\",\\n    {\\n      \\\"accountId\\\": $json.primaryAccounts['urn:ietf:params:jmap:mail'],\\n      \\\"ids\\\": null\\n    },\\n    \\\"mailboxes\\\"\\n  ] \\n]\\n}}\"}]},\"genericAuthType\":\"httpHeaderAuth\"},\"credentials\":{\"httpHeaderAuth\":{\"id\":\"ZzWBkLUs2mg2xJBW\",\"name\":\"Fastmail\"}},\"typeVersion\":4.1},{\"id\":\"8477a075-1341-4b69-8e20-4a56b2a96711\",\"name\":\"Fetch API details\",\"type\":\"n8n-nodes-base.httpRequest\",\"position\":[1040,360],\"parameters\":{\"url\":\"https://api.fastmail.com/jmap/session\",\"options\":{},\"authentication\":\"genericCredentialType\",\"genericAuthType\":\"httpHeaderAuth\"},\"credentials\":{\"httpHeaderAuth\":{\"id\":\"ZzWBkLUs2mg2xJBW\",\"name\":\"Fastmail\"}},\"typeVersion\":4.1},{\"id\":\"87188d6d-eb94-4b83-aaa4-e5c744d65c45\",\"name\":\"Format results\",\"type\":\"n8n-nodes-base.set\",\"position\":[1480,360],\"parameters\":{\"fields\":{\"values\":[{\"name\":\"account_id\",\"stringValue\":\"={{ $('Fetch API details').first().json.primaryAccounts['urn:ietf:params:jmap:mail'] }}\"},{\"name\":\"mailbox_id\",\"stringValue\":\"={{ $json.methodResponses.find(e => e[2] == 'mailboxes')[1].list.find(e => e.role == 'inbox').id }}\"}]},\"include\":\"none\",\"options\":{}},\"typeVersion\":3.2},{\"id\":\"550b20c1-57ff-497e-b20a-e772e5fbfe86\",\"name\":\"Get unread messages\",\"type\":\"n8n-nodes-base.httpRequest\",\"position\":[1700,360],\"parameters\":{\"url\":\"https://api.fastmail.com/jmap/api/\",\"method\":\"POST\",\"options\":{},\"sendBody\":true,\"authentication\":\"genericCredentialType\",\"bodyParameters\":{\"parameters\":[{\"name\":\"using\",\"value\":\"={{ [ \\\"urn:ietf:params:jmap:core\\\", \\\"urn:ietf:params:jmap:mail\\\" ] }}\"},{\"name\":\"methodCalls\",\"value\":\"={{\\n[\\n  [ \\n    \\\"Email/query\\\",\\n    {\\n      \\\"accountId\\\": $json.account_id,\\n      \\\"filter\\\": {\\n        \\\"inMailbox\\\": $json.mailbox_id,\\n        \\\"notKeyword\\\": \\\"$seen\\\"\\n      },\\n      \\\"sort\\\": [\\n        {\\n          \\\"property\\\": \\\"receivedAt\\\",\\n          \\\"isAscending\\\": false\\n        }\\n      ],\\n      \\\"limit\\\": 3,\\n      \\\"calculateTotal\\\": true,\\n    },\\n    \\\"messages\\\"\\n  ], [\\n    \\\"Email/get\\\",\\n    {\\n      \\\"accountId\\\": $json.account_id,\\n      \\\"#ids\\\": {\\n        \\\"name\\\": \\\"Email/query\\\",\\n        \\\"path\\\": \\\"/ids\\\",\\n        \\\"resultOf\\\": \\\"messages\\\"\\n      },\\n      \\\"properties\\\": [\\n        \\\"id\\\",\\n        \\\"receivedAt\\\",\\n        \\\"from\\\",\\n        \\\"subject\\\",\\n        \\\"keywords\\\"\\n      ]\\n    },\\n    \\\"emails\\\"\\n  ] \\n]\\n}}\"}]},\"genericAuthType\":\"httpHeaderAuth\"},\"credentials\":{\"httpHeaderAuth\":{\"id\":\"ZzWBkLUs2mg2xJBW\",\"name\":\"Fastmail\"}},\"typeVersion\":4.1},{\"id\":\"7298d504-8e68-481b-a2cb-07a64dcef159\",\"name\":\"Sticky Note\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[980,200],\"parameters\":{\"color\":5,\"width\":671,\"height\":328,\"content\":\"## ℹ️ Replacing the initial nodes\\n\\nThese nodes fetch your account and mailbox IDs. Consider saving these values instead of querying them on every execution to improve performance and reduce the load on the JMAP API.\"},\"typeVersion\":1},{\"id\":\"b279bb2d-e76e-4e3b-abaf-e351d1c3462d\",\"name\":\"Sticky Note1\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[980,-60],\"parameters\":{\"color\":3,\"width\":671,\"height\":232,\"content\":\"## ℹ️ Credentials\\n\\nThe JMAP standard does not limit the available authentication options. Fastmail (the sponsor of the standard) supports Bearer authentication as well as OAuth2.\\n\\nIn n8n you can implement the Fastmail Bearer authentication by creating Header Auth credentials with a name of `Authorization` and a value of `Bearer $apiToken` (replacing `$apiToken` with your actual [token from Fastmail](https://www.fastmail.com/settings/security/tokens)).\"},\"typeVersion\":1}],\"pinData\":{},\"connections\":{\"Get mailboxes\":{\"main\":[[{\"node\":\"Format results\",\"type\":\"main\",\"index\":0}]]},\"Format results\":{\"main\":[[{\"node\":\"Get unread messages\",\"type\":\"main\",\"index\":0}]]},\"Fetch API details\":{\"main\":[[{\"node\":\"Get mailboxes\",\"type\":\"main\",\"index\":0}]]},\"When clicking \\\"Execute Workflow\\\"\":{\"main\":[[{\"node\":\"Fetch API details\",\"type\":\"main\",\"index\":0}]]}}}",
  "readme": "n8n does not currently offer a way to retrieve emails from arbritrary providers via a regular node. Unless you're using Gmail or Outlook, you can only use the email trigger to start a workflow when a new email arrives.\n\nThis currently limits the possible use cases you can cover in your n8n workflows, as you cannot (for example) get an idea of how many unread messages there are in an inbox, or search for specific messages when an event occurs.\n\nBut fear not, there's a new sheriff in town! The [JMAP standard](https://jmap.io/index.html) allows you to interact with your mailboxes, calendars and contacts through single HTTP requests whenever needed.\n\nThis n8n workflow demonstrates how to retrieve the total number of unread messages from a JMAP server and also retrieve details for the first 3 messages. It can easily be adapted to search for messages other than unread, or to return details for more than the first 3 messages.\n\n# Screenshots\n\n![image.png](https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-prod/assets/image_9bf8d838ef.png)\n\n![image.png](https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-prod/assets/image_26da2bf173.png)\n\n# FAQ\n\n## Which n8n version do I need?\n\nThe workflow was built using n8n 1.20 and should work here out of the box. HTTP requests are also supported on older n8n versions, so the workflow can be backported as an alternative.\n\n## Which credentials do I need?\n\nThe JMAP standard does not limit the available authentication options. Fastmail (the sponsor of the standard) supports Bearer authentication as well as OAuth2.\n\nIn n8n you can implement the Fastmail Bearer authentication by creating Header Auth credentials with a name of `Authorization` and a value of `Bearer $apiToken` (replacing `$apiToken` with your actual API token from Fastmail).\n\nFor other services you'd need to check the respective API documentation for more details on the support authentication methods.\n\n## What even is JMAP?\n\nIt's an official Internet Engineering Task Force (IETF) standard, sponsored by Fastmail, that will hopefully replace the legacy standards CalDAV, CardDAV, and IMAP soon. The full specs are [available here](https://jmap.io/spec.html).\n\n## How can I use JMAP?\n\nIf you're a [Fastmail](https://ref.fm/u30544864) customer or if you're hosting your own [Stalwart mail server](https://github.com/stalwartlabs/mail-server) you can use JMAP today.\n\nIf your email provider doesn't yet support JMAP, you might want to contact them and let them know you're interested in this functionality.\n",
  "readme_html": "<!--[--><div data-v-50766329=\"\"><p>n8n does not currently offer a way to retrieve emails from arbritrary providers via a regular node. Unless you're using Gmail or Outlook, you can only use the email trigger to start a workflow when a new email arrives.</p>\n<p>This currently limits the possible use cases you can cover in your n8n workflows, as you cannot (for example) get an idea of how many unread messages there are in an inbox, or search for specific messages when an event occurs.</p>\n<p>But fear not, there's a new sheriff in town! The <a href=\"https://jmap.io/index.html\" rel=\"ugc nofollow\" target=\"_blank\">JMAP standard</a> allows you to interact with your mailboxes, calendars and contacts through single HTTP requests whenever needed.</p>\n<p>This n8n workflow demonstrates how to retrieve the total number of unread messages from a JMAP server and also retrieve details for the first 3 messages. It can easily be adapted to search for messages other than unread, or to return details for more than the first 3 messages.</p>\n<h1>Screenshots</h1>\n<p><img src=\"https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-prod/assets/image_9bf8d838ef.png\" alt=\"image.png\"></p>\n<p><img src=\"https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-prod/assets/image_26da2bf173.png\" alt=\"image.png\"></p>\n<h1>FAQ</h1>\n<h2>Which n8n version do I need?</h2>\n<p>The workflow was built using n8n 1.20 and should work here out of the box. HTTP requests are also supported on older n8n versions, so the workflow can be backported as an alternative.</p>\n<h2>Which credentials do I need?</h2>\n<p>The JMAP standard does not limit the available authentication options. Fastmail (the sponsor of the standard) supports Bearer authentication as well as OAuth2.</p>\n<p>In n8n you can implement the Fastmail Bearer authentication by creating Header Auth credentials with a name of <code>Authorization</code> and a value of <code>Bearer $apiToken</code> (replacing <code>$apiToken</code> with your actual API token from Fastmail).</p>\n<p>For other services you'd need to check the respective API documentation for more details on the support authentication methods.</p>\n<h2>What even is JMAP?</h2>\n<p>It's an official Internet Engineering Task Force (IETF) standard, sponsored by Fastmail, that will hopefully replace the legacy standards CalDAV, CardDAV, and IMAP soon. The full specs are <a href=\"https://jmap.io/spec.html\" rel=\"ugc nofollow\" target=\"_blank\">available here</a>.</p>\n<h2>How can I use JMAP?</h2>\n<p>If you're a <a href=\"https://ref.fm/u30544864\" rel=\"ugc nofollow\" target=\"_blank\">Fastmail</a> customer or if you're hosting your own <a href=\"https://github.com/stalwartlabs/mail-server\" rel=\"ugc nofollow\" target=\"_blank\">Stalwart mail server</a> you can use JMAP today.</p>\n<p>If your email provider doesn't yet support JMAP, you might want to contact them and let them know you're interested in this functionality.</p>\n</div><!--]-->",
  "readme_zh": "n8n 目前不支持通过常规节点从任意邮件服务商处获取邮件。除非使用Gmail或Outlook，否则只能通过邮件触发器在新邮件到达时启动工作流。\n\n这限制了n8n工作流能覆盖的使用场景，例如无法获取收件箱中未读邮件的数量，或在事件发生时搜索特定邮件。\n\n但别担心，现在有了新的解决方案！[JMAP标准](https://jmap.io/index.html)允许你通过简单的HTTP请求与邮箱、日历和联系人进行交互。\n\n这个n8n工作流演示了如何从JMAP服务器获取未读邮件总数及前3封邮件的详情。你可以轻松调整它来搜索非未读邮件，或返回超过3封邮件的详情。\n\n# 截图\n\n![image.png](https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-prod/assets/image_9bf8d838ef.png)\n\n![image.png](https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-prod/assets/image_26da2bf173.png)\n\n# 常见问题\n\n## 需要哪个版本的n8n？\n\n该工作流基于n8n 1.20构建，可直接使用。旧版n8n也支持HTTP请求，因此也可通过移植方式使用。\n\n## 需要哪些凭证？\n\nJMAP标准不限制认证方式。标准赞助商Fastmail支持Bearer认证和OAuth2。\n\n在n8n中，可通过创建Header Auth凭证实现Fastmail的Bearer认证，设置名称为`Authorization`，值为`Bearer $apiToken`（将`$apiToken`替换为你的Fastmail API令牌）。\n\n其他服务的认证方式请查阅相应API文档。\n\n## 什么是JMAP？\n\n这是由Fastmail赞助的IETF官方标准，有望取代传统的CalDAV、CardDAV和IMAP协议。完整规范见[此处](https://jmap.io/spec.html)。\n\n## 如何使用JMAP？\n\n如果你是[Fastmail](https://ref.fm/u30544864)用户，或使用[Stalwart邮件服务器](https://github.com/stalwartlabs/mail-server)，现在即可使用JMAP。\n\n若你的邮件服务商尚未支持JMAP，可联系他们表达对该功能的兴趣。",
  "title_zh": "使用JMAP轮询邮件",
  "publish_date_zh": "最后更新于10个月前",
  "workflow_json_zh": "{\n  \"nodes\": [\n    {\n      \"id\": \"31b6611c-e4d1-4ab8-9351-74718caf938d\",\n      \"name\": \"When clicking \\\"Execute Workflow\\\"\",\n      \"type\": \"n8n-nodes-base.manualTrigger\",\n      \"position\": [\n        820,\n        360\n      ],\n      \"parameters\": {},\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"5b8a2148-f8e3-4c21-ba39-6aa8cc492c5e\",\n      \"name\": \"Get mailboxes\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        1260,\n        360\n      ],\n      \"parameters\": {\n        \"url\": \"https://api.fastmail.com/jmap/api/\",\n        \"method\": \"POST\",\n        \"options\": {},\n        \"sendBody\": true,\n        \"authentication\": \"genericCredentialType\",\n        \"bodyParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"using\",\n              \"value\": \"={{ [ \\\"urn:ietf:params:jmap:core\\\", \\\"urn:ietf:params:jmap:mail\\\" ] }}\"\n            },\n            {\n              \"name\": \"methodCalls\",\n              \"value\": \"={{\\n[\\n  [ \\n    \\\"Mailbox/get\\\",\\n    {\\n      \\\"accountId\\\": $json.primaryAccounts['urn:ietf:params:jmap:mail'],\\n      \\\"ids\\\": null\\n    },\\n    \\\"mailboxes\\\"\\n  ] \\n]\\n}}\"\n            }\n          ]\n        },\n        \"genericAuthType\": \"httpHeaderAuth\"\n      },\n      \"credentials\": {\n        \"httpHeaderAuth\": {\n          \"id\": \"ZzWBkLUs2mg2xJBW\",\n          \"name\": \"Fastmail\"\n        }\n      },\n      \"typeVersion\": 4.1\n    },\n    {\n      \"id\": \"8477a075-1341-4b69-8e20-4a56b2a96711\",\n      \"name\": \"Fetch API details\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        1040,\n        360\n      ],\n      \"parameters\": {\n        \"url\": \"https://api.fastmail.com/jmap/session\",\n        \"options\": {},\n        \"authentication\": \"genericCredentialType\",\n        \"genericAuthType\": \"httpHeaderAuth\"\n      },\n      \"credentials\": {\n        \"httpHeaderAuth\": {\n          \"id\": \"ZzWBkLUs2mg2xJBW\",\n          \"name\": \"Fastmail\"\n        }\n      },\n      \"typeVersion\": 4.1\n    },\n    {\n      \"id\": \"87188d6d-eb94-4b83-aaa4-e5c744d65c45\",\n      \"name\": \"Format results\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"position\": [\n        1480,\n        360\n      ],\n      \"parameters\": {\n        \"fields\": {\n          \"values\": [\n            {\n              \"name\": \"account_id\",\n              \"stringValue\": \"={{ $('Fetch API details').first().json.primaryAccounts['urn:ietf:params:jmap:mail'] }}\"\n            },\n            {\n              \"name\": \"mailbox_id\",\n              \"stringValue\": \"={{ $json.methodResponses.find(e => e[2] == 'mailboxes')[1].list.find(e => e.role == 'inbox').id }}\"\n            }\n          ]\n        },\n        \"include\": \"none\",\n        \"options\": {}\n      },\n      \"typeVersion\": 3.2\n    },\n    {\n      \"id\": \"550b20c1-57ff-497e-b20a-e772e5fbfe86\",\n      \"name\": \"Get unread messages\",\n      \"type\": \"n8n-nodes-base.httpRequest\",\n      \"position\": [\n        1700,\n        360\n      ],\n      \"parameters\": {\n        \"url\": \"https://api.fastmail.com/jmap/api/\",\n        \"method\": \"POST\",\n        \"options\": {},\n        \"sendBody\": true,\n        \"authentication\": \"genericCredentialType\",\n        \"bodyParameters\": {\n          \"parameters\": [\n            {\n              \"name\": \"using\",\n              \"value\": \"={{ [ \\\"urn:ietf:params:jmap:core\\\", \\\"urn:ietf:params:jmap:mail\\\" ] }}\"\n            },\n            {\n              \"name\": \"methodCalls\",\n              \"value\": \"={{\\n[\\n  [ \\n    \\\"Email/query\\\",\\n    {\\n      \\\"accountId\\\": $json.account_id,\\n      \\\"filter\\\": {\\n        \\\"inMailbox\\\": $json.mailbox_id,\\n        \\\"notKeyword\\\": \\\"$seen\\\"\\n      },\\n      \\\"sort\\\": [\\n        {\\n          \\\"property\\\": \\\"receivedAt\\\",\\n          \\\"isAscending\\\": false\\n        }\\n      ],\\n      \\\"limit\\\": 3,\\n      \\\"calculateTotal\\\": true,\\n    },\\n    \\\"messages\\\"\\n  ], [\\n    \\\"Email/get\\\",\\n    {\\n      \\\"accountId\\\": $json.account_id,\\n      \\\"#ids\\\": {\\n        \\\"name\\\": \\\"Email/query\\\",\\n        \\\"path\\\": \\\"/ids\\\",\\n        \\\"resultOf\\\": \\\"messages\\\"\\n      },\\n      \\\"properties\\\": [\\n        \\\"id\\\",\\n        \\\"receivedAt\\\",\\n        \\\"from\\\",\\n        \\\"subject\\\",\\n        \\\"keywords\\\"\\n      ]\\n    },\\n    \\\"emails\\\"\\n  ] \\n]\\n}}\"\n            }\n          ]\n        },\n        \"genericAuthType\": \"httpHeaderAuth\"\n      },\n      \"credentials\": {\n        \"httpHeaderAuth\": {\n          \"id\": \"ZzWBkLUs2mg2xJBW\",\n          \"name\": \"Fastmail\"\n        }\n      },\n      \"typeVersion\": 4.1\n    },\n    {\n      \"id\": \"7298d504-8e68-481b-a2cb-07a64dcef159\",\n      \"name\": \"Sticky Note\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        980,\n        200\n      ],\n      \"parameters\": {\n        \"color\": 5,\n        \"width\": 671,\n        \"height\": 328,\n        \"content\": \"## ℹ️ 替换初始节点  \\n\\n这些节点用于获取您的账户和邮箱ID。建议保存这些值而非每次执行时都进行查询，以提升性能并减轻JMAP API的负载。\"\n      },\n      \"typeVersion\": 1\n    },\n    {\n      \"id\": \"b279bb2d-e76e-4e3b-abaf-e351d1c3462d\",\n      \"name\": \"Sticky Note1\",\n      \"type\": \"n8n-nodes-base.stickyNote\",\n      \"position\": [\n        980,\n        -60\n      ],\n      \"parameters\": {\n        \"color\": 3,\n        \"width\": 671,\n        \"height\": 232,\n        \"content\": \"## ℹ️ 认证凭证\\n\\nJMAP标准并未限制可用的认证方式。Fastmail（该标准的赞助方）支持Bearer认证和OAuth2认证。\\n\\n在n8n中，您可以通过创建Header Auth凭证来实现Fastmail的Bearer认证，凭证名称设为`Authorization`，值设为`Bearer $apiToken`（请将`$apiToken`替换为您从Fastmail获取的实际[令牌](https://www.fastmail.com/settings/security/tokens)）。\"\n      },\n      \"typeVersion\": 1\n    }\n  ],\n  \"pinData\": {},\n  \"connections\": {\n    \"Get mailboxes\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Format results\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Format results\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get unread messages\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"Fetch API details\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Get mailboxes\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"When clicking \\\"Execute Workflow\\\"\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"Fetch API details\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    }\n  }\n}"
}