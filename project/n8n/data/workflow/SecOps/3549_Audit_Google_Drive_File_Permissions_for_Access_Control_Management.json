{
  "title": "Audit Google Drive File Permissions for Access Control Management",
  "url": "https://n8n.io/workflows/3549-audit-google-drive-file-permissions-for-access-control-management/",
  "category": "SecOps",
  "category_url": "https://n8n.io/workflows/categories/secops/?count=20",
  "author": "Jimleuk",
  "publish_date": "Last update 12 days ago",
  "content": "",
  "workflow_json": "{\"meta\":{\"instanceId\":\"408f9fb9940c3cb18ffdef0e0150fe342d6e655c3a9fac21f0f644e8bedabcd9\",\"templateCredsSetupCompleted\":true},\"nodes\":[{\"id\":\"f8f5a571-c4de-469e-a182-faa60060d06b\",\"name\":\"Has Shared with External Users\",\"type\":\"n8n-nodes-base.filter\",\"position\":[40,-220],\"parameters\":{\"options\":{},\"conditions\":{\"options\":{\"version\":2,\"leftValue\":\"\",\"caseSensitive\":true,\"typeValidation\":\"strict\"},\"combinator\":\"or\",\"conditions\":[{\"id\":\"c72e9718-b50a-4c5f-8a26-7b3fda89e202\",\"operator\":{\"type\":\"boolean\",\"operation\":\"true\",\"singleValue\":true},\"leftValue\":\"={{ $json.shared && $json.permissions.some(item => item.emailAddress ? !item.emailAddress.endsWith('example.com') : false)  }}\",\"rightValue\":\"\"},{\"id\":\"0479b4ae-fc0c-49c4-8813-6978ea55265a\",\"operator\":{\"type\":\"object\",\"operation\":\"exists\",\"singleValue\":true},\"leftValue\":\"={{ $json.permissions.find(item => item.type === 'anyone') }}\",\"rightValue\":\"\"}]}},\"typeVersion\":2.2},{\"id\":\"14b6d453-0403-476a-8537-cdeeace70115\",\"name\":\"Create New Sheet\",\"type\":\"n8n-nodes-base.googleSheets\",\"position\":[-620,-220],\"parameters\":{\"title\":\"=audit-{{ $now.format('yyyyMMdd') }}\",\"options\":{},\"operation\":\"create\",\"documentId\":{\"__rl\":true,\"mode\":\"list\",\"value\":\"1V2aiLhp3_nH7EBniMn7D0kFHg7-A5NjpDZXMhb4F5UI\",\"cachedResultUrl\":\"https://docs.google.com/spreadsheets/d/1V2aiLhp3_nH7EBniMn7D0kFHg7-A5NjpDZXMhb4F5UI/edit?usp=drivesdk\",\"cachedResultName\":\"94. Gdrive Permissions Audit - Personal\"}},\"credentials\":{\"googleSheetsOAuth2Api\":{\"id\":\"XHvC7jIRR8A2TlUl\",\"name\":\"Google Sheets account\"}},\"typeVersion\":4.5,\"alwaysOutputData\":true},{\"id\":\"394b91b3-0c70-40d5-8d48-4df6109780e7\",\"name\":\"Normalise Fields\",\"type\":\"n8n-nodes-base.set\",\"position\":[1140,-140],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"1d2f091f-7740-47d1-9bf4-91cb620ffb1f\",\"name\":\"file_id\",\"type\":\"string\",\"value\":\"={{ $('File Ref').item.json.id }}\"},{\"id\":\"b7836ed5-7b14-436f-aa5b-be8a6c7f2957\",\"name\":\"file_name\",\"type\":\"string\",\"value\":\"={{ $('File Ref').item.json.name }}\"},{\"id\":\"b1d59c01-17d9-4d0b-b0f4-1593e47f968f\",\"name\":\"type\",\"type\":\"string\",\"value\":\"={{ $json.type }}\"},{\"id\":\"37f50a02-c780-49b3-ad8a-0d934566c770\",\"name\":\"user_id\",\"type\":\"string\",\"value\":\"={{ $json.id }}\"},{\"id\":\"e16c385f-2ad2-484b-99a4-9021f77b6875\",\"name\":\"user\",\"type\":\"string\",\"value\":\"={{ $json.emailAddress || 'n/a' }}\"},{\"id\":\"3c825d9e-494c-4500-b04d-d9577c0d5f44\",\"name\":\"role\",\"type\":\"string\",\"value\":\"={{ $json.role }}\"}]}},\"typeVersion\":3.4},{\"id\":\"74a7ca8b-3ad4-470e-8c4d-b2e3cb721c27\",\"name\":\"For Each File\",\"type\":\"n8n-nodes-base.splitInBatches\",\"position\":[440,-140],\"parameters\":{\"options\":{}},\"typeVersion\":3},{\"id\":\"da0e4e55-9ffa-4939-acf3-a743ade6b3eb\",\"name\":\"File Ref\",\"type\":\"n8n-nodes-base.noOp\",\"position\":[620,-140],\"parameters\":{},\"typeVersion\":1},{\"id\":\"26e0f66a-88d7-46df-94e5-127158c47191\",\"name\":\"Permissions To Items\",\"type\":\"n8n-nodes-base.splitOut\",\"position\":[780,-140],\"parameters\":{\"options\":{},\"fieldToSplitOut\":\"permissions\"},\"typeVersion\":1},{\"id\":\"5ed23aa6-1d9f-486c-ab56-4cb1144cdba9\",\"name\":\"Aggregate\",\"type\":\"n8n-nodes-base.aggregate\",\"position\":[1320,-60],\"parameters\":{\"options\":{},\"aggregate\":\"aggregateAllItemData\"},\"typeVersion\":1},{\"id\":\"b7308c98-b50a-42ee-80ae-5a4beea0a654\",\"name\":\"Flatten Rows\",\"type\":\"n8n-nodes-base.set\",\"position\":[1600,-280],\"parameters\":{\"options\":{},\"assignments\":{\"assignments\":[{\"id\":\"c23193c9-b348-493a-9a7b-fd737cfb656f\",\"name\":\"=rows\",\"type\":\"array\",\"value\":\"={{\\n$input.all().flatMap(item => item.json.data)\\n}}\"}]}},\"executeOnce\":true,\"typeVersion\":3.4},{\"id\":\"d18606d0-501e-4f2b-9456-a60497dd5574\",\"name\":\"Rows to Items\",\"type\":\"n8n-nodes-base.splitOut\",\"position\":[1800,-280],\"parameters\":{\"options\":{},\"fieldToSplitOut\":\"rows\"},\"typeVersion\":1},{\"id\":\"66daa856-b047-4396-8b64-29346bdb08a0\",\"name\":\"Send Email Report (Execute Once)\",\"type\":\"n8n-nodes-base.gmail\",\"position\":[2200,-280],\"webhookId\":\"39eabb13-1a20-412f-bf61-d3c40d875f76\",\"parameters\":{\"sendTo\":\"jim@example.com\",\"message\":\"=Hello,\\nHere is the current Google Drive Permissions Audit for {{ $now.format('yyyy-MM-dd') }}.\\n\\nSee the full report here - [Audit Gsheet](https://docs.google.com/spreadsheets/d/{{ $('Create New Sheet').first().json.spreadsheetId}}/edit?gid={{ $('Create New Sheet').first().json.sheetId}})\\n\\n## Shared with Anyone (Public Link)\\n{{\\n$input.all().map(item => item.json)\\n  .filter(row => row.type === 'anyone')\\n  .map(row => `* ${row.file_name} ([link](https://docs.google.com/spreadsheets/d/${row.file_id}/edit?usp=sharing))`)\\n  .join('\\\\n')\\n}}\\n\\n## Shared with External Users (By Invite)\\n{{\\n$input.all().map(item => item.json)\\n  .filter(row => row.type == 'user')\\n  .map(row => `* ${row.file_name} ([link](https://docs.google.com/spreadsheets/d/${row.file_id}/edit?usp=sharing))`)\\n  .join('\\\\n')\\n}}\\n\\nPlease review if permissions for these documents need to be updated.\\n\\nBest regards,\\nN8N Gdrive Permissions Audit Workflow\",\"options\":{\"appendAttribution\":true},\"subject\":\"=GDrive Audit for {{ $now.format('yyyy-MM-dd') }}\",\"emailType\":\"text\"},\"credentials\":{\"gmailOAuth2\":{\"id\":\"Sf5Gfl9NiFTNXFWb\",\"name\":\"Gmail account\"}},\"executeOnce\":true,\"typeVersion\":2.1},{\"id\":\"41c2e73e-17cf-4d31-99fe-9c8c3b3d1a97\",\"name\":\"Get Recently Active Documents\",\"type\":\"n8n-nodes-base.googleDrive\",\"position\":[-200,-220],\"parameters\":{\"filter\":{\"driveId\":{\"mode\":\"list\",\"value\":\"My Drive\"},\"fileTypes\":[\"application/vnd.google-apps.document\",\"application/vnd.google-apps.spreadsheet\",\"application/vnd.google-apps.presentation\"],\"whatToSearch\":\"all\"},\"options\":{\"fields\":[\"permissions\",\"shared\",\"name\",\"id\",\"kind\",\"mimeType\"]},\"resource\":\"fileFolder\",\"queryString\":\"=modifiedTime > '{{ $now.minus({ 'days': 1 })}}' and trashed = false\",\"searchMethod\":\"query\"},\"credentials\":{\"googleDriveOAuth2Api\":{\"id\":\"yOwz41gMQclOadgu\",\"name\":\"Google Drive account\"}},\"typeVersion\":3},{\"id\":\"68d83b74-be18-4b2e-8422-2fc9ec6a4b90\",\"name\":\"Sticky Note\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[-980,-500],\"parameters\":{\"color\":7,\"width\":600,\"height\":520,\"content\":\"## 1. Scheduled Trigger to Audit Everyday\\n[Read more about the Scheduled Trigger node](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.scheduletrigger)\\n\\nThe Scheduled Trigger is used to automate this workflow at a frequency which meets your data access auditing requirements. Here we've set it to run everyday and for each run a new Google Sheet is created to capture the results of the audit.\\n\\nCheck out the example Sheet here: https://docs.google.com/spreadsheets/d/1V2aiLhp3_nH7EBniMn7D0kFHg7-A5NjpDZXMhb4F5UI/edit?gid=503992967\"},\"typeVersion\":1},{\"id\":\"c5416a4f-4fae-405d-ac41-35193349d16f\",\"name\":\"Schedule Trigger\",\"type\":\"n8n-nodes-base.scheduleTrigger\",\"position\":[-860,-220],\"parameters\":{\"rule\":{\"interval\":[{\"triggerAtHour\":6}]}},\"typeVersion\":1.2},{\"id\":\"d3009d45-9a5d-445f-ad99-745f28b9f705\",\"name\":\"Sticky Note1\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[-360,-500],\"parameters\":{\"color\":7,\"width\":680,\"height\":520,\"content\":\"## 2. Identify Documents with Possible Access Control Risks\\n[Learn more about Gdrive node](https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.googledrive)\\n\\nFile Sharing is powerful in Google Drive but we may grant excess permissions or visibility out of habit or to overcome access challenges. Though sometimes justified, often we forget to go back and reduce the permission scopes once the access has served its purpose.\\n\\nThis workflow fetches recently modified documents and takes note of the current permissions assigned to them. Those which are set to allow for anyone with a link or shared with external users can be flagged for review.\"},\"typeVersion\":1},{\"id\":\"dff3abeb-7ae1-4038-8a05-75bf7630b63e\",\"name\":\"Sticky Note2\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[340,-320],\"parameters\":{\"color\":7,\"width\":1160,\"height\":500,\"content\":\"## 3. Aggregate Results into Rows\\n[Read more about the Split Out node](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.splitout)\\n\\nWith our list, we just need to convert them to rows which we can add to our audit sheet.\\nWe can use a few of n8n's data transformation nodes to complete this task.\"},\"typeVersion\":1},{\"id\":\"c88f5d67-9712-4f08-bd2f-7ea9056b8640\",\"name\":\"Sticky Note3\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[1520,-480],\"parameters\":{\"color\":7,\"width\":880,\"height\":460,\"content\":\"## 4. Logs Results and Send Audit Report via Email\\n[Read more about the Gmail node](https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.gmail/)\\n\\nFinally, we'll log the identified documents to our google sheet and send a report via email.\\nAlternatively, you may send to other security observability software or your security team.\"},\"typeVersion\":1},{\"id\":\"c9ef29d8-d126-4aff-96a9-26c79483bc16\",\"name\":\"Filter Out Owner of Document\",\"type\":\"n8n-nodes-base.filter\",\"position\":[960,-140],\"parameters\":{\"options\":{},\"conditions\":{\"options\":{\"version\":2,\"leftValue\":\"\",\"caseSensitive\":true,\"typeValidation\":\"strict\"},\"combinator\":\"and\",\"conditions\":[{\"id\":\"310d287a-cab3-4a94-8aa5-615a1fcb970a\",\"operator\":{\"type\":\"string\",\"operation\":\"notEquals\"},\"leftValue\":\"={{ $json.role }}\",\"rightValue\":\"owner\"}]}},\"typeVersion\":2.2,\"alwaysOutputData\":false},{\"id\":\"1185fbd0-7632-4ea9-8648-7fcba63d1565\",\"name\":\"Append to New Sheet\",\"type\":\"n8n-nodes-base.googleSheets\",\"position\":[2000,-280],\"parameters\":{\"columns\":{\"value\":{},\"schema\":[{\"id\":\"file_id\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"file_id\",\"defaultMatch\":false,\"canBeUsedToMatch\":true},{\"id\":\"file_name\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"file_name\",\"defaultMatch\":false,\"canBeUsedToMatch\":true},{\"id\":\"type\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"type\",\"defaultMatch\":false,\"canBeUsedToMatch\":true},{\"id\":\"user_id\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"user_id\",\"defaultMatch\":false,\"canBeUsedToMatch\":true},{\"id\":\"user\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"user\",\"defaultMatch\":false,\"canBeUsedToMatch\":true},{\"id\":\"role\",\"type\":\"string\",\"display\":true,\"removed\":false,\"required\":false,\"displayName\":\"role\",\"defaultMatch\":false,\"canBeUsedToMatch\":true}],\"mappingMode\":\"autoMapInputData\",\"matchingColumns\":[],\"attemptToConvertTypes\":false,\"convertFieldsToString\":false},\"options\":{},\"operation\":\"append\",\"sheetName\":{\"__rl\":true,\"mode\":\"id\",\"value\":\"={{ $('Create New Sheet').first().json.sheetId }}\"},\"documentId\":{\"__rl\":true,\"mode\":\"id\",\"value\":\"={{ $('Create New Sheet').first().json.spreadsheetId }}\"}},\"credentials\":{\"googleSheetsOAuth2Api\":{\"id\":\"XHvC7jIRR8A2TlUl\",\"name\":\"Google Sheets account\"}},\"typeVersion\":4.5},{\"id\":\"5755749e-16c1-43b0-ba14-76e593cd3404\",\"name\":\"Sticky Note4\",\"type\":\"n8n-nodes-base.stickyNote\",\"position\":[-1480,-1060],\"parameters\":{\"width\":440,\"height\":1260,\"content\":\"## Try It Out!\\n### This n8n template reviews and audits recently active Google Drive files and reports on files with excessively open permissions. This shows how you can automate simple SecOp tasks for access control management.\\n\\nFile Sharing Permissions are routinely abused when access needs and scopes expand to many colleagues, clients and users. Often, granting excessively open permissions means you can get back to work rather than deal with numerous access request notifications. Whilst sometimes justified, the problem is that the permissions are rarely reverted to a safer setting at a later date when it is no longer needed.\\n\\nThis template serves to improve your security posture by giving frequent reminders of these open files so that they can be actioned and not forgotten about.\\n\\nSee example Audit Report here: [https://docs.google.com/spreadsheets/d/1V2aiLhp3_nH7EBniMn7D0kFHg7-A5NjpDZXMhb4F5UI/edit?gid=503992967](https://docs.google.com/spreadsheets/d/1V2aiLhp3_nH7EBniMn7D0kFHg7-A5NjpDZXMhb4F5UI/edit?gid=503992967)\\n\\n### How it works\\n* A scheduled trigger runs everyday to generate a new audit report. A new sheet is created in a designated Google Sheets document to store the day's results.\\n* The Google Drive node is used with Advanced Search params to fetch recently modified files for the user with each file result containing the current permission settings.\\n* The results are filtered for those with publicly accessible \\\"anyone with link\\\" and sharing with external users via domain.\\n* The results are then manipulated into rows so that we can append them to the Sheet we created earlier.\\n* The audit Google Sheet is updated with the results and an audit report is sent to the user to action.\\n\\n### How to use\\n* Set the scheduled trigger to a more appropriate interval which works for you or your organisation.\\n* Consider using allowlists for organisations you frequently share with to reduce the number of false positives.\\n* The results can be forwarded to other security or analytical products as required.\\n\\n### Requirements\\n* Google Drive for Document Management\\n* Google Sheet for Reports and Data Collection\\n* Gmail to Email Reports\\n\\n### Customising the workflow\\n* Not using Google? Apply the same approach using Microsoft Sharepoint or Dropbox.\\n\\n\\n### Need Help?\\nJoin the [Discord](https://discord.com/invite/XPKeKXeB7d) or ask in the [Forum](https://community.n8n.io/)!\\n\\nHappy Hacking!\"},\"typeVersion\":1}],\"pinData\":{},\"connections\":{\"File Ref\":{\"main\":[[{\"node\":\"Permissions To Items\",\"type\":\"main\",\"index\":0}]]},\"Aggregate\":{\"main\":[[{\"node\":\"For Each File\",\"type\":\"main\",\"index\":0}]]},\"Flatten Rows\":{\"main\":[[{\"node\":\"Rows to Items\",\"type\":\"main\",\"index\":0}]]},\"For Each File\":{\"main\":[[{\"node\":\"Flatten Rows\",\"type\":\"main\",\"index\":0}],[{\"node\":\"File Ref\",\"type\":\"main\",\"index\":0}]]},\"Rows to Items\":{\"main\":[[{\"node\":\"Append to New Sheet\",\"type\":\"main\",\"index\":0}]]},\"Create New Sheet\":{\"main\":[[{\"node\":\"Get Recently Active Documents\",\"type\":\"main\",\"index\":0}]]},\"Normalise Fields\":{\"main\":[[{\"node\":\"Aggregate\",\"type\":\"main\",\"index\":0}]]},\"Schedule Trigger\":{\"main\":[[{\"node\":\"Create New Sheet\",\"type\":\"main\",\"index\":0}]]},\"Append to New Sheet\":{\"main\":[[{\"node\":\"Send Email Report (Execute Once)\",\"type\":\"main\",\"index\":0}]]},\"Permissions To Items\":{\"main\":[[{\"node\":\"Filter Out Owner of Document\",\"type\":\"main\",\"index\":0}]]},\"Filter Out Owner of Document\":{\"main\":[[{\"node\":\"Normalise Fields\",\"type\":\"main\",\"index\":0}]]},\"Get Recently Active Documents\":{\"main\":[[{\"node\":\"Has Shared with External Users\",\"type\":\"main\",\"index\":0}]]},\"Has Shared with External Users\":{\"main\":[[{\"node\":\"For Each File\",\"type\":\"main\",\"index\":0}]]}}}",
  "readme": "### This n8n template reviews and audits recently active Google Drive files and reports on files with excessively open permissions. This shows how you can automate simple compliance tasks for access control management.\n\nFile Sharing Permissions are routinely abused when access needs and scopes expand to many colleagues, clients and users. Often, granting excessively open permissions means you can get back to work rather than deal with numerous access request notifications. Whilst sometimes justified, the problem is that the permissions are rarely reverted to a safer setting at a later date when it is no longer needed.\n\nThis template serves to improve your security posture by giving frequent reminders of these open files so that they can be actioned and not forgotten about.\n\n**See example Audit Report here:** <https://docs.google.com/spreadsheets/d/1V2aiLhp3_nH7EBniMn7D0kFHg7-A5NjpDZXMhb4F5UI/edit?gid=503992967>\n\n### How it works\n\n  * A scheduled trigger runs everyday to generate a new audit report. A new sheet is created in a designated Google Sheets document to store the day's results.\n  * The Google Drive node is used with Advanced Search params to fetch recently modified files for the user with each file result containing the current permission settings.\n  * The results are filtered for those with publicly accessible \"anyone with link\" and sharing with external users via domain.\n  * The results are then manipulated into rows so that we can append them to the Sheet we created earlier.\n  * The audit Google Sheet is updated with the results and an audit report is sent to the user to action.\n\n\n\n### How to use\n\n  * Set the scheduled trigger to a more appropriate interval which works for you or your organisation.\n  * Consider using allowlists for organisations you frequently share with to reduce the number of false positives.\n  * The results can be forwarded to other security or analytical products as required.\n\n\n\n### Requirements\n\n  * Google Drive for Document Management\n  * Google Sheet for Reports and Data Collection\n  * Gmail to Email Reports\n\n\n\n### Customising the workflow\n\n  * Not using Google? Apply the same approach using Microsoft Sharepoint or Dropbox.\n  * If your security policies require it, you could automate fixing the file permissions as a proactive action instead and notify the user later.\n\n\n",
  "readme_html": "<!--[--><div data-v-006f9244=\"\"><h3>This n8n template reviews and audits recently active Google Drive files and reports on files with excessively open permissions. This shows how you can automate simple compliance tasks for access control management.</h3>\n<p>File Sharing Permissions are routinely abused when access needs and scopes expand to many colleagues, clients and users. Often, granting excessively open permissions means you can get back to work rather than deal with numerous access request notifications. Whilst sometimes justified, the problem is that the permissions are rarely reverted to a safer setting at a later date when it is no longer needed.</p>\n<p>This template serves to improve your security posture by giving frequent reminders of these open files so that they can be actioned and not forgotten about.</p>\n<p><strong>See example Audit Report here:</strong> <a href=\"https://docs.google.com/spreadsheets/d/1V2aiLhp3_nH7EBniMn7D0kFHg7-A5NjpDZXMhb4F5UI/edit?gid=503992967\" rel=\"ugc nofollow\" target=\"_blank\">https://docs.google.com/spreadsheets/d/1V2aiLhp3_nH7EBniMn7D0kFHg7-A5NjpDZXMhb4F5UI/edit?gid=503992967</a></p>\n<h3>How it works</h3>\n<ul>\n<li>A scheduled trigger runs everyday to generate a new audit report. A new sheet is created in a designated Google Sheets document to store the day's results.</li>\n<li>The Google Drive node is used with Advanced Search params to fetch recently modified files for the user with each file result containing the current permission settings.</li>\n<li>The results are filtered for those with publicly accessible \"anyone with link\" and sharing with external users via domain.</li>\n<li>The results are then manipulated into rows so that we can append them to the Sheet we created earlier.</li>\n<li>The audit Google Sheet is updated with the results and an audit report is sent to the user to action.</li>\n</ul>\n<h3>How to use</h3>\n<ul>\n<li>Set the scheduled trigger to a more appropriate interval which works for you or your organisation.</li>\n<li>Consider using allowlists for organisations you frequently share with to reduce the number of false positives.</li>\n<li>The results can be forwarded to other security or analytical products as required.</li>\n</ul>\n<h3>Requirements</h3>\n<ul>\n<li>Google Drive for Document Management</li>\n<li>Google Sheet for Reports and Data Collection</li>\n<li>Gmail to Email Reports</li>\n</ul>\n<h3>Customising the workflow</h3>\n<ul>\n<li>Not using Google? Apply the same approach using Microsoft Sharepoint or Dropbox.</li>\n<li>If your security policies require it, you could automate fixing the file permissions as a proactive action instead and notify the user later.</li>\n</ul>\n</div><!--]-->",
  "readme_zh": "### 该n8n模板可审查和审计近期活跃的Google Drive文件，并报告权限开放过度的文件。这展示了如何自动化执行访问控制管理中的简单合规任务。\n\n当文件访问需求和范围扩展到众多同事、客户和用户时，文件共享权限常被滥用。通常，授予过度开放的权限意味着您可以快速返回工作，而不必处理大量访问请求通知。虽然有时情有可原，但问题在于这些权限很少会在不再需要时恢复到更安全的设置。\n\n此模板旨在通过频繁提醒这些开放文件来改善您的安全状况，以便及时处理而不被遗忘。\n\n**查看示例审计报告：** <https://docs.google.com/spreadsheets/d/1V2aiLhp3_nH7EBniMn7D0kFHg7-A5NjpDZXMhb4F5UI/edit?gid=503992967>\n\n### 工作原理\n\n  * 计划触发器每天运行以生成新的审计报告。在指定的Google Sheets文档中创建新工作表以存储当天的结果。\n  * 使用Google Drive节点和高级搜索参数获取用户最近修改的文件，每个文件结果包含当前权限设置。\n  * 筛选出具有“任何拥有链接的人”公开访问权限以及通过域名与外部用户共享的文件。\n  * 然后将结果处理成行，以便将其附加到之前创建的工作表中。\n  * 使用结果更新审计Google Sheet，并向用户发送审计报告以采取行动。\n\n### 使用方法\n\n  * 将计划触发器设置为更适合您或您组织的间隔。\n  * 考虑为您经常共享的组织使用允许列表，以减少误报数量。\n  * 根据需要将结果转发到其他安全或分析产品。\n\n### 要求\n\n  * 用于文档管理的Google Drive\n  * 用于报告和数据收集的Google Sheet\n  * 用于邮件报告发送的Gmail\n\n### 自定义工作流\n\n  * 不使用Google？可对Microsoft Sharepoint或Dropbox应用相同方法。\n  * 如果您的安全策略要求，您可以自动化修复文件权限作为主动措施，稍后再通知用户。",
  "title_zh": "审核Google Drive文件权限以进行访问控制管理",
  "publish_date_zh": "上次更新于12天前",
  "workflow_json_zh": "{\"meta\": {\"instanceId\": \"408f9fb9940c3cb18ffdef0e0150fe342d6e655c3a9fac21f0f644e8bedabcd9\", \"templateCredsSetupCompleted\": true}, \"nodes\": [{\"id\": \"f8f5a571-c4de-469e-a182-faa60060d06b\", \"name\": \"已与外部用户共享\", \"type\": \"n8n-nodes-base.filter\", \"position\": [40, -220], \"parameters\": {\"options\": {}, \"conditions\": {\"options\": {\"version\": 2, \"leftValue\": \"\", \"caseSensitive\": true, \"typeValidation\": \"strict\"}, \"combinator\": \"or\", \"conditions\": [{\"id\": \"c72e9718-b50a-4c5f-8a26-7b3fda89e202\", \"operator\": {\"type\": \"boolean\", \"operation\": \"true\", \"singleValue\": true}, \"leftValue\": \"={{ $json.shared && $json.permissions.some(item => item.emailAddress ? !item.emailAddress.endsWith('example.com') : false)  }}\", \"rightValue\": \"\"}, {\"id\": \"0479b4ae-fc0c-49c4-8813-6978ea55265a\", \"operator\": {\"type\": \"object\", \"operation\": \"exists\", \"singleValue\": true}, \"leftValue\": \"={{ $json.permissions.find(item => item.type === 'anyone') }}\", \"rightValue\": \"\"}]}}, \"typeVersion\": 2.2}, {\"id\": \"14b6d453-0403-476a-8537-cdeeace70115\", \"name\": \"创建新工作表\", \"type\": \"n8n-nodes-base.googleSheets\", \"position\": [-620, -220], \"parameters\": {\"title\": \"审计-{{ $now.format('yyyyMMdd') }}\", \"options\": {}, \"operation\": \"创造\", \"documentId\": {\"__rl\": true, \"mode\": \"list\", \"value\": \"1V2aiLhp3_nH7EBniMn7D0kFHg7-A5NjpDZXMhb4F5UI\", \"cachedResultUrl\": \"https://docs.google.com/spreadsheets/d/1V2aiLhp3_nH7EBniMn7D0kFHg7-A5NjpDZXMhb4F5UI/edit?usp=drivesdk\", \"cachedResultName\": \"94. Gdrive Permissions Audit - Personal\"}}, \"credentials\": {\"googleSheetsOAuth2Api\": {\"id\": \"XHvC7jIRR8A2TlUl\", \"name\": \"Google Sheets account\"}}, \"typeVersion\": 4.5, \"alwaysOutputData\": true}, {\"id\": \"394b91b3-0c70-40d5-8d48-4df6109780e7\", \"name\": \"规范化字段\", \"type\": \"n8n-nodes-base.set\", \"position\": [1140, -140], \"parameters\": {\"options\": {}, \"assignments\": {\"assignments\": [{\"id\": \"1d2f091f-7740-47d1-9bf4-91cb620ffb1f\", \"name\": \"file_id\", \"type\": \"string\", \"value\": \"={{ $('File Ref').item.json.id }}\"}, {\"id\": \"b7836ed5-7b14-436f-aa5b-be8a6c7f2957\", \"name\": \"file_name\", \"type\": \"string\", \"value\": \"={{ $('File Ref').item.json.name }}\"}, {\"id\": \"b1d59c01-17d9-4d0b-b0f4-1593e47f968f\", \"name\": \"type\", \"type\": \"string\", \"value\": \"={{ $json.type }}\"}, {\"id\": \"37f50a02-c780-49b3-ad8a-0d934566c770\", \"name\": \"user_id\", \"type\": \"string\", \"value\": \"={{ $json.id }}\"}, {\"id\": \"e16c385f-2ad2-484b-99a4-9021f77b6875\", \"name\": \"user\", \"type\": \"string\", \"value\": \"={{ $json.emailAddress || 'n/a' }}\"}, {\"id\": \"3c825d9e-494c-4500-b04d-d9577c0d5f44\", \"name\": \"role\", \"type\": \"string\", \"value\": \"={{ $json.role }}\"}]}}, \"typeVersion\": 3.4}, {\"id\": \"74a7ca8b-3ad4-470e-8c4d-b2e3cb721c27\", \"name\": \"每个文件\", \"type\": \"n8n-nodes-base.splitInBatches\", \"position\": [440, -140], \"parameters\": {\"options\": {}}, \"typeVersion\": 3}, {\"id\": \"da0e4e55-9ffa-4939-acf3-a743ade6b3eb\", \"name\": \"文件编号\", \"type\": \"n8n-nodes-base.noOp\", \"position\": [620, -140], \"parameters\": {}, \"typeVersion\": 1}, {\"id\": \"26e0f66a-88d7-46df-94e5-127158c47191\", \"name\": \"项目权限\", \"type\": \"n8n-nodes-base.splitOut\", \"position\": [780, -140], \"parameters\": {\"options\": {}, \"fieldToSplitOut\": \"权限\"}, \"typeVersion\": 1}, {\"id\": \"5ed23aa6-1d9f-486c-ab56-4cb1144cdba9\", \"name\": \"总计\", \"type\": \"n8n-nodes-base.aggregate\", \"position\": [1320, -60], \"parameters\": {\"options\": {}, \"aggregate\": \"汇总所有项目数据\"}, \"typeVersion\": 1}, {\"id\": \"b7308c98-b50a-42ee-80ae-5a4beea0a654\", \"name\": \"扁平化行\", \"type\": \"n8n-nodes-base.set\", \"position\": [1600, -280], \"parameters\": {\"options\": {}, \"assignments\": {\"assignments\": [{\"id\": \"c23193c9-b348-493a-9a7b-fd737cfb656f\", \"name\": \"=rows\", \"type\": \"array\", \"value\": \"={{\\n$input.all().flatMap(item => item.json.data)\\n}}\"}]}}, \"executeOnce\": true, \"typeVersion\": 3.4}, {\"id\": \"d18606d0-501e-4f2b-9456-a60497dd5574\", \"name\": \"行转项\", \"type\": \"n8n-nodes-base.splitOut\", \"position\": [1800, -280], \"parameters\": {\"options\": {}, \"fieldToSplitOut\": \"眉毛\"}, \"typeVersion\": 1}, {\"id\": \"66daa856-b047-4396-8b64-29346bdb08a0\", \"name\": \"发送邮件报告（执行一次）\", \"type\": \"n8n-nodes-base.gmail\", \"position\": [2200, -280], \"webhookId\": \"39eabb13-1a20-412f-bf61-d3c40d875f76\", \"parameters\": {\"sendTo\": \"jim@example.com\", \"message\": \"=您好，  \\n以下是{{ $now.format('yyyy-MM-dd') }}的Google Drive权限审计报告。  \\n\\n查看完整报告请点击 - [审计表格](https://docs.google.com/spreadsheets/d/{{ $('Create New Sheet').first().json.spreadsheetId}}/edit?gid={{ $('Create New Sheet').first().json.sheetId}})  \\n\\n## 公开共享（通过公开链接）  \\n{{\\n$input.all().map(item => item.json)\\n  .filter(row => row.type === 'anyone')\\n  .map(row => `* ${row.file_name} ([链接](https://docs.google.com/spreadsheets/d/${row.file_id}/edit?usp=sharing))`)\\n  .join('\\\\n')\\n}}  \\n\\n## 与外部用户共享（通过邀请）  \\n{{\\n$input.all().map(item => item.json)\\n  .filter(row => row.type == 'user')\\n  .map(row => `* ${row.file_name} ([链接](https://docs.google.com/spreadsheets/d/${row.file_id}/edit?usp=sharing))`)\\n  .join('\\\\n')\\n}}  \\n\\n请检查这些文档的权限是否需要更新。  \\n\\n此致  \\nN8N Gdrive权限审计工作流\", \"options\": {\"appendAttribution\": true}, \"subject\": \"=GDrive审计报告 {{ $now.format('yyyy-MM-dd') }}\", \"emailType\": \"文本\"}, \"credentials\": {\"gmailOAuth2\": {\"id\": \"Sf5Gfl9NiFTNXFWb\", \"name\": \"Gmail account\"}}, \"executeOnce\": true, \"typeVersion\": 2.1}, {\"id\": \"41c2e73e-17cf-4d31-99fe-9c8c3b3d1a97\", \"name\": \"获取最近活动的文档\", \"type\": \"n8n-nodes-base.googleDrive\", \"position\": [-200, -220], \"parameters\": {\"filter\": {\"driveId\": {\"mode\": \"list\", \"value\": \"My Drive\"}, \"fileTypes\": [\"application/vnd.google-apps.document\", \"application/vnd.google-apps.spreadsheet\", \"application/vnd.google-apps.presentation\"], \"whatToSearch\": \"all\"}, \"options\": {\"fields\": [\"permissions\", \"shared\", \"name\", \"id\", \"kind\", \"mimeType\"]}, \"resource\": \"文件文件夹\", \"queryString\": \"=修改时间 > '{{ $now.减去({ '天': 1 })}}' 且 已删除 = 否\", \"searchMethod\": \"查询\"}, \"credentials\": {\"googleDriveOAuth2Api\": {\"id\": \"yOwz41gMQclOadgu\", \"name\": \"Google Drive account\"}}, \"typeVersion\": 3}, {\"id\": \"68d83b74-be18-4b2e-8422-2fc9ec6a4b90\", \"name\": \"便利贴\", \"type\": \"n8n-nodes-base.stickyNote\", \"position\": [-980, -500], \"parameters\": {\"color\": 7, \"width\": 600, \"height\": 520, \"content\": \"## 1. 定时触发器实现每日审计\\n[详细了解定时触发器节点](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.scheduletrigger)\\n\\n定时触发器用于按照符合您数据访问审计要求的频率自动执行此工作流。此处我们设置为每日运行，每次运行时都会新建一个Google表格来记录审计结果。\\n\\n查看示例表格：https://docs.google.com/spreadsheets/d/1V2aiLhp3_nH7EBniMn7D0kFHg7-A5NjpDZXMhb4F5UI/edit?gid=503992967\"}, \"typeVersion\": 1}, {\"id\": \"c5416a4f-4fae-405d-ac41-35193349d16f\", \"name\": \"计划触发器\", \"type\": \"n8n-nodes-base.scheduleTrigger\", \"position\": [-860, -220], \"parameters\": {\"rule\": {\"interval\": [{\"triggerAtHour\": 6}]}}, \"typeVersion\": 1.2}, {\"id\": \"d3009d45-9a5d-445f-ad99-745f28b9f705\", \"name\": \"便利贴1\", \"type\": \"n8n-nodes-base.stickyNote\", \"position\": [-360, -500], \"parameters\": {\"color\": 7, \"width\": 680, \"height\": 520, \"content\": \"## 2. 识别存在访问控制风险的文档\\n[了解更多Gdrive节点信息](https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.googledrive)\\n\\nGoogle Drive的文件共享功能非常强大，但我们可能会出于习惯或为了克服访问难题而授予过多权限或可见性。虽然有时这种做法是合理的，但往往在访问目的达成后，我们会忘记返回去缩小权限范围。\\n\\n该工作流会获取最近修改的文档，并记录当前分配给它们的权限。对于那些设置为允许任何拥有链接的人访问或与外部用户共享的文档，可以标记出来以供审查。\"}, \"typeVersion\": 1}, {\"id\": \"dff3abeb-7ae1-4038-8a05-75bf7630b63e\", \"name\": \"便利贴2\", \"type\": \"n8n-nodes-base.stickyNote\", \"position\": [340, -320], \"parameters\": {\"color\": 7, \"width\": 1160, \"height\": 500, \"content\": \"## 3. 将结果汇总成行\\n[详细了解拆分节点](https://docs.n8n.io/integrations/builtin/core-nodes/n8n-nodes-base.splitout)\\n\\n有了清单后，我们只需将其转换为可添加到审计工作表中的行。\\n我们可以使用n8n的几个数据转换节点来完成此任务。\"}, \"typeVersion\": 1}, {\"id\": \"c88f5d67-9712-4f08-bd2f-7ea9056b8640\", \"name\": \"便利贴3\", \"type\": \"n8n-nodes-base.stickyNote\", \"position\": [1520, -480], \"parameters\": {\"color\": 7, \"width\": 880, \"height\": 460, \"content\": \"## 4. 记录日志并通过电子邮件发送审计报告\\n[了解更多关于Gmail节点的信息](https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.gmail/)\\n\\n最后，我们将把识别出的文档记录到Google表格中，并通过电子邮件发送报告。\\n您也可以选择将报告发送至其他安全监测软件或您的安全团队。\"}, \"typeVersion\": 1}, {\"id\": \"c9ef29d8-d126-4aff-96a9-26c79483bc16\", \"name\": \"过滤掉文档所有者\", \"type\": \"n8n-nodes-base.filter\", \"position\": [960, -140], \"parameters\": {\"options\": {}, \"conditions\": {\"options\": {\"version\": 2, \"leftValue\": \"\", \"caseSensitive\": true, \"typeValidation\": \"strict\"}, \"combinator\": \"and\", \"conditions\": [{\"id\": \"310d287a-cab3-4a94-8aa5-615a1fcb970a\", \"operator\": {\"type\": \"string\", \"operation\": \"notEquals\"}, \"leftValue\": \"={{ $json.role }}\", \"rightValue\": \"owner\"}]}}, \"typeVersion\": 2.2, \"alwaysOutputData\": false}, {\"id\": \"1185fbd0-7632-4ea9-8648-7fcba63d1565\", \"name\": \"附加到新工作表\", \"type\": \"n8n-nodes-base.googleSheets\", \"position\": [2000, -280], \"parameters\": {\"columns\": {\"value\": {}, \"schema\": [{\"id\": \"file_id\", \"type\": \"string\", \"display\": true, \"removed\": false, \"required\": false, \"displayName\": \"file_id\", \"defaultMatch\": false, \"canBeUsedToMatch\": true}, {\"id\": \"file_name\", \"type\": \"string\", \"display\": true, \"removed\": false, \"required\": false, \"displayName\": \"file_name\", \"defaultMatch\": false, \"canBeUsedToMatch\": true}, {\"id\": \"type\", \"type\": \"string\", \"display\": true, \"removed\": false, \"required\": false, \"displayName\": \"type\", \"defaultMatch\": false, \"canBeUsedToMatch\": true}, {\"id\": \"user_id\", \"type\": \"string\", \"display\": true, \"removed\": false, \"required\": false, \"displayName\": \"user_id\", \"defaultMatch\": false, \"canBeUsedToMatch\": true}, {\"id\": \"user\", \"type\": \"string\", \"display\": true, \"removed\": false, \"required\": false, \"displayName\": \"user\", \"defaultMatch\": false, \"canBeUsedToMatch\": true}, {\"id\": \"role\", \"type\": \"string\", \"display\": true, \"removed\": false, \"required\": false, \"displayName\": \"role\", \"defaultMatch\": false, \"canBeUsedToMatch\": true}], \"mappingMode\": \"autoMapInputData\", \"matchingColumns\": [], \"attemptToConvertTypes\": false, \"convertFieldsToString\": false}, \"options\": {}, \"operation\": \"附加\", \"sheetName\": {\"__rl\": true, \"mode\": \"id\", \"value\": \"={{ $('Create New Sheet').first().json.sheetId }}\"}, \"documentId\": {\"__rl\": true, \"mode\": \"id\", \"value\": \"={{ $('Create New Sheet').first().json.spreadsheetId }}\"}}, \"credentials\": {\"googleSheetsOAuth2Api\": {\"id\": \"XHvC7jIRR8A2TlUl\", \"name\": \"Google Sheets account\"}}, \"typeVersion\": 4.5}, {\"id\": \"5755749e-16c1-43b0-ba14-76e593cd3404\", \"name\": \"便利贴4\", \"type\": \"n8n-nodes-base.stickyNote\", \"position\": [-1480, -1060], \"parameters\": {\"width\": 440, \"height\": 1260, \"content\": \"## 试试看吧！\\n### 本n8n模板可审查和审计近期活跃的Google Drive文件，并报告权限开放过度的文件。此模板展示了如何通过自动化实现访问控制管理中的简单安全运维任务。\\n\\n当文件访问需求和范围扩展到众多同事、客户和用户时，共享权限常被滥用。授予过度开放的权限往往能让人们快速回归工作，而无需处理大量访问请求通知。虽然有时情有可原，但问题在于当这些权限不再需要时，很少会被及时调整为更安全的设置。\\n\\n该模板通过定期提醒这些开放文件来提升安全防护，确保它们能被及时处理而非遗忘。\\n\\n查看审计报告示例：[https://docs.google.com/spreadsheets/d/1V2aiLhp3_nH7EBniMn7D0kFHg7-A5NjpDZXMhb4F5UI/edit?gid=503992967](https://docs.google.com/spreadsheets/d/1V2aiLhp3_nH7EBniMn7D0kFHg7-A5NjpDZXMhb4F5UI/edit?gid=503992967)\\n\\n### 工作原理\\n* 定时触发器每天运行生成审计报告，在指定Google Sheets文档中创建新工作表存储当日结果\\n* 通过Google Drive节点的高级搜索参数获取用户近期修改的文件，每个结果包含当前权限设置\\n* 筛选出\\\"链接共享\\\"的公开可访问文件及通过域名与外部用户共享的文件\\n* 将结果处理成行数据，追加至预先创建的工作表中\\n* 更新审计表格并发送待处理报告给用户\\n\\n### 使用指南\\n* 根据个人或组织需求调整定时触发器的运行频率\\n* 为常需共享的组织设置白名单以减少误报\\n* 审计结果可按需转发至其他安全或分析平台\\n\\n### 环境要求\\n* 使用Google Drive进行文档管理\\n* 使用Google Sheets生成报告和收集数据\\n* 使用Gmail发送报告邮件\\n\\n### 自定义工作流\\n* 非Google用户？可对Microsoft Sharepoint或Dropbox采用相同方案\\n\\n### 需要帮助？\\n加入[Discord](https://discord.com/invite/XPKeKXeB7d)或访问[论坛](https://community.n8n.io/)提问！\\n\\n祝您探索愉快！\"}, \"typeVersion\": 1}], \"pinData\": {}, \"connections\": {\"File Ref\": {\"main\": [[{\"node\": \"Permissions To Items\", \"type\": \"main\", \"index\": 0}]]}, \"Aggregate\": {\"main\": [[{\"node\": \"For Each File\", \"type\": \"main\", \"index\": 0}]]}, \"Flatten Rows\": {\"main\": [[{\"node\": \"Rows to Items\", \"type\": \"main\", \"index\": 0}]]}, \"For Each File\": {\"main\": [[{\"node\": \"Flatten Rows\", \"type\": \"main\", \"index\": 0}], [{\"node\": \"File Ref\", \"type\": \"main\", \"index\": 0}]]}, \"Rows to Items\": {\"main\": [[{\"node\": \"Append to New Sheet\", \"type\": \"main\", \"index\": 0}]]}, \"Create New Sheet\": {\"main\": [[{\"node\": \"Get Recently Active Documents\", \"type\": \"main\", \"index\": 0}]]}, \"Normalise Fields\": {\"main\": [[{\"node\": \"Aggregate\", \"type\": \"main\", \"index\": 0}]]}, \"Schedule Trigger\": {\"main\": [[{\"node\": \"Create New Sheet\", \"type\": \"main\", \"index\": 0}]]}, \"Append to New Sheet\": {\"main\": [[{\"node\": \"Send Email Report (Execute Once)\", \"type\": \"main\", \"index\": 0}]]}, \"Permissions To Items\": {\"main\": [[{\"node\": \"Filter Out Owner of Document\", \"type\": \"main\", \"index\": 0}]]}, \"Filter Out Owner of Document\": {\"main\": [[{\"node\": \"Normalise Fields\", \"type\": \"main\", \"index\": 0}]]}, \"Get Recently Active Documents\": {\"main\": [[{\"node\": \"Has Shared with External Users\", \"type\": \"main\", \"index\": 0}]]}, \"Has Shared with External Users\": {\"main\": [[{\"node\": \"For Each File\", \"type\": \"main\", \"index\": 0}]]}}}"
}